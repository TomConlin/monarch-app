if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.core=="undefined"){bbop.core={}}bbop.core.crop=function(str,lim,suff){var ret=str;var limit=10;if(lim){limit=lim}var suffix="";if(suff){suffix=suff}if(str.length>limit){ret=str.substring(0,(limit-suffix.length))+suffix}return ret};bbop.core.fold=function(default_hash,arg_hash){if(!default_hash){default_hash={}}if(!arg_hash){arg_hash={}}var ret_hash={};for(var key in default_hash){if(bbop.core.is_defined(arg_hash[key])){ret_hash[key]=arg_hash[key]}else{ret_hash[key]=default_hash[key]}}return ret_hash};bbop.core.merge=function(older_hash,newer_hash){if(!older_hash){older_hash={}}if(!newer_hash){newer_hash={}}var ret_hash={};function _add(key,val){ret_hash[key]=val}bbop.core.each(older_hash,_add);bbop.core.each(newer_hash,_add);return ret_hash};bbop.core.get_keys=function(arg_hash){if(!arg_hash){arg_hash={}}var out_keys=[];for(var out_key in arg_hash){if(arg_hash.hasOwnProperty(out_key)){out_keys.push(out_key)}}return out_keys};bbop.core.hashify=function(list){var rethash={};if(list&&list[0]){if(bbop.core.is_array(list[0])){bbop.core.each(list,function(item){var key=item[0];var val=item[1];if(bbop.core.is_defined(key)){rethash[key]=val}})}else{bbop.core.each(list,function(item){rethash[item]=true})}}return rethash};bbop.core.is_same=function(thing1,thing2){var retval=false;if(bbop.core.is_hash(thing1)&&bbop.core.is_hash(thing2)){var same_p=true;for(var k1 in thing1){if(typeof thing2[k1]==="undefined"||thing1[k1]!==thing2[k1]){same_p=false;break}}if(same_p){for(var k2 in thing2){if(typeof thing1[k2]==="undefined"||thing2[k2]!==thing1[k2]){same_p=false;break}}}retval=same_p}else{if(bbop.core.is_array(thing1)&&bbop.core.is_array(thing2)){retval=bbop.core.is_same(bbop.core.hashify(thing1),bbop.core.hashify(thing2))}else{var t1_is=bbop.core.what_is(thing1);var t2_is=bbop.core.what_is(thing2);if(t1_is==t2_is){if(t1_is=="null"||t1_is=="boolean"||t1_is=="null"||t1_is=="number"||t1_is=="string"){if(thing1==thing2){retval=true}}}}}return retval};bbop.core.what_is=function(in_thing){var retval=null;if(typeof(in_thing)!="undefined"){if(in_thing==null){retval="null"}else{if(typeof(in_thing)=="object"){if(typeof(in_thing._is_a)!="undefined"){retval=in_thing._is_a}else{if(bbop.core.is_array(in_thing)){retval="array"}else{retval="object"}}}else{retval=typeof(in_thing)}}}return retval};bbop.core.is_array=function(in_thing){var retval=false;if(in_thing&&Array.isArray(in_thing)){retval=true}return retval};bbop.core.is_hash=function(in_thing){var retval=false;if(in_thing&&typeof(in_thing)=="object"&&(!bbop.core.is_array(in_thing))){retval=true}return retval};bbop.core.is_empty=function(in_thing){var retval=false;if(bbop.core.is_array(in_thing)){if(in_thing.length==0){retval=true}}else{if(bbop.core.is_hash(in_thing)){var in_hash_keys=bbop.core.get_keys(in_thing);if(in_hash_keys.length==0){retval=true}}else{retval=false}}return retval};bbop.core.is_defined=function(in_thing){var retval=true;if(typeof(in_thing)==="undefined"){retval=false}return retval};bbop.core.each=function(in_thing,in_function){if(typeof(in_thing)=="undefined"){}else{if(typeof(in_thing)!="object"){throw new Error("Unsupported type in bbop.core.each: "+typeof(in_thing))}else{if(bbop.core.is_hash(in_thing)){var hkeys=bbop.core.get_keys(in_thing);for(var ihk=0;ihk<hkeys.length;ihk++){var ikey=hkeys[ihk];var ival=in_thing[ikey];in_function(ikey,ival)}}else{for(var iai=0;iai<in_thing.length;iai++){in_function(in_thing[iai],iai)}}}}};bbop.core.pare=function(in_thing,filter_function,sort_function){var ret=[];if(typeof(in_thing)==="undefined"){}else{if(typeof(in_thing)!="object"){throw new Error("Unsupported type in bbop.core.pare: "+typeof(in_thing))}else{if(bbop.core.is_hash(in_thing)){if(filter_function){bbop.core.each(in_thing,function(key,val){if(filter_function(key,val)){}else{ret.push(val)}})}else{bbop.core.each(in_thing,function(key,val){ret.push(val)})}}else{if(filter_function){bbop.core.each(in_thing,function(item,index){if(filter_function(item,index)){}else{ret.push(item)}})}else{bbop.core.each(in_thing,function(item,index){ret.push(item)})}}}}if(ret.length>0&&sort_function){ret.sort(sort_function)}return ret};bbop.core.clone=function(thing){var clone=null;if(typeof(thing)==="undefined"){}else{if(typeof(thing)==="function"){clone=thing}else{if(typeof(thing)==="boolean"||typeof(thing)==="number"||typeof(thing)==="string"){clone=thing}else{if(typeof(thing)==="object"){if(thing==null){clone=null}else{if(Array.isArray(thing)){clone=[];for(var i=0;i<thing.length;i++){clone[i]=bbop.core.clone(thing[i])}}else{clone={};for(var h in thing){clone[h]=bbop.core.clone(thing[h])}}}}else{}}}}return clone};bbop.core.to_string=function(in_thing){if(in_thing&&typeof(in_thing.to_string)!=="undefined"&&typeof(in_thing.to_string)=="function"){return in_thing.to_string()}else{var what=bbop.core.what_is(in_thing);if(what=="number"){return in_thing.toString()}else{if(what=="string"){return in_thing}else{if(what=="array"){return bbop.core.dump(in_thing)}else{return in_thing}}}}};bbop.core.dump=function(thing){var retval="";var what=bbop.core.what_is(thing);if(what==null){retval="null"}else{if(what=="null"){retval="null"}else{if(what=="string"){retval='"'+thing+'"'}else{if(what=="boolean"){if(thing){retval="true"}else{retval="false"}}else{if(what=="array"){var astack=[];bbop.core.each(thing,function(item,i){astack.push(bbop.core.dump(item))});retval="["+astack.join(", ")+"]"}else{if(what=="object"){var hstack=[];bbop.core.each(thing,function(key,val){hstack.push('"'+key+'": '+bbop.core.dump(val))});retval="{"+hstack.join(", ")+"}"}else{retval=thing}}}}}}return retval};bbop.core.has_interface=function(iobj,interface_list){var retval=true;bbop.core.each(interface_list,function(iface){if(typeof(iobj[iface])=="undefined"&&typeof(iobj.prototype[iface])=="undefined"){retval=false;throw new Error(bbop.core.what_is(iobj)+" breaks interface "+iface)}});return retval};bbop.core.get_assemble=function(qargs){var mbuff=[];for(var qname in qargs){var qval=qargs[qname];if(qval!=null){if(typeof qval=="string"||typeof qval=="number"){var nano_buffer=[];nano_buffer.push(qname);nano_buffer.push("=");nano_buffer.push(qval);mbuff.push(nano_buffer.join(""))}else{if(typeof qval=="object"){if(typeof qval.length!="undefined"){for(var qval_i=0;qval_i<qval.length;qval_i++){var nano_buff=[];nano_buff.push(qname);nano_buff.push("=");nano_buff.push(qval[qval_i]);mbuff.push(nano_buff.join(""))}}else{for(var sub_name in qval){var sub_vals=qval[sub_name];if(bbop.core.what_is(sub_vals)!="array"){sub_vals=[sub_vals]}var loop=bbop.core.each;loop(sub_vals,function(sub_val){var nano_buff=[];nano_buff.push(qname);nano_buff.push("=");nano_buff.push(sub_name);nano_buff.push(":");if(typeof sub_val!=="undefined"&&sub_val){var val_is_a=bbop.core.what_is(sub_val);if(val_is_a=="string"&&sub_val.charAt(0)=='"'&&sub_val.charAt(sub_val.length-1)=='"'){nano_buff.push(sub_val)}else{if(val_is_a=="string"&&sub_val.charAt(0)=="("&&sub_val.charAt(sub_val.length-1)==")"){nano_buff.push(sub_val)}else{nano_buff.push('"'+sub_val+'"')}}}else{nano_buff.push('""')}mbuff.push(nano_buff.join(""))})}}}else{if(typeof qval=="undefined"){}else{throw new Error("bbop.core.get_assemble: unknown type: "+typeof(qval))}}}}}return mbuff.join("&")};bbop.core.randomness=function(len){var random_base=["1","2","3","4","5","6","7","8","9","0","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"];var length=len||10;var cache=new Array();for(var ii=0;ii<length;ii++){var rbase_index=Math.floor(Math.random()*random_base.length);cache.push(random_base[rbase_index])}return cache.join("")};bbop.core.first_split=function(character,string){var retlist=null;var eq_loc=string.indexOf(character);if(eq_loc==0){retlist=["",string.substr(eq_loc+1,string.length)]}else{if(eq_loc>0){var before=string.substr(0,eq_loc);var after=string.substr(eq_loc+1,string.length);retlist=[before,after]}else{retlist=["",""]}}return retlist};bbop.core.url_parameters=function(url){var retlist=[];var tmp=url.split("?");var path="";var parms=[];if(!tmp[1]){parms=tmp[0].split("&")}else{path=tmp[0];parms=tmp[1].split("&")}bbop.core.each(parms,function(p){var c=bbop.core.first_split("=",p);if(!c[0]&&!c[1]){retlist.push([p])}else{retlist.push(c)}});return retlist};bbop.core.resourcify=function(base,resource,extension){var retval=base+"/"+resource;if(extension){retval+="."+extension}return retval.replace(" ","_","g").toLowerCase()};bbop.core.uuid=function(){function replacer(c){var r=Math.random()*16|0,v=c=="x"?r:(r&3|8);return v.toString(16)}var target_str="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx";return target_str.replace(/[xy]/g,replacer)};bbop.core.numeric_sort_ascending=function(a,b){return a-b};bbop.core.numeric_sort_descending=function(a,b){return b-a};bbop.core.dequote=function(str){var retstr=str;if(bbop.core.is_defined(str)&&str.length>2){var end=str.length-1;if(str.charAt(0)=='"'&&str.charAt(end)=='"'){retstr=str.substr(1,end-1)}}return retstr};bbop.core.ensure=function(str,add,place){var do_front=false;var do_back=false;if(!bbop.core.is_defined(place)){do_front=true;do_back=true}else{if(place=="front"){do_front=true}else{if(place=="back"){do_back=true}else{}}}var strlen=str.length;var addlen=add.length;var front_substr=str.substr(0,addlen);var back_substr=str.substr((strlen-addlen),(strlen-1));var front_add="";if(do_front&&front_substr!=add){front_add=add}var back_add="";if(do_back&&back_substr!=add){back_add=add}return front_add+str+back_add};bbop.core.chomp=function(str){var retstr="";retstr=str.replace(/^\s+/,"");retstr=retstr.replace(/\s+$/,"");return retstr};bbop.core.splode=function(str,delimiter){var retlist=null;if(bbop.core.is_defined(str)){if(!bbop.core.is_defined(delimiter)){delimiter=/\s+/}retlist=str.split(delimiter)}return retlist};bbop.core.extend=function(subclass,baseclass){function tmp_object(){}tmp_object.prototype=baseclass.prototype;subclass.prototype=new tmp_object;subclass.prototype.constructor=subclass};if(typeof bbop=="undefined"){var bbop={}}bbop.test=function(){var barker=function(thing){};if(typeof(console)!=="undefined"&&typeof(console.log)==="function"){barker=console.log}else{if(typeof(print)==="function"){barker=print}}function bark(thing){barker(thing)}var test_number=1;var tests_passed=0;var tests_failed=0;function _incr_tests(){test_number=test_number+1}function _incr_passed(){tests_passed=tests_passed+1}function _incr_failed(){tests_failed=tests_failed+1}function _incr_failed(){tests_failed=tests_failed+1}function _complete(bool,msg){if(bool){if(msg){bark("Test "+test_number+" passed: "+msg+".")}else{bark("Test "+test_number+" passed.")}_incr_passed()}else{if(msg){bark("FAIL: Test "+test_number+" failed: "+msg+".")}else{bark("FAIL: Test "+test_number+" failed.")}_incr_failed()}test_number++}this.report=function(){if(tests_passed+1==test_number){bark("* All tests passed.")}else{bark("* Tests passed: "+tests_passed);bark("* Tests failed: "+tests_failed)}};function _same_array(one,two){var retval=true;if(one.length!=two.length){retval=false}else{for(var i=0;i<one.length;i++){if(one[i]!=two[i]){retval=false;break}}}return retval}function _same_set(set1,set2){var h1={};var h2={};for(var h1i=0;h1i<set1.length;h1i++){h1[set1[h1i]]=1}for(var h2i=0;h2i<set2.length;h2i++){h2[set2[h2i]]=1}return _same_hash(h1,h2)}function _same_hash(hash1,hash2){var same_p=true;for(var k1 in hash1){if(typeof hash2[k1]==="undefined"||hash1[k1]!==hash2[k1]){same_p=false;break}}if(same_p){for(var k2 in hash2){if(typeof hash1[k2]==="undefined"||hash2[k2]!==hash1[k2]){same_p=false;break}}}return same_p}function _is_same(a,b){var ret=false;if(a==b){ret=true}else{if(typeof(a)==="object"&&typeof(b)==="object"){if(a==null||b==null){ret=false}else{if(Array.isArray(a)&&Array.isArray(b)){if(a.length==b.length){if(a.length==0){ret=true}else{ret=true;for(var i=0;i<a.length;i++){if(!_is_same(a[i],b[i])){ret=false;break}}}}}else{var a_keys=Object.keys(a);var b_keys=Object.keys(b);var keys=a_keys.concat(b_keys.filter(function(it){return a_keys.indexOf(it)<0}));ret=true;for(var j=0;j<keys.length;j++){var k=keys[j];if(!_is_same(a[k],b[k])){ret=false;break}}}}}else{}}return ret}function _link_comp(str1,str2){var tmp1=str1.split("?");var head1="";var args1=[];if(!tmp1[1]){args1=tmp1[0].split("&")}else{head1=tmp1[0];args1=tmp1[1].split("&")}var sorted_args1=args1.sort();var tmp2=str2.split("?");var head2="";var args2=[];if(!tmp2[1]){args2=tmp2[0].split("&")}else{head2=tmp2[0];args2=tmp2[1].split("&")}var sorted_args2=args2.sort();var retval=false;if(head1==head2&&_same_array(sorted_args1,sorted_args2)){retval=true}return retval}function _in_list(in_item,list,comparator){var retval=false;for(var li=0;li<list.length;li++){var list_item=list[li];if(comparator){var comp_op=comparator(in_item,list_item);if(comp_op&&comp_op==true){retval=true}}else{if(in_item==list_item){retval=true}}}return retval}function _is_string_embedded(target_str,base_str,add_str){var retval=false;for(var si=0;si<=base_str.length;si++){var car=base_str.substr(0,si);var cdr=base_str.substr(si,base_str.length);if(car+add_str+cdr==target_str){retval=true;break}}return retval}function _is_simple_same(question,answer,msg){_complete(question==answer,msg)}this.is_same_atom=_is_simple_same;this.is_different_atom=function(question,answer,msg){_complete(question!=answer,msg)};this.is_defined=function(thing,msg){if(thing){_complete(true,msg)}else{_complete(false,msg)}};this.is_not_defined=function(thing,msg){if(thing){_complete(false,msg)}else{_complete(true,msg)}};this.is_true=function(bool,msg){if(bool==true){_complete(true,msg)}else{_complete(false,msg)}};this.is_false=function(bool,msg){if(bool==false){_complete(true,msg)}else{_complete(false,msg)}};this.is_x_greater_than_y=function(x_thing,y_thing,msg){if(x_thing>y_thing){_complete(true,msg)}else{_complete(false,msg)}};this.is_same_url=function(link1,link2,msg){_complete(_link_comp(link1,link2),msg)};this.is_different_url=function(link1,link2,msg){_complete(!_link_comp(link1,link2),msg)};this.is_same_set=function(set1,set2,msg){_complete(_same_set(set1,set2),msg)};this.is_different_set=function(set1,set2,msg){_complete(!_same_set(set1,set2),msg)};this.is_same_hash=function(hash1,hash2,msg){_complete(_same_hash(hash1,hash2),msg)};this.is_different_hash=function(hash1,hash2,msg){_complete(!_same_hash(hash1,hash2),msg)};this.is_same_thing=function(thing1,thing2,msg){_complete(_is_same(thing1,thing2),msg)};this.is_different_thing=function(thing1,thing2,msg){_complete(!_is_same(thing1,thing2),msg)};this.is_in_list=function(item,list,msg){_complete(_in_list(item,list),msg)};this.is_not_in_list=function(item,list,msg){_complete(!_in_list(item,list),msg)};this.is_in_list_diy=function(item,list,comp,msg){_complete(_in_list(item,list,comp),msg)};this.is_not_in_list_diy=function(item,list,comp,msg){_complete(!_in_list(item,list,comp),msg)};this.is_string_embedded=function(target_str,base_str,added_str,msg){_complete(_is_string_embedded(target_str,base_str,added_str),msg)};this.is_string_not_embedded=function(target_str,base_str,added_str,msg){_complete(!_is_string_embedded(target_str,base_str,added_str),msg)};this.pass=function(msg){_complete(true,msg)};this.fail=function(msg){_complete(false,msg)}};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.version=="undefined"){bbop.version={}}bbop.version.revision="2.3.2";bbop.version.release="20150601";if(typeof bbop=="undefined"){var bbop={}}bbop.logger=function(initial_context){this.DEBUG=false;var anchor=this;this._context=[];if(initial_context){this._context=[initial_context]}this.reset_context=function(new_initial_context){if(new_initial_context){this._context=[new_initial_context]}else{this._context=[]}};this.push_context=function(new_context){this._context.push(new_context)};this.pop_context=function(){var popped_context=null;if(this._context.length>0){popped_context=this._context.pop()}return popped_context};this._console_sayer=function(){};if(typeof(jQuery)!="undefined"&&jQuery("#bbop-logger-console-html")!="undefined"&&jQuery("#bbop-logger-console-html").length){this._console_sayer=function(msg){var area=jQuery("#bbop-logger-console-html");area.append(msg+"<br />");try{area.scrollTop(area[0].scrollHeight)}catch(x){}}}else{if(typeof(console)!="undefined"&&typeof(console.log)=="function"){this._console_sayer=function(msg){console.log(msg)}}else{if(typeof(opera)!="undefined"&&typeof(opera.postError)=="function"){this._console_sayer=function(msg){opera.postError(msg+"\n")}}else{if(typeof(window)!="undefined"&&typeof(window.dump)=="function"){this._console_sayer=function(msg){dump(msg+"\n")}}else{if(typeof(window)!="undefined"&&typeof(window.console)!="undefined"&&typeof(window.console.log)=="function"){this._console_sayer=function(msg){window.console.log(msg+"\n")}}else{if(typeof(build)=="function"&&typeof(getpda)=="function"&&typeof(pc2line)=="function"&&typeof(print)=="function"){this._console_sayer=function(msg){print(msg)}}else{if(typeof(org)!="undefined"&&typeof(org.rhino)!="undefined"&&typeof(print)=="function"){this._console_sayer=function(msg){print(msg)}}}}}}}}this.kvetch=function(string){var ret_str=null;if(anchor.DEBUG==true){if(typeof(string)=="undefined"){string=""}if(anchor._context.length>0){var cstr=anchor._context.join(":");string=cstr+": "+string}anchor._console_sayer(string);ret_str=string}return ret_str}};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.json=="undefined"){bbop.json={}}(function(){var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){if(typeof rep[i]==="string"){k=rep[i];v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}bbop.json.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("bbop.json.stringify")}return str("",{"":value})};bbop.json.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("bbop.json.parse: "+text)}}());if(typeof bbop=="undefined"){var bbop={}}bbop.template=function(template_string){this.is_a="bbop.template";var anchor=this;anchor._template_string=template_string;var split_re=/\{\{[A-Za-z0-9_-]+\}\}/;anchor._template_split_strings=template_string.split(split_re);var var_id_re=/\{\{[A-Za-z0-9_-]+\}\}/g;anchor._var_id_matches=template_string.match(var_id_re);bbop.core.each(anchor._var_id_matches,function(item,index){var new_item=item.substring(2,item.length-2);anchor._var_id_matches[index]=new_item});this.fill=function(fill_hash){var ret_str="";bbop.core.each(anchor._template_split_strings,function(str,index){ret_str+=str;if(index<anchor._var_id_matches.length){var use_str="";var varname=anchor._var_id_matches[index];if(varname&&bbop.core.is_defined(fill_hash[varname])){use_str=fill_hash[varname]}ret_str+=use_str}});return ret_str};this.variables=function(){return bbop.core.hashify(anchor._var_id_matches)}};if(typeof bbop=="undefined"){var bbop={}}bbop.context=function(entities,default_color){if(!default_color){default_color="#808080"}var entity_aliases={};bbop.core.each(entities,function(ekey,eobj){entity_aliases[ekey]=ekey;bbop.core.each(eobj.aliases,function(alias){entity_aliases[alias]=ekey})});this._dealias_data=function(id){var ret=null;if(id){if(entity_aliases[id]){var tru_id=entity_aliases[id];ret=entities[tru_id]}}return ret};this.readable=function(ind){var ret=ind;var data=this._dealias_data(ind);if(data&&data.readable){ret=data.readable}return ret};this.color=function(ind){var ret=default_color;var data=this._dealias_data(ind);if(data&&data.color){ret=data.color}return ret};this.glyph=function(ind){var ret=null;var data=this._dealias_data(ind);if(data&&data.glyph){ret=data.glyph}return ret};this.priority=function(ind){var ret=0;var data=this._dealias_data(ind);if(data&&data.priority){ret=data.priority}return ret};this.all_entities=function(){var rls=bbop.core.get_keys(entities);return rls};this.all_known=function(){var rls=bbop.core.get_keys(entity_aliases);return rls}};if(typeof bbop=="undefined"){var bbop={}}bbop.logic=function(default_conjunction){this._is_a="bbop.logic";var logger=new bbop.logger();logger.DEBUG=false;function ll(str){logger.kvetch(str)}var logic_anchor=this;if(!default_conjunction){default_conjunction="and"}this.default_conjunction=default_conjunction;var _empty=function(){logic_anchor._bundle={};logic_anchor._bundle[logic_anchor.default_conjunction]=[]};_empty();this.add=function(item){if(bbop.core.what_is(item)=="bbop.logic"){this._bundle[this.default_conjunction].push(item._bundle)}else{this._bundle[this.default_conjunction].push(item)}};this.negate=function(){var nega={};nega.not=this._bundle;this._bundle=nega};this._read_walk=function(data_bundle,in_encoder,lvl){var encoder=in_encoder||function(in_out){return in_out};ll("LRW: with: "+bbop.core.dump(data_bundle));var l_enc="(";var r_enc=")";if(typeof(lvl)=="undefined"){lvl=1;l_enc="";r_enc=""}var read="";if(bbop.core.what_is(data_bundle)=="string"){ll("LRW: trigger string");read=data_bundle}else{ll("LRW: trigger non-string");var op=bbop.core.get_keys(data_bundle)[0];var arg=data_bundle[op];if(!bbop.core.is_array(arg)){arg=[arg]}var stack=[];bbop.core.each(arg,function(item,i){stack.push(logic_anchor._read_walk(item,encoder,lvl+1))});if(op=="not"){read=op+" "+stack.join("")}else{read=l_enc+stack.join(" "+op+" ")+r_enc}}ll("LRW: returns: "+read);return read};this.to_string=function(){return logic_anchor._read_walk(logic_anchor._bundle)};this.url=function(){return logic_anchor._read_walk(logic_anchor._bundle)};this.empty=_empty;this.parse=function(in_str){return null}};if(typeof bbop=="undefined"){var bbop={}}bbop.registry=function(evt_list){this._is_a="bbop.registry";var registry_anchor=this;this.callback_registry={};bbop.core.each(evt_list,function(item,i){registry_anchor.callback_registry[item]={}});this.register=function(category,function_id,in_function,in_priority){if(typeof(registry_anchor.callback_registry[category])=="undefined"){throw new Error("cannot register, unknown category")}var priority=0;if(in_priority){priority=in_priority}registry_anchor.callback_registry[category][function_id]={runner:in_function,priority:priority}};this.is_registered=function(category,function_id){var retval=null;var anc=registry_anchor.callback_registry;if(typeof(anc[category])!="undefined"){retval=false;if(typeof(anc[category][function_id])!="undefined"){retval=true}}return retval};this.unregister=function(category,function_id){var retval=false;if(registry_anchor.callback_registry[category]&&registry_anchor.callback_registry[category][function_id]){delete registry_anchor.callback_registry[category][function_id];retval=true}return retval};this.get_callbacks=function(category){var cb_id_list=bbop.core.get_keys(registry_anchor.callback_registry[category]);var ptype_registry_anchor=this;cb_id_list.sort(function(a,b){var pkg_a=ptype_registry_anchor.callback_registry[category][a];var pkg_b=ptype_registry_anchor.callback_registry[category][b];return pkg_b.priority-pkg_a.priority});var cb_fun_list=[];for(var cbi=0;cbi<cb_id_list.length;cbi++){var cb_id=cb_id_list[cbi];var to_run=registry_anchor.callback_registry[category][cb_id]["runner"];cb_fun_list.push(to_run)}return cb_fun_list};this.apply_callbacks=function(category,arg_list,context){var callbacks=registry_anchor.get_callbacks(category);for(var ci=0;ci<callbacks.length;ci++){var run_fun=callbacks[ci];run_fun.apply(context,arg_list)}}};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.html=="undefined"){bbop.html={}}if(typeof bbop.html.tag=="undefined"){bbop.html.tag={}}if(typeof bbop.html.accordion=="undefined"){bbop.html.accordion={}}if(typeof bbop.html.list=="undefined"){bbop.html.list={}}if(typeof bbop.html.input=="undefined"){bbop.html.input={}}if(typeof bbop.html.img=="undefined"){bbop.html.img={}}bbop.html.tag=function(tag,attrs,below){this._is_a="bbop.html.tag";if(!attrs){attrs={}}else{attrs=bbop.core.clone(attrs)}if(!bbop.core.is_defined(attrs.id)&&bbop.core.is_defined(attrs.generate_id)&&bbop.core.is_defined(attrs.generate_id)==true){attrs.id="gen_id-bbop-html-"+bbop.core.randomness(20);delete attrs.generate_id}this._attrs=attrs;if(!below){below=[]}else{if(bbop.core.is_array(below)){}else{below=[below]}}var additional_attrs="";bbop.core.each(this._attrs,function(in_key,in_val){additional_attrs=additional_attrs+" "+in_key+'="'+in_val+'"'});this._car="<"+tag+additional_attrs+">";this._cdr="</"+tag+">";this._contents=below;this._singleton="<"+tag+additional_attrs+" />"};bbop.html.tag.prototype.to_string=function(){var acc="";bbop.core.each(this._contents,function(item,i){acc=acc+bbop.core.to_string(item)});var output=this._singleton;if(acc!=""){output=this._car+acc+this._cdr}return output};bbop.html.tag.prototype.add_to=function(bbop_html_tag_or_string){this._contents.push(bbop_html_tag_or_string)};bbop.html.tag.prototype.empty=function(){this._contents=[]};bbop.html.tag.prototype.get_id=function(){var retval=null;if(bbop.core.is_defined(this._attrs.id)){retval=this._attrs.id}return retval};bbop.html.accordion=function(in_list,attrs,add_id_p){this._is_a="bbop.html.accordion";if(typeof(add_id_p)=="undefined"){add_id_p=false}this._attrs=attrs||{};this._div_stack=new bbop.html.tag("div",this._attrs);this._section_id_to_content_id={};var accordion_this=this;bbop.core.each(in_list,function(item){var sect_title=item[0];var content=item[1];accordion_this.add_to(sect_title,content,add_id_p)})};bbop.html.accordion.prototype.to_string=function(){return this._div_stack.to_string()};bbop.html.accordion.prototype.add_to=function(section_info,content_blob,add_id_p){var section_id=null;var section_label=null;var section_desc=null;if(typeof section_info!="object"){section_id=section_info;section_label=section_info}else{if(section_info.id){section_id=section_info.id}if(section_info.label){section_label=section_info.label}if(section_info.description){section_desc=section_info.description}}var h3=new bbop.html.tag("h3");var anc=null;if(section_desc){anc=new bbop.html.tag("a",{href:"#",title:section_desc},section_label)}else{anc=new bbop.html.tag("a",{href:"#"},section_label)}h3.add_to(anc);this._div_stack.add_to(h3);var div=null;if(typeof(add_id_p)=="undefined"){add_id_p=false}if(add_id_p){var rid="accordion-"+section_id+"-"+bbop.core.randomness(20);this._section_id_to_content_id[section_id]=rid;div=new bbop.html.tag("div",{id:rid})}else{div=new bbop.html.tag("div")}var p=new bbop.html.tag("p",{},bbop.core.to_string(content_blob));div.add_to(p);this._div_stack.add_to(div)};bbop.html.accordion.prototype.empty=function(){this._div_stack=new bbop.html.tag("div",this._attrs);this._section_id_to_content_id={}};bbop.html.accordion.prototype.get_id=function(){return this._div_stack.get_id()};bbop.html.accordion.prototype.get_section_id=function(sect_id){return this._section_id_to_content_id[sect_id]};bbop.html.list=function(in_list,attrs){this._is_a="bbop.html.list";if(!attrs){attrs={}}this._attrs=attrs;this._ul_stack=new bbop.html.tag("ul",this._attrs);var list_this=this;bbop.core.each(in_list,function(item){list_this.add_to(item)})};bbop.html.list.prototype.to_string=function(){return this._ul_stack.to_string()};bbop.html.list.prototype.add_to=function(){var args=Array.prototype.slice.call(arguments);var li_acc=[];bbop.core.each(args,function(arg){li_acc.push(bbop.core.to_string(arg))});var li=new bbop.html.tag("li",{},li_acc.join(" "));this._ul_stack.add_to(li)};bbop.html.list.prototype.empty=function(){this._ul_stack=new bbop.html.tag("ul",this._attrs)};bbop.html.list.prototype.get_id=function(){return this._ul_stack.get_id()};bbop.html.input=function(attrs){this._is_a="bbop.html.input";if(!attrs){attrs={}}this._attrs=attrs;this._input_stack=new bbop.html.tag("input",this._attrs)};bbop.html.input.prototype.to_string=function(){return this._input_stack.to_string()};bbop.html.input.prototype.add_to=function(item){this._input_stack.add_to(bbop.core.to_string(item))};bbop.html.input.prototype.empty=function(){this._input_stack=new bbop.html.tag("input",this._attrs)};bbop.html.input.prototype.get_id=function(){return this._input_stack.get_id()};bbop.html.anchor=function(in_cont,in_attrs){this._is_a="bbop.html.anchor";this._attrs=in_attrs||{};this._anchor_stack=new bbop.html.tag("a",this._attrs,in_cont)};bbop.html.anchor.prototype.to_string=function(){return this._anchor_stack.to_string()};bbop.html.anchor.prototype.add_to=function(item){this._anchor_stack.add_to(item)};bbop.html.anchor.prototype.empty=function(){this._anchor_stack.empty()};bbop.html.anchor.prototype.get_id=function(){return this._anchor_stack.get_id()};bbop.html.image=function(in_attrs){this._is_a="bbop.html.image";this._attrs=in_attrs||{};this._image_stack=new bbop.html.tag("img",this._attrs)};bbop.html.image.prototype.to_string=function(){return this._image_stack.to_string()};bbop.html.image.prototype.add_to=function(item){this._image_stack.add_to(item)};bbop.html.image.prototype.empty=function(){this._image_stack.empty()};bbop.html.image.prototype.get_id=function(){return this._image_stack.get_id()};bbop.html.table=function(in_headers,in_entries,in_attrs){this._is_a="bbop.html.table";var headers=in_headers||[];var entries=in_entries||[];this._attrs=in_attrs||{};this._count=0;this._table_stack=new bbop.html.tag("table",this._attrs);if(!bbop.core.is_empty(headers)){var head_row=new bbop.html.tag("tr");bbop.core.each(headers,function(header){var th=new bbop.html.tag("th");th.add_to(header);head_row.add_to(th)});var head_stack=new bbop.html.tag("thead");head_stack.add_to(head_row);this._table_stack.add_to(head_stack)}this._body_stack=new bbop.html.tag("tbody");this._table_stack.add_to(this._body_stack);var this_table=this;bbop.core.each(entries,function(item){this_table.add_to(item)})};bbop.html.table.prototype.to_string=function(){return this._table_stack.to_string()};bbop.html.table.prototype.add_to=function(entries){var row_class="odd_row";if(this._count%2==0){row_class="even_row"}this._count=this._count+1;var tr=new bbop.html.tag("tr",{"class":row_class});if(!bbop.core.is_array(entries)){entries=[entries]}bbop.core.each(entries,function(entry){var td=new bbop.html.tag("td");td.add_to(entry);tr.add_to(td)});this._body_stack.add_to(tr)};bbop.html.table.prototype.empty=function(){this._count=0;this._body_stack.empty()};bbop.html.table.prototype.get_id=function(){return this._table_stack.get_id()};bbop.html.button=function(in_label,in_attrs){this._is_a="bbop.html.button";this._attrs=in_attrs||{};this._button_stack=new bbop.html.tag("button",this._attrs,in_label)};bbop.html.button.prototype.to_string=function(){return this._button_stack.to_string()};bbop.html.button.prototype.add_to=function(item){this._button_stack.add_to(item)};bbop.html.button.prototype.empty=function(){this._button_stack.empty()};bbop.html.button.prototype.get_id=function(){return this._button_stack.get_id()};bbop.html.span=function(in_label,in_attrs){this._is_a="bbop.html.span";this._attrs=in_attrs||{};this._span_stack=new bbop.html.tag("span",this._attrs,in_label)};bbop.html.span.prototype.to_string=function(){return this._span_stack.to_string()};bbop.html.span.prototype.add_to=function(item){this._span_stack.add_to(item)};bbop.html.span.prototype.empty=function(){this._span_stack.empty()};bbop.html.span.prototype.get_id=function(){return this._span_stack.get_id()};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.html=="undefined"){bbop.html={}}bbop.html.collapsible=function(in_list,attrs){this._is_a="bbop.html.collapsible";this._attrs=attrs||{};if(this._attrs["class"]){this._attrs["class"]=this._attrs["class"]+" panel-group"}else{this._attrs["class"]="panel-group"}this._cid=null;if(!this._attrs.id){this._attrs.id="gen_id-bbop-html-clps-"+bbop.core.randomness(20)}this._cid=this._attrs.id;this._div_stack=new bbop.html.tag("div",this._attrs);this._section_id_to_content_id={};var collapsible_this=this;bbop.core.each(in_list,function(item){var sect_title=item[0];var content=item[1];collapsible_this.add_to(sect_title,content)})};bbop.html.collapsible.prototype.to_string=function(){return this._div_stack.to_string()};bbop.html.collapsible.prototype.add_to=function(section_info,content_blob){var section_id=null;var section_label=null;var section_desc=null;if(typeof section_info!="object"){section_id=section_info;section_label=section_info}else{if(section_info.id){section_id=section_info.id}if(section_info.label){section_label=section_info.label}if(section_info.description){section_desc=section_info.description}}var coll_id="collapsible-"+section_id+"-"+bbop.core.randomness(20);var cont_id="content-"+section_id+"-"+bbop.core.randomness(20);this._section_id_to_content_id[section_id]=cont_id;var title_a_attrs={"data-toggle":"collapse","data-parent":"#"+this._cid,href:"#"+coll_id};if(section_desc){title_a_attrs.title=section_desc}var title_a=new bbop.html.tag("a",title_a_attrs,section_label);var h4_attrs={"class":"panel-title"};var h4=new bbop.html.tag("h4",h4_attrs,title_a);var divh_attrs={"class":"panel-heading"};var divh=new bbop.html.tag("div",divh_attrs,h4);var body_attrs={"class":"panel-body",style:"overflow-x: auto;",id:cont_id};var body=new bbop.html.tag("div",body_attrs,content_blob);var divb_attrs={"class":"panel-collapse collapse",id:coll_id};var divb=new bbop.html.tag("div",divb_attrs,body);var divp_attrs={"class":"panel panel-default"};var divp=new bbop.html.tag("div",divp_attrs,[divh,divb]);this._div_stack.add_to(divp)};bbop.html.collapsible.prototype.empty=function(){this._div_stack=new bbop.html.tag("div",this._attrs);this._section_id_to_content_id={}};bbop.html.collapsible.prototype.get_id=function(){return this._div_stack.get_id()};bbop.html.collapsible.prototype.get_section_id=function(sect_id){return this._section_id_to_content_id[sect_id]};if(typeof bbop=="undefined"){var bbop={}}bbop.handler=function(){this._is_a="bbop.handler"};bbop.handler.prototype.dispatch=function(data,name,context,fallback){return null};if(typeof bbop=="undefined"){var bbop={}}bbop.linker=function(){this._is_a="bbop.linker"};bbop.linker.prototype.url=function(id,xid){return null};bbop.linker.prototype.anchor=function(id,xid){return null};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.model=="undefined"){bbop.model={}}bbop.model.default_predicate="points_at";bbop.model.node=function(new_id,new_label){this._is_a="bbop.model.node";this._id=new_id||undefined;this._label=new_label||undefined;this._type="node";if(!new_id){this._type=undefined}this._metadata=undefined};bbop.model.node.prototype.id=function(value){if(value){this._id=value}return this._id};bbop.model.node.prototype.type=function(value){if(value){this._type=value}return this._type};bbop.model.node.prototype.label=function(value){if(value){this._label=value}return this._label};bbop.model.node.prototype.metadata=function(value){if(value){this._metadata=value}return this._metadata};bbop.model.node.prototype.clone=function(){var tmp_clone=new bbop.model.node(this.id());tmp_clone.type(this.type());tmp_clone.label(this.label());tmp_clone.metadata(bbop.core.clone(this.metadata()));return tmp_clone};bbop.model.edge=function(subject,object,predicate){this._is_a="bbop.model.edge";if(!subject){this._subject_id=undefined}else{if(typeof subject=="string"){this._subject_id=subject}else{this._subject_id=subject.id()}}if(!object){this._object_id=undefined}else{if(typeof object=="string"){this._object_id=object}else{this._object_id=object.id()}}this._predicate_id=bbop.model.default_predicate;if(predicate){this._predicate_id=predicate}this._type="edge";if(!subject||!object){this._type=undefined}this._metadata=undefined};bbop.model.edge.prototype.subject_id=function(){return this._subject_id};bbop.model.edge.prototype.object_id=function(){return this._object_id};bbop.model.edge.prototype.predicate_id=function(){return this._predicate_id};bbop.model.edge.prototype.type=function(value){if(value){this._type=value}return this._type};bbop.model.edge.prototype.metadata=function(value){if(value){this._metadata=value}return this._metadata};bbop.model.edge.prototype.clone=function(){var tmp_clone=new bbop.model.edge(this.subject_id(),this.object_id(),this.predicate_id());tmp_clone.metadata(bbop.core.clone(this.metadata()));return tmp_clone};bbop.model.graph=function(){this._is_a="bbop.model.graph";this._id=undefined;this._logger=new bbop.logger(this._is_a);this._logger.DEBUG=true;this._nodes={array:new Array,hash:{}};this._edges={array:new Array};this._predicates={array:new Array,hash:{}};this._named_nodes={array:new Array,hash:{}};this._subjects={array:new Array,hash:{}};this._objects={array:new Array,hash:{}};this._so_table={};this._os_table={};this._sop_table={};this._is_a_singleton_lookup={}};bbop.model.graph.prototype.id=function(value){if(value){this._id=value}return this._id};bbop.model.graph.prototype.add_node=function(node){if(!node.id()||this._nodes.hash[node.id()]||this._nodes.hash[node.id()]){}else{var nid=node.id();this._nodes.hash[nid]=node;this._nodes.array.push(node);this._named_nodes.hash[nid]=node;this._named_nodes.array.push(node);if(!this._subjects.hash[nid]&&!this._objects.hash[nid]){this._is_a_singleton_lookup[nid]=true}}};bbop.model.graph.prototype.add_edge=function(edge){var sub_id=edge.subject_id();var obj_id=edge.object_id();var pred_id=edge.predicate_id();if(!this._so_table[sub_id]){this._so_table[sub_id]={}}this._so_table[sub_id][obj_id]=true;if(!this._os_table[obj_id]){this._os_table[obj_id]={}}this._os_table[obj_id][sub_id]=true;if(!this._sop_table[sub_id]){this._sop_table[sub_id]={}}if(!this._sop_table[sub_id][obj_id]){this._sop_table[sub_id][obj_id]={}}this._sop_table[sub_id][obj_id][pred_id]=edge;if(!this._predicates.hash[pred_id]){this._predicates.hash[pred_id]=true;this._predicates.array.push(pred_id)}if(!this._subjects.hash[sub_id]){this._subjects.hash[sub_id]=true;this._subjects.array.push(sub_id)}if(!this._objects.hash[obj_id]){this._objects.hash[obj_id]=true;this._objects.array.push(obj_id)}if(this._is_a_singleton_lookup[sub_id]){delete this._is_a_singleton_lookup[sub_id]}if(this._is_a_singleton_lookup[obj_id]){delete this._is_a_singleton_lookup[obj_id]}this._edges.array.push(edge);if(!this._named_nodes.hash[sub_id]){this._named_nodes.array.push(sub_id)}this._named_nodes.hash[sub_id]=edge;if(!this._named_nodes.hash[obj_id]){this._named_nodes.array.push(obj_id)}this._named_nodes.hash[obj_id]=edge};bbop.model.graph.prototype.all_nodes=function(){return this._nodes.array};bbop.model.graph.prototype.all_edges=function(){return this._edges.array};bbop.model.graph.prototype.all_predicates=function(){return this._predicates.array};bbop.model.graph.prototype.all_dangling=function(){var unnamed=new Array();for(var named_id in this._named_nodes.hash){if(!this._nodes.hash[named_id]){unnamed.push(named_id)}}return unnamed};bbop.model.graph.prototype.is_complete=function(){var retval=true;if(this.all_dangling().length>0){retval=false}return retval};bbop.model.graph.prototype.get_node=function(nid){var retnode=null;if(this._nodes.hash[nid]){var tmp_node=this._nodes.hash[nid];retnode=tmp_node.clone()}return retnode};bbop.model.graph.prototype.get_edge=function(sub_id,obj_id,pred){if(!pred){pred=bbop.model.default_predicate}var ret_edge=null;if(this._sop_table[sub_id]&&this._sop_table[sub_id][obj_id]&&this._sop_table[sub_id][obj_id][pred]){var tmp_edge=this._sop_table[sub_id][obj_id][pred];ret_edge=tmp_edge.clone()}return ret_edge};bbop.model.graph.prototype.get_edges=function(sub_id,obj_id){var retlist=new Array();if(this._sop_table[sub_id]&&this._sop_table[sub_id][obj_id]){for(var pred in this._sop_table[sub_id][obj_id]){var found_edge=this._sop_table[sub_id][obj_id][pred];var tmp_edge=found_edge.clone();retlist.push(tmp_edge)}}return retlist};bbop.model.graph.prototype.get_predicates=function(sub_id,obj_id){var retlist=[];if(this._sop_table[sub_id]&&this._sop_table[sub_id][obj_id]){for(var pred in this._sop_table[sub_id][obj_id]){retlist.push(pred)}}return retlist};bbop.model.graph.prototype.edges_to_nodes=function(in_edges,target){if(target!="subject"&&target!="object"){throw new Error("Bad target for edges to bodies.")}var results=new Array();for(var i=0;i<in_edges.length;i++){var in_e=in_edges[i];var target_id=null;if(target=="subject"){target_id=in_e.subject_id()}else{target_id=in_e.object_id()}if(target_id&&this._nodes.hash[target_id]){results.push(this._nodes.hash[target_id])}else{throw new Error(target+" world issue")}}return results};bbop.model.graph.prototype.is_root_node=function(nb_id){var result=false;if(this._nodes.hash[nb_id]&&!this._subjects.hash[nb_id]){result=true}return result};bbop.model.graph.prototype.get_root_nodes=function(){var results=new Array();for(var nb_id in this._nodes.hash){if(this.is_root_node(nb_id)){results.push(this.get_node(nb_id).clone())}}return results};bbop.model.graph.prototype.is_leaf_node=function(nb_id){var result=false;if(this._nodes.hash[nb_id]&&!this._objects.hash[nb_id]){result=true}return result};bbop.model.graph.prototype.get_leaf_nodes=function(){var results=new Array();for(var nb_id in this._nodes.hash){if(this.is_leaf_node(nb_id)){results.push(this.get_node(nb_id).clone())}}return results};bbop.model.graph.prototype.get_singleton_nodes=function(){var singleton_array=new Array();for(var singleton_id in this._is_a_singleton_lookup){if(this._nodes.hash[singleton_id]){singleton_array.push(this._nodes.hash[singleton_id])}else{throw new Error("world issue in get_singletons: "+singleton_id)}}return singleton_array};bbop.model.graph.prototype.get_parent_edges=function(nb_id,in_pred){var results=new Array();var preds_to_use=new Array();if(in_pred){preds_to_use.push(in_pred)}else{preds_to_use=this._predicates.array}for(var j=0;j<preds_to_use.length;j++){var pred=preds_to_use[j];if(this._so_table[nb_id]){for(var obj_id in this._so_table[nb_id]){var tmp_edge=this.get_edge(nb_id,obj_id,pred);if(tmp_edge){results.push(tmp_edge)}}}}return results};bbop.model.graph.prototype.get_parent_nodes=function(nb_id,in_pred){var results=new Array();var edges=this.get_parent_edges(nb_id,in_pred);for(var i=0;i<edges.length;i++){var obj_id=edges[i].object_id();var tmp_node=this.get_node(obj_id);if(tmp_node){results.push(this.get_node(obj_id))}}return results};bbop.model.graph.prototype.get_child_nodes=function(nb_id,in_pred){var results=new Array();var preds_to_use=new Array();if(in_pred){preds_to_use.push(in_pred)}else{preds_to_use=this._predicates.array}for(var j=0;j<preds_to_use.length;j++){var pred=preds_to_use[j];if(this._os_table[nb_id]){for(var sub_id in this._os_table[nb_id]){if(this.get_edge(sub_id,nb_id,pred)){var tmp_node=this.get_node(sub_id);if(tmp_node){results.push(this.get_node(sub_id))}}}}}return results};bbop.model.graph.prototype.get_ancestor_subgraph=function(nb_id_or_list,pid){var seen_node_hash={};var seen_edge_list=[];var anchor=this;function rec_up(nid){var results=new Array();var new_parent_edges=anchor.get_parent_edges(nid,pid);for(var e=0;e<new_parent_edges.length;e++){seen_edge_list.push(new_parent_edges[e])}var new_parents=new Array();for(var n=0;n<new_parent_edges.length;n++){var obj_id=new_parent_edges[n].object_id();var temp_node=anchor.get_node(obj_id);if(temp_node){new_parents.push(temp_node)}}var tmp_node=anchor.get_node(nid);if(tmp_node){new_parents.push(tmp_node)}if(new_parents.length!=0){for(var i=0;i<new_parents.length;i++){var new_anc=new_parents[i];var new_anc_id=new_anc.id();if(!seen_node_hash[new_anc_id]){seen_node_hash[new_anc_id]=new_anc;rec_up(new_anc_id)}}}return results}if(bbop.core.is_array(nb_id_or_list)){for(var l=0;l<nb_id_or_list.length;l++){rec_up(nb_id_or_list[l])}}else{rec_up(nb_id_or_list)}var new_graph=new bbop.model.graph();for(var k in seen_node_hash){new_graph.add_node(seen_node_hash[k])}for(var x=0;x<seen_edge_list.length;x++){new_graph.add_edge(seen_edge_list[x])}return new_graph};bbop.model.graph.prototype.merge_in=function(in_graph){var anchor=this;bbop.core.each(in_graph.all_nodes(),function(in_node){var new_node=in_node.clone();anchor.add_node(new_node)});bbop.core.each(in_graph.all_edges(),function(in_edge){var new_edge=in_edge.clone();anchor.add_edge(new_edge)});return true};bbop.model.graph.prototype.load_json=function(json_object){var anchor=this;if(json_object.nodes){bbop.core.each(json_object.nodes,function(node_raw){var nid=node_raw.id;var nlabel=node_raw.lbl;var n=new bbop.model.node(nid,nlabel);if(node_raw.meta){n.metadata(node_raw.meta)}anchor.add_node(n)})}if(json_object.edges){bbop.core.each(json_object.edges,function(edge_raw){var e=new bbop.model.edge(edge_raw.sub,edge_raw.obj,edge_raw.pred);if(edge_raw.meta){e.metadata(edge_raw.meta)}anchor.add_edge(e)})}return true};bbop.model.graph.prototype.to_json=function(){var anchor=this;var nset=[];bbop.core.each(anchor.all_nodes(),function(raw_node){var node=bbop.core.clone(raw_node);var ncopy={};var nid=node.id();if(nid){ncopy.id=nid}var nlabel=node.label();if(nlabel){ncopy.lbl=nlabel}var nmeta=node.metadata();if(nmeta){ncopy.meta=nmeta}nset.push(ncopy)});var eset=[];var ecopy=bbop.core.clone(anchor._edges.array);bbop.core.each(anchor.all_edges(),function(node){var ecopy={};var s=node.subject_id();if(s){ecopy.sub=s}var o=node.object_id();if(o){ecopy.obj=o}var p=node.predicate_id();if(p){ecopy.pred=p}eset.push(ecopy)});var ret_obj={nodes:nset,edges:eset};return ret_obj};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.model=="undefined"){bbop.model={}}if(typeof bbop.model.tree=="undefined"){bbop.model.tree={}}bbop.model.tree.node=function(new_id){bbop.model.node.call(this,new_id);this._is_a="bbop.model.tree.node"};bbop.core.extend(bbop.model.tree.node,bbop.model.node);bbop.model.tree.edge=function(parent,child,distance){bbop.model.edge.call(this,child,parent,"");this._is_a="bbop.model.tree.edge";this._distance=distance||0};bbop.core.extend(bbop.model.tree.edge,bbop.model.edge);bbop.model.tree.edge.prototype.distance=function(d){if(d){this._distance=d}return this._distance};bbop.model.tree.edge.prototype.clone=function(){var tmp_clone=new bbop.model.tree.edge(this.object_id(),this.subject_id(),this.distance());tmp_clone.metadata(bbop.core.clone(this.metadata()));return tmp_clone};bbop.model.tree.graph=function(){bbop.model.graph.call(this);this._is_a="bbop.model.tree.graph";var anchor=this;this.default_sort=function(a,b){var sort_val=0;if(a.id<b.id){sort_val=-1}else{if(a.id>b.id){sort_val=1}}return sort_val};var max_dist=0;var all_dists_parent={};var all_dists_child={};var node_list=new Array();var node_hash={};var edge_list=new Array();var edge_hash={};function info_up(node_id){var nid=node_id;if(!node_hash[nid]){node_hash[nid]=true;node_list.push(nid)}var node_parent=anchor.get_parent_nodes(nid);if(node_parent&&node_parent.length){node_parent=node_parent[0];var pid=node_parent.id();var edge_uid=pid+"_!muNge!_"+node_id;if(!edge_hash[edge_uid]){edge_hash[edge_uid]=true;edge_list.push([pid,node_id])}if(!all_dists_parent[pid]){all_dists_parent[pid]={}}if(!all_dists_child[nid]){all_dists_child[nid]={}}if(!all_dists_parent[pid][nid]){var dist=anchor.get_edge(nid,pid).distance();all_dists_parent[pid][nid]=dist;all_dists_child[nid][pid]=dist;if(dist>max_dist){max_dist=dist}}for(var k_id in all_dists_parent[nid]){var increment=all_dists_parent[pid][nid]+all_dists_parent[nid][k_id];all_dists_parent[pid][k_id]=increment;all_dists_child[k_id][pid]=increment;if(increment>max_dist){max_dist=increment}}info_up(pid)}}var brackets=new Array();var max_depth=0;function bracket_down(in_node,lvl,parent_node_id){if(!lvl){lvl=1}if(!parent_node_id){parent_node_id=null}var in_node_id=in_node.id();var child_bracket=new Array();var child_nodes=anchor.get_child_nodes(in_node_id);for(var cb=0;cb<child_nodes.length;cb++){var child_node=child_nodes[cb];var child_node_id=child_node.id();child_bracket.push(bracket_down(child_node,lvl+1,in_node_id))}child_bracket.sort(anchor.default_sort);if(lvl>max_depth){max_depth=lvl}return{id:in_node_id,routing_node:false,level:lvl,parent_id:parent_node_id,brackets:child_bracket}}var max_width=0;var cohort_list=new Array();this.layout=function(){brackets=new Array();node_list=new Array();node_hash={};edge_list=new Array();edge_hash={};cohort_list=new Array();var base_nodes=anchor.get_root_nodes();for(var bb=0;bb<base_nodes.length;bb++){brackets.push(bracket_down(base_nodes[bb]))}brackets.sort(anchor.default_sort);function dangle_routing(in_item){if(in_item.level<max_depth){in_item.brackets.push({id:in_item.id,routing_node:true,level:in_item.level+1,parent_id:in_item.id,brackets:[]});dangle_routing(in_item.brackets[0])}return in_item}function add_routing(in_brackets){for(var i=0;i<in_brackets.length;i++){var item=in_brackets[i];if(item.brackets.length==0&&item.level<max_depth){dangle_routing(item)}else{if(item.brackets.length!=0){add_routing(item.brackets)}}}}add_routing(brackets);cohort_list=new Array(max_depth);for(var cli=0;cli<cohort_list.length;cli++){cohort_list[cli]=new Array()}function order_cohort(in_brackets){for(var i=0;i<in_brackets.length;i++){var bracket_item=in_brackets[i];cohort_list[bracket_item.level-1].push(bracket_item);if(bracket_item.brackets.length>0){order_cohort(bracket_item.brackets)}}}order_cohort(brackets);var base_info_nodes=anchor.get_leaf_nodes();max_width=base_info_nodes.length;for(var bi=0;bi<base_info_nodes.length;bi++){info_up(base_info_nodes[bi].id())}var position_y={};var final_cohort=cohort_list[(max_depth-1)];for(var j=0;j<final_cohort.length;j++){var f_item=final_cohort[j];var local_shift=j+0;position_y[f_item.id]=local_shift}for(var i=cohort_list.length-1;i>0;i--){var cohort=cohort_list[i-1];for(var k=0;k<cohort.length;k++){var item=cohort[k];if(position_y[item.id]!=undefined){}else{var c_nodes=anchor.get_child_nodes(item.id);var position_acc=0;for(var ci=0;ci<c_nodes.length;ci++){var node=c_nodes[ci];position_acc=position_acc+position_y[node.id()]}var avg=position_acc/(c_nodes.length*1);position_y[item.id]=avg}}}var x_offset=0;var position_x={};var roots=anchor.get_root_nodes();for(var r=0;r<roots.length;r++){var root_id=roots[r].id();position_x[root_id]=x_offset;if(item.routing_node==false){for(var nid in all_dists_parent[root_id]){var dist=all_dists_parent[root_id][nid]+x_offset;position_x[nid]=dist}}}return{parent_distances:all_dists_parent,child_distances:all_dists_child,max_distance:max_dist,max_depth:max_depth,max_width:max_width,cohorts:cohort_list,brackets:brackets,node_list:node_list,edge_list:edge_list,position_x:position_x,position_y:position_y}};this.dump_cohorts=function(){for(var i=0;i<cohort_list.length;i++){for(var j=0;j<cohort_list[i].length;j++){var item=cohort_list[i][j]}}};this.dump_dist=function(in_arg){var dists=all_dists_parent;if(in_arg=="child"){dists=all_dists_child}for(var n_id in dists){for(var k_id in dists[n_id]){}}};this.dump_brackets=function(brack){if(!brack){brack=brackets}for(var i=0;i<brack.length;i++){var pid="(null)";if(brack[i].parent_id){pid=brack[i].parent_id}this.dump_brackets(brack[i].brackets)}}};bbop.core.extend(bbop.model.tree.graph,bbop.model.graph);if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.model=="undefined"){bbop.model={}}if(typeof bbop.model.bracket=="undefined"){bbop.model.bracket={}}bbop.model.bracket.graph=function(){bbop.model.graph.call(this);this._is_a="bbop.model.bracket.graph";var anchor=this;var each=bbop.core.each;anchor._logger.DEBUG=true;function ll(str){anchor._logger.kvetch(str)}this.bracket_layout=function(term_acc){function max_info_climber(in_curr_list,in_curr_term_dist,in_max_hist,in_enc_hist){var curr_list=in_curr_list||[];if(!bbop.core.is_array(curr_list)){curr_list=[curr_list]}var curr_term_distance=in_curr_term_dist||0;var max_hist=in_max_hist||{};var encounter_hist=in_enc_hist||{};function update_info_for(update_item,update_distance){if(!encounter_hist[update_item]){encounter_hist[update_item]=1;max_hist[update_item]=update_distance}else{if(max_hist[update_item]<update_distance){max_hist[update_item]=update_distance}else{}}}if(curr_list&&curr_list.length>0){each(curr_list,function(item){update_info_for(item,curr_term_distance)});var next_round={};each(curr_list,function(item){each(anchor.get_parent_nodes(item),function(p){var pid=p.id();next_round[pid]=true})});var next_list=bbop.core.get_keys(next_round);curr_term_distance++;max_info_climber(next_list,curr_term_distance,max_hist,encounter_hist)}return max_hist}var max_node_dist_from_root=max_info_climber(term_acc);var lvl_lists={};each(max_node_dist_from_root,function(node_id,lvl){if(!bbop.core.is_defined(lvl_lists[lvl])){lvl_lists[lvl]=[]}lvl_lists[lvl].push(node_id)});var bracket_list=[];var levels=bbop.core.get_keys(lvl_lists);levels.sort(bbop.core.numeric_sort_ascending);each(levels,function(level){var bracket=[];each(lvl_lists[level],function(item){bracket.push(item)});bracket_list.push(bracket)});bracket_list.reverse();var c_nodes=anchor.get_child_nodes(term_acc);if(c_nodes&&!bbop.core.is_empty(c_nodes)){var kid_bracket=[];each(c_nodes,function(c){kid_bracket.push(c.id())});bracket_list.push(kid_bracket)}return bracket_list};this.relation_weight=function(predicate_acc,default_weight){var rel=predicate_acc||"";var dflt=default_weight||0;var order={is_a:1,"is a":1,has_part:2,"has part":2,part_of:3,"part of":3,regulates:4,negatively_regulates:5,"negatively regulates":5,positively_regulates:6,"positively regulates":6,occurs_in:7,"occurs in":7};var ret_weight=dflt;if(bbop.core.is_defined(rel)&&rel&&bbop.core.is_defined(order[rel])){ret_weight=order[rel]}return ret_weight};this.dominant_relationship=function(){var all_rels=[];for(var dri=0;dri<arguments.length;dri++){var arg=arguments[dri];if(bbop.core.what_is(arg)==="array"){all_rels.push(this.dominant_relationship.apply(this,arg))}else{all_rels.push(arg)}}all_rels.sort(function(a,b){return anchor.relation_weight(b)-anchor.relation_weight(a)});var retval=null;if(all_rels.length){retval=all_rels[0]}return retval};this.rich_bracket_layout=function(term_acc,transitivity_graph){var layout=anchor.bracket_layout(term_acc);var bracket_list=[];each(layout,function(layout_level){var bracket=[];each(layout_level,function(layout_item){var curr_acc=layout_item;var pred_id="related_to";var curr_node=anchor.get_node(curr_acc);var label=curr_node.label()||layout_item;if(curr_acc==term_acc){}else{var trels=transitivity_graph.get_predicates(term_acc,curr_acc);if(!bbop.core.is_empty(trels)){pred_id=anchor.dominant_relationship(trels)}else{var drels=anchor.get_predicates(curr_acc,term_acc);if(!bbop.core.is_empty(drels)){pred_id=anchor.dominant_relationship(drels)}}}bracket.push([curr_acc,label,pred_id])});bracket.sort(function(a,b){if(a[1]<b[1]){return -1}else{if(a[1]>b[1]){return 1}else{return 0}}});bracket_list.push(bracket)});return bracket_list}};bbop.core.extend(bbop.model.bracket.graph,bbop.model.graph);if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.layout=="undefined"){bbop.layout={}}if(typeof bbop.layout.sugiyama=="undefined"){bbop.layout.sugiyama={}}bbop.layout.sugiyama.DEBUG=false;bbop.layout.sugiyama.iterations=10;bbop.layout.sugiyama.simple_vertex=function(in_id,is_virtual){var vid=in_id;this.is_virtual=false;this.level=null;if(is_virtual){this.is_virtual=true}this.id=function(){return vid}};bbop.layout.sugiyama.simple_edge=function(sub,obj,is_virtual){var subject=sub;var object=obj;this.is_virtual=false;if(is_virtual){this.is_virtual=true}this.subject=function(){return subject};this.object=function(){return object};this.id=function(){return subject+"^"+object}};bbop.layout.sugiyama.partitioner=function(graph){var logger=new bbop.logger("Partitioner");logger.DEBUG=bbop.layout.sugiyama.DEBUG;function ll(str){logger.kvetch(str)}var yikes=new bbop.logger("Partitioner WARNING");function warn_me(str){yikes.kvetch(str)}var each=bbop.core.each;var first_seen_reference={};var last_seen_reference={};var vertex_set={};var edge_set={};var vertex_partition_set={};var edge_partition_set={};var logical_paths=[];var maximum_partition_width=0;var number_of_partitions=0;this.dump=function(){var num_parts=0;for(var key in vertex_partition_set){num_parts++}for(var i=0;i<num_parts;i++){ll("Vertex Partition "+i+":");var curr_part=vertex_partition_set[i];var out=[];for(var j=0;j<curr_part.length;j++){out.push("["+curr_part[j].id()+"]")}ll(out.join(""))}num_parts=0;for(var key in edge_partition_set){num_parts++}for(var i=0;i<num_parts;i++){ll("Edge Partition "+i+":");var curr_part=edge_partition_set[i];var out=[];for(var j=0;j<curr_part.length;j++){out.push("["+curr_part[j].id()+"]")}ll(out.join(""))}for(var i=0;i<logical_paths.length;i++){ll("Path "+i+":");var out=[];for(var l=0;l<logical_paths[i].length;l++){out.push(logical_paths[i][l])}ll(out.join(", "))}};this.max_partition_width=function(){return maximum_partition_width};this.number_of_vertex_partitions=function(){return number_of_partitions};this.get_vertex_partition=function(integer){return vertex_partition_set[integer]};this.number_of_edge_partitions=function(){var i=0;for(var key in edge_partition_set){i++}return i};this.get_edge_partition=function(integer){return edge_partition_set[integer]};this.number_of_logical_paths=function(){return logical_paths.length};this.get_logical_paths=function(integer){return logical_paths};function _cycle_p(node,stack){var ret=false;var id=node.id();each(stack,function(item){if(item==id){ret=true}});return ret}function _new_node_at(bnode,level){ll("adding "+bnode.id()+" at level "+level+"!");var new_vertex=new bbop.layout.sugiyama.simple_vertex(bnode.id());new_vertex.level=level;vertex_set[new_vertex.id()]=new_vertex;first_seen_reference[new_vertex.id()]=level;last_seen_reference[new_vertex.id()]=level}function recursivePartitioner(graph,node,call_stack){var curr_level=call_stack.length-1;var next_level=curr_level+1;ll("recur on "+node.id()+" at level "+curr_level);var child_nodes=graph.get_child_nodes(node.id());ll(node.id()+" has "+(child_nodes.length||"no")+" child(ren)");for(var i=0;i<child_nodes.length;i++){var cnode=child_nodes[i];ll("looking at "+cnode.id());if(_cycle_p(cnode,call_stack)){ll("no update to "+cnode.id()+": cycle")}else{var new_edge=new bbop.layout.sugiyama.simple_edge(cnode.id(),node.id());edge_set[new_edge.id()]=new_edge;if(!vertex_set[cnode.id()]){_new_node_at(cnode,next_level);ll("cs (a): "+call_stack);var new_cs=bbop.core.clone(call_stack);ll("cs (b): "+new_cs);new_cs.push(cnode.id());ll("cs (c): "+new_cs);recursivePartitioner(graph,cnode,new_cs)}else{ll("to update "+cnode.id()+" level to "+next_level+"; fsr: "+first_seen_reference[cnode.id()]+"; lsr: "+last_seen_reference[cnode.id()]);if(first_seen_reference[cnode.id()]>next_level){first_seen_reference[cnode.id()]=next_level}if(last_seen_reference[cnode.id()]<next_level){last_seen_reference[cnode.id()]=next_level;vertex_set[cnode.id()].level=next_level;ll("cs (a): "+call_stack);var new_cs=bbop.core.clone(call_stack);ll("cs (b): "+new_cs);new_cs.push(cnode.id());ll("cs (c): "+new_cs);recursivePartitioner(graph,cnode,new_cs)}}}}}var roots=graph.get_root_nodes();if(roots.length>0){for(var i=0;i<roots.length;i++){_new_node_at(roots[i],0);recursivePartitioner(graph,roots[i],[roots[i].id()])}}else{var a_node=graph.all_nodes()[0]||null;if(!a_node){ll("warning: apparently the graph is empty")}else{_new_node_at(a_node,0);recursivePartitioner(graph,a_node,[a_node.id()])}}var v_id=0;for(var key in edge_set){var edge=edge_set[key];var difference=vertex_set[edge.subject()].level-vertex_set[edge.object()].level;ll("diff for "+edge.subject()+" -> "+edge.object()+" = "+difference);ll("   "+vertex_set[edge.subject()].level+"-"+vertex_set[edge.object()].level);var new_path=[];if(difference>1){var current_subject=edge.object();var current_object=null;var current_level=vertex_set[edge.object()].level;new_path.push(edge.object());for(var i=1;i<=difference;i++){current_object=current_subject;current_level++;if(i!=difference){var v_node_id="_VN_"+v_id+"_";v_id++;var new_v_node=new bbop.layout.sugiyama.simple_vertex(v_node_id,true);new_v_node.level=current_level;vertex_set[new_v_node.id()]=new_v_node;current_subject=new_v_node.id();new_path.push(new_v_node.id())}else{current_subject=edge.subject();new_path.push(edge.subject())}var new_edge=new bbop.layout.sugiyama.simple_edge(current_subject,current_object,true);edge_set[new_edge.id()]=new_edge}new_path.reverse();delete (edge_set[key])}else{new_path.push(edge.subject());new_path.push(edge.object())}logical_paths.push(new_path)}for(var key in vertex_set){var vert=vertex_set[key];var lvl=vert.level;if(!vertex_partition_set[lvl]){vertex_partition_set[lvl]=[];number_of_partitions++}vertex_partition_set[lvl].push(vert);if(vertex_partition_set[lvl].length>maximum_partition_width){maximum_partition_width=vertex_partition_set[lvl].length}}for(var key in edge_set){var edge=edge_set[key];var lvl=vertex_set[edge.object()].level;ll("l:"+lvl);if(!edge_partition_set[lvl]){edge_partition_set[lvl]=[]}edge_partition_set[lvl].push(edge)}};bbop.layout.sugiyama.bmatrix=function(object_vertex_partition,subject_vertex_partition,edge_partition){var logger=new bbop.logger("BMatrix");logger.DEBUG=bbop.layout.sugiyama.DEBUG;function ll(str){logger.kvetch(str)}var yikes=new bbop.logger("BMatrix WARNING");function warn_me(str){yikes.kvetch(str)}var relation_matrix={};var object_vector=object_vertex_partition||[];var subject_vector=subject_vertex_partition||[];if(!object_vector||!subject_vector){warn_me("WARNING: We found an instance of: https://github.com/kltm/bbop-js/issues/23; using a workaround.")}for(var i=0;i<edge_partition.length;i++){var obj_id=edge_partition[i].object();var sub_id=edge_partition[i].subject();if(!relation_matrix[obj_id]){relation_matrix[obj_id]={}}relation_matrix[obj_id][sub_id]=true}for(var m=0;m<=object_vector.length-1;m++){ll("obj: <<o: "+object_vector[m].id()+">>")}for(var n=0;n<=subject_vector.length-1;n++){ll("sub: <<o: "+subject_vector[n].id()+">>")}for(ob in relation_matrix){for(su in relation_matrix[ob]){ll("edge: <<o: "+ob+", s: "+su+">>")}}function getObjectBarycenter(object){var weighted_number_of_edges=0;var number_of_edges=0;for(var s=1;s<=subject_vector.length;s++){if(relation_matrix[object.id()]&&relation_matrix[object.id()][subject_vector[s-1].id()]){weighted_number_of_edges+=s;number_of_edges++}}return(weighted_number_of_edges/number_of_edges)-1}function getSubjectBarycenter(subject){var weighted_number_of_edges=0;var number_of_edges=0;for(var o=1;o<=object_vector.length;o++){if(relation_matrix[object_vector[o-1].id()]&&relation_matrix[object_vector[o-1].id()][subject.id()]){weighted_number_of_edges+=o;number_of_edges++}}return(weighted_number_of_edges/number_of_edges)-1}this.barycentricObjectReorder=function(){object_vector.sort(function(a,b){return getObjectBarycenter(a)-getObjectBarycenter(b)})};this.barycentricSubjectReorder=function(){subject_vector.sort(function(a,b){return getSubjectBarycenter(a)-getSubjectBarycenter(b)})};this.dump=function(){var queue=[];var string=null;for(var i=0;i<subject_vector.length;i++){queue.push(subject_vector[i].id())}string=queue.join("\t");ll("o\\s\t"+string);for(var j=0;j<object_vector.length;j++){queue=[];queue.push(object_vector[j].id());for(var k=0;k<subject_vector.length;k++){if(relation_matrix[object_vector[j].id()]&&relation_matrix[object_vector[j].id()][subject_vector[k].id()]){queue.push("(1)")}else{queue.push("(0)")}}ll(queue.join("\t"))}}};bbop.layout.sugiyama.render=function(){this._is_a="bbop.layout.sugiyama.render";var anchor=this;var logger=new bbop.logger("SuGR");logger.DEBUG=bbop.layout.sugiyama.DEBUG;function ll(str){logger.kvetch(str)}var yikes=new bbop.logger("SuGR WARNING");function warn_me(str){yikes.kvetch(str)}this.layout=function(graph_in){var partitions=new bbop.layout.sugiyama.partitioner(graph_in);ll("Dump paritions:");partitions.dump();ll("");var edge_partitions=[];var vertex_partitions=[];for(var i=0;i<partitions.number_of_edge_partitions();i++){var epart=partitions.get_edge_partition(i);if(!epart){throw new Error("null edge partition at level: "+i)}else{edge_partitions.push(epart)}}for(var i=0;i<partitions.number_of_vertex_partitions();i++){var vpart=partitions.get_vertex_partition(i);if(!vpart){throw new Error("null vertex partition at level: "+i)}else{vertex_partitions.push(vpart)}}for(var i=0;i<edge_partitions.length;i++){var m=new bbop.layout.sugiyama.bmatrix(vertex_partitions[i],vertex_partitions[i+1],edge_partitions[i]);ll("Matrix: "+i);m.dump();ll("");for(var k=0;k<bbop.layout.sugiyama.iterations;k++){m.barycentricObjectReorder();m.barycentricSubjectReorder()}ll("Matrix: "+i);m.dump();ll("")}var layout_matrix=[];for(var i=0;i<vertex_partitions.length;i++){layout_matrix.push(new Array(partitions.max_partition_width()))}var real_vertex_locations=[];var vertex_registry={};var virtual_vertex_locations=[];var m=partitions.max_partition_width();for(var i=0;i<vertex_partitions.length;i++){var l=vertex_partitions[i].length;for(var v=0;v<l;v++){var locale=Math.floor((v+1)*(m/l/2));while(layout_matrix[i][locale]){locale++}var vid=vertex_partitions[i][v].id();layout_matrix[i][locale]=vid;vertex_registry[vid]={x:locale,y:i};if(!vertex_partitions[i][v].is_virtual){real_vertex_locations.push({x:locale,y:i,id:vid})}else{virtual_vertex_locations.push({x:locale,y:i,id:vid})}ll(vid+", x:"+locale+" y:"+i)}}var logical_paths=partitions.get_logical_paths();var described_paths=[];for(var i=0;i<logical_paths.length;i++){var node_trans=[];var waypoints=[];for(var j=0;j<logical_paths[i].length;j++){var cursor=logical_paths[i][j];node_trans.push(cursor);waypoints.push({x:vertex_registry[cursor].x,y:vertex_registry[cursor].y})}described_paths.push({nodes:node_trans,waypoints:waypoints})}return{nodes:real_vertex_locations,virtual_nodes:virtual_vertex_locations,paths:described_paths,height:partitions.max_partition_width(),width:partitions.number_of_vertex_partitions()}}};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.rest=="undefined"){bbop.rest={}}bbop.rest.response=function(in_data){this._is_a="bbop.rest.response";this._raw=in_data;this._okay=null;this._message=null;this._message_type=null};bbop.rest.response.prototype.raw=function(){return this._raw};bbop.rest.response.prototype.okay=function(okay_p){if(bbop.core.is_defined(okay_p)){this._okay=okay_p}if(this._okay==null){if(!this._raw||this._raw==""){this._okay=false}else{this._okay=true}}return this._okay};bbop.rest.response.prototype.message=function(message){if(bbop.core.is_defined(message)){this._message=message}return this._message};bbop.rest.response.prototype.message_type=function(message_type){if(bbop.core.is_defined(message_type)){this._message_type=message_type}return this._message_type};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.rest=="undefined"){bbop.rest={}}if(typeof bbop.rest.response=="undefined"){bbop.rest.response={}}bbop.rest.response.json=function(json_data){bbop.rest.response.call(this);this._is_a="bbop.rest.response.json";this._raw_string=null;this._okay=null;if(json_data){if(bbop.core.what_is(json_data)=="string"){try{this._raw=bbop.json.parse(json_data);this._okay=true}catch(e){this._raw=json_data;this._okay=false}}else{if(bbop.core.what_is(json_data)=="object"||bbop.core.what_is(json_data)=="array"){this._raw=json_data;this._okay=true}else{this._raw=null;this._okay=null}}}};bbop.core.extend(bbop.rest.response.json,bbop.rest.response);if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.rest=="undefined"){bbop.rest={}}if(typeof bbop.rest.response=="undefined"){bbop.rest.response={}}bbop.rest.response.mmm=function(raw_data){bbop.rest.response.call(this);this._is_a="bbop.rest.response.mmm";this._commentary=null;this._data=null;this.okay(false);this._raw=null;if(!raw_data){this.message("empty response in handler");this.message_type("error")}else{var itsa=bbop.core.what_is(raw_data);if(itsa!="string"&&itsa!="object"){this.message("bad argument type in handler");this.message_type("error")}else{if(itsa=="string"){try{this._raw=bbop.json.parse(raw_data)}catch(e){this._raw=null;this.message("handler could not parse string response");this.message_type("error")}}else{this._raw=raw_data}if(this._raw){var data=this._raw;if(data&&data.message_type&&data.message){var odata=data.data||null;var cdata=data.commentary||null;if(odata&&bbop.core.what_is(odata)!="object"&&bbop.core.what_is(odata)!="array"){this.message("data not object");this.message_type("error")}else{if(cdata&&bbop.core.what_is(cdata)!="object"){this.message("commentary not object");this.message_type("error")}else{this.okay(true);this.message_type(data.message_type);this.message(data.message);if(cdata){this._commentary=cdata}if(odata){this._data=odata}}}}}}}};bbop.core.extend(bbop.rest.response.mmm,bbop.rest.response);bbop.rest.response.mmm.prototype.commentary=function(){var ret=null;if(this._commentary){ret=bbop.core.clone(this._commentary)}return ret};bbop.rest.response.mmm.prototype.data=function(){var ret=null;if(this._data){ret=bbop.core.clone(this._data)}return ret};bbop.rest.response.mmm.prototype.model_id=function(){var ret=null;if(this._data&&this._data.id){ret=this._data.id}return ret};bbop.rest.response.mmm.prototype.inconsistent_p=function(){var ret=false;if(this._data&&typeof(this._data.inconsistent_p)!=="undefined"&&this._data.inconsistent_p==true){ret=true}return ret};bbop.rest.response.mmm.prototype.facts=function(){var ret=[];if(this._data&&this._data.facts&&bbop.core.is_array(this._data.facts)){ret=this._data.facts}return ret};bbop.rest.response.mmm.prototype.properties=function(){var ret=[];if(this._data&&this._data.properties&&bbop.core.is_array(this._data.properties)){ret=this._data.properties}return ret};bbop.rest.response.mmm.prototype.individuals=function(){var ret=[];if(this._data&&this._data.individuals&&bbop.core.is_array(this._data.individuals)){ret=this._data.individuals}return ret};bbop.rest.response.mmm.prototype.relations=function(){var ret=[];if(this._data&&this._data.relations&&bbop.core.is_array(this._data.relations)){ret=this._data.relations}return ret};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.rest=="undefined"){bbop.rest={}}bbop.rest.manager=function(response_handler){bbop.registry.call(this,["success","error"]);this._is_a="bbop.rest.manager";var anchor=this;this._logger=new bbop.logger(this._is_a);this._logger.DEBUG=false;function ll(str){anchor._logger.kvetch(str)}this._response_handler=response_handler;this._qurl=null;this._qpayload={};this._qmethod=null;this._safety=false;this.debug=function(p){if(p==true||p==false){this._logger.DEBUG=p}return this._logger.DEBUG};this._run_success_callbacks=function(in_data){ll("run success callbacks...");var response=new anchor._response_handler(in_data);anchor.apply_callbacks("success",[response,anchor])};this._run_error_callbacks=function(in_data){ll("run error callbacks...");var response=new anchor._response_handler(in_data);anchor.apply_callbacks("error",[response,anchor])};this.resource=function(url){if(bbop.core.is_defined(url)&&bbop.core.what_is(url)=="string"){anchor._qurl=url}return anchor._qurl};this.payload=function(payload){if(bbop.core.is_defined(payload)&&bbop.core.what_is(payload)=="object"){anchor._qpayload=payload}return bbop.core.clone(anchor._qpayload)};this.method=function(method){if(bbop.core.is_defined(method)&&bbop.core.what_is(method)=="string"){anchor._qmethod=method}return anchor._qmethod};this.action=function(url,payload,method){if(bbop.core.is_defined(url)){anchor.resource(url)}if(bbop.core.is_defined(payload)){anchor.payload(payload)}if(bbop.core.is_defined(method)){anchor.method(method)}if(bbop.core.is_defined(anchor.resource())){return anchor.update("success")}else{return anchor.update("error")}}};bbop.core.extend(bbop.rest.manager,bbop.registry);bbop.rest.manager.prototype.to_string=function(){return"["+this._is_a+"]"};bbop.rest.manager.prototype.assemble=function(){var qurl=this.resource();if(!bbop.core.is_empty(this.payload())){var asm=bbop.core.get_assemble(this.payload());qurl=qurl+"?"+asm}return qurl};bbop.rest.manager.prototype.update=function(callback_type){var qurl=this.resource();if(!bbop.core.is_empty(this.payload())){var asm=bbop.core.get_assemble(this.payload());qurl=qurl+"?"+asm}if(callback_type=="success"){this._run_success_callbacks(qurl)}else{if(callback_type=="error"){this._run_error_callbacks(qurl)}else{throw new Error("Unknown callback_type: "+callback_type)}}return qurl};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.rest=="undefined"){bbop.rest={}}if(typeof bbop.rest.manager=="undefined"){bbop.rest.manager={}}bbop.rest.manager.rhino=function(response_handler){bbop.rest.manager.call(this,response_handler);this._is_a="bbop.rest.manager.rhino"};bbop.core.extend(bbop.rest.manager.rhino,bbop.rest.manager);bbop.rest.manager.rhino.prototype.update=function(callback_type){var qurl=this.assemble();var raw_str=readUrl(qurl);if(raw_str&&raw_str!=""){var response=new this._response_handler(raw_str);this.apply_callbacks(callback_type,[response,this])}else{var response=new anchor._response_handler(null);this.apply_callbacks("error",[response,this])}return qurl};bbop.rest.manager.rhino.prototype.fetch=function(url,payload){var retval=null;if(url){this.resource(url)}if(payload){this.payload(payload)}var qurl=this.assemble();var raw_str=readUrl(qurl);if(raw_str&&raw_str!=""){retval=new this._response_handler(raw_str)}else{retval=new anchor._response_handler(null)}return retval};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.rest=="undefined"){bbop.rest={}}if(typeof bbop.rest.manager=="undefined"){bbop.rest.manager={}}bbop.rest.manager.ringo=function(response_handler){bbop.rest.manager.call(this,response_handler);this._is_a="bbop.rest.manager.ringo";this._http_client=require("ringo/httpclient")};bbop.core.extend(bbop.rest.manager.ringo,bbop.rest.manager);bbop.rest.manager.ringo.prototype.update=function(callback_type){var anchor=this;var qurl=anchor.resource();anchor._callbacker=function(data,status,contentType,exchange){var raw_str=exchange.content;if(raw_str&&raw_str!=""){var response=new anchor._response_handler(raw_str);anchor.apply_callbacks(callback_type,[response,this])}else{var response=new anchor._response_handler(null);this.apply_callbacks("error",[response,this])}};var exchange=this._http_client.get(qurl,null,anchor._callbacker);return qurl};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.rest=="undefined"){bbop.rest={}}if(typeof bbop.rest.manager=="undefined"){bbop.rest.manager={}}bbop.rest.manager.node=function(response_handler){bbop.rest.manager.call(this,response_handler);this._is_a="bbop.rest.manager.node";this._http_client=require("http");this._url_parser=require("url")};bbop.core.extend(bbop.rest.manager.node,bbop.rest.manager);bbop.rest.manager.node.prototype.update=function(callback_type){var anchor=this;function on_error(e){console.log("problem with request: "+e.message);var response=new anchor._response_handler(null);response.okay(false);response.message(e.message);response.message_type("error");anchor.apply_callbacks("error",[response,anchor])}function on_connect(res){res.setEncoding("utf8");var raw_data="";res.on("data",function(chunk){raw_data=raw_data+chunk});res.on("end",function(){var response=new anchor._response_handler(raw_data);if(response&&response.okay()){anchor.apply_callbacks("success",[response,anchor])}else{if(!response){response=new anchor._response_handler(null);response.okay(false);response.message_type("error");response.message("null response")}else{response.message_type("error");response.message("bad response")}anchor.apply_callbacks("error",[response,anchor])}})}var qurl=this.resource();var args="";if(!bbop.core.is_empty(this.payload())){var asm=bbop.core.get_assemble(this.payload());args="?"+asm}var final_url=qurl+args;var purl=anchor._url_parser.parse(final_url);var req_opts={port:80,method:"GET"};bbop.core.each(["protocol","hostname","port","path"],function(purl_prop){if(purl[purl_prop]){req_opts[purl_prop]=purl[purl_prop]}});var mth=anchor.method();if(mth&&mth!="get"){req_opts.method=mth}var req=anchor._http_client.request(req_opts,on_connect);req.on("error",on_error);req.end();return final_url};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.rest=="undefined"){bbop.rest={}}if(typeof bbop.rest.manager=="undefined"){bbop.rest.manager={}}bbop.rest.manager.jquery=function(response_handler){bbop.rest.manager.call(this,response_handler);this._is_a="bbop.rest.manager.jquery";this._use_jsonp=false;this._jsonp_callback="json.wrf";this._headers=null;var anchor=this;anchor.JQ=new bbop.rest.manager.jquery_faux_ajax();try{if(typeof(jQuery)!=="undefined"){anchor.JQ=jQuery.noConflict()}}catch(x){}finally{var got=bbop.core.what_is(anchor.JQ);if(got&&got=="bbop.rest.manager.jquery_faux_ajax"){}else{got="jQuery"}}};bbop.core.extend(bbop.rest.manager.jquery,bbop.rest.manager);bbop.rest.manager.jquery.prototype.use_jsonp=function(use_p){var anchor=this;if(bbop.core.is_defined(use_p)){if(use_p==true||use_p==false){anchor._use_jsonp=use_p}}return anchor._use_jsonp};bbop.rest.manager.jquery.prototype.jsonp_callback=function(cstring){var anchor=this;if(bbop.core.is_defined(cstring)){anchor._jsonp_callback=cstring}return anchor._jsonp_callback};bbop.rest.manager.jquery.prototype.headers=function(header_set){var anchor=this;if(bbop.core.is_defined(header_set)){anchor._headers=header_set}return anchor._headers};bbop.rest.manager.jquery.prototype.update=function(callback_type){var anchor=this;var qurl=this.resource();var args="";if(!bbop.core.is_empty(this.payload())){var asm=bbop.core.get_assemble(this.payload());args="?"+asm}var final_url=qurl+args;var jq_vars={url:final_url,dataType:"json",headers:{"Content-Type":"application/javascript",Accept:"application/javascript"},type:"GET"};if(anchor.use_jsonp()){jq_vars.dataType="jsonp";jq_vars.jsonp=anchor._jsonp_callback}if(anchor.headers()){jq_vars.headers=anchor.headers()}function on_error(xhr,status,error){var response=new anchor._response_handler(null);response.okay(false);response.message(error);response.message_type(status);anchor.apply_callbacks("error",[response,anchor])}function on_success(raw_data,status,xhr){var response=new anchor._response_handler(raw_data);if(response&&response.okay()){anchor.apply_callbacks("success",[response,anchor])}else{if(!response){response=new anchor._response_handler(null);response.okay(false);response.message_type(status);response.message("null response")}else{response.message_type(status);response.message("bad response")}anchor.apply_callbacks("error",[response,anchor])}}jq_vars.success=on_success;jq_vars.error=on_error;anchor.JQ.ajax(jq_vars);return final_url};bbop.rest.manager.jquery_faux_ajax=function(){this._is_a="bbop.rest.manager.jquery_faux_ajax";this.ajax=function(args){return null}};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.golr=="undefined"){bbop.golr={}}bbop.golr.conf_field=function(field_conf_struct){this._is_a="bbop.golr.conf_field";var anchor=this;var logger=new bbop.logger(this._is_a);logger.DEBUG=true;function ll(str){logger.kvetch(str)}this._field=field_conf_struct;this.display_name=function(){return this._field.display_name};this.description=function(){return this._field.description};this.id=function(){return this._field.id};this.searchable=function(){var retval=false;if(this._field.searchable=="true"||this._field.searchable==true){retval=true}return retval};this.required=function(){var retval=false;if(this._field.required=="true"||this._field.required==true){retval=true}return retval};this.is_multi=function(){var retval=false;if(this._field.cardinality=="multi"){retval=true}return retval};this.is_fixed=function(){var retval=false;if(this._field.property_type=="fixed"){retval=true}return retval};this.property=function(){var retval="???";if(this._field.property){retval=this._field.property}return retval}};bbop.golr.conf_class=function(class_conf_struct){this._is_a="bbop.golr.conf_class";var anchor=this;var logger=new bbop.logger(this._is_a);logger.DEBUG=true;function ll(str){logger.kvetch(str)}this._class=class_conf_struct;this.display_name=function(){return this._class.display_name};this.description=function(){return this._class.description};this.weight=function(){return parseInt(this._class.weight)||0};this.id=function(){return this._class.id};this.document_category=function(){return this._class.document_category||this.id()};this.searchable_extension=function(){return"_searchable"};this.get_field=function(fid){var retval=null;if(this._class.fields_hash&&this._class.fields_hash[fid]){retval=new bbop.golr.conf_field(this._class.fields_hash[fid])}return retval};this.get_fields=function(){var retval=[];if(this._class.fields_hash){bbop.core.each(this._class.fields_hash,function(fid,struct){var cf=new bbop.golr.conf_field(struct);retval.push(cf)})}return retval};this._munge_weight_category=function(weight_category){if(!weight_category){throw new Error("Missing weight category")}else{if(weight_category!="boost"&&weight_category!="result"&&weight_category!="filter"){throw new Error("Unknown weight category: "+weight_category)}}return weight_category+"_weights"};this.get_weights=function(weight_category){var rethash={};weight_category=this._munge_weight_category(weight_category);if(!bbop.core.is_defined(this._class[weight_category])){throw new Error("Missing weight category: "+weight_category)}else{var wcs=this._class[weight_category];if(wcs&&wcs!=""&&wcs!=" "){var dfab=wcs;var fields=dfab.split(/\s+/);bbop.core.each(fields,function(item,i){var field_val=item.split(/\^/);rethash[field_val[0]]=parseFloat(field_val[1])})}}return rethash};this.field_order_by_weight=function(weight_category,cutoff){var retset=[];var weights=this.get_weights(weight_category);bbop.core.each(weights,function(key,val){if(cutoff){if(val>=cutoff){retset.push(key)}}else{retset.push(key)}});retset.sort(function(a,b){return weights[b]-weights[a]});return retset}};bbop.golr.conf=function(golr_conf_var){this._is_a="bbop.golr.conf";var anchor=this;var logger=new bbop.logger(this._is_a);logger.DEBUG=true;function ll(str){logger.kvetch(str)}if(!golr_conf_var||typeof golr_conf_var!="object"){ll("ERROR: no proper golr conf var argument")}this._golr_conf=golr_conf_var;this._classes={};bbop.core.each(anchor._golr_conf,function(key,val){var new_asp=new bbop.golr.conf_class(val);anchor._classes[new_asp.id()]=new_asp});this.get_class=function(fid){var retval=null;if(this._classes&&this._classes[fid]){retval=this._classes[fid]}return retval};this.get_classes=function(){var ret=[];bbop.core.each(anchor._classes,function(key,val){ret.push(val)});return ret};this.get_classes_by_weight=function(){var ret=this.get_classes();ret.sort(function(cc1,cc2){var w1=cc1.weight()||0;var w2=cc2.weight()||0;return w2-w1});return ret}};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.golr=="undefined"){bbop.golr={}}bbop.golr.response=function(json_data){this._is_a="bbop.golr.response";this._raw=json_data;this._success=null;this._doc_id2index=null;this._doc_index2_id=null;this._doc_label_maps={};this._hl_regexp=new RegExp("<[^>]*>","g")};bbop.golr.response.prototype.raw=function(){return this._raw};bbop.golr.response.prototype.success=function(){if(this._success==null){var robj=this._raw;if(robj&&robj.responseHeader&&typeof robj.responseHeader.status!="undefined"&&robj.responseHeader.status==0&&robj.responseHeader.params&&robj.response&&typeof robj.response.numFound!="undefined"&&typeof robj.response.start!="undefined"&&typeof robj.response.maxScore!="undefined"&&robj.response.docs&&robj.facet_counts&&robj.facet_counts.facet_fields){this._success=true}else{this._success=false}}return this._success};bbop.golr.response.prototype.callback_type=function(){var robj=this._raw;var retval=null;if(robj.responseHeader.params.callback_type&&typeof robj.responseHeader.params.callback_type!="undefined"){retval=robj.responseHeader.params.callback_type}return retval};bbop.golr.response.prototype.parameters=function(){var robj=this._raw;return robj.responseHeader.params};bbop.golr.response.prototype.parameter=function(key){var robj=this._raw;var retval=null;if(robj.responseHeader.params[key]&&robj.responseHeader.params[key]){retval=robj.responseHeader.params[key]}return retval};bbop.golr.response.prototype.row_step=function(){var robj=this._raw;return parseInt(robj.responseHeader.params.rows)};bbop.golr.response.prototype.total_documents=function(){var robj=this._raw;return parseInt(robj.response.numFound)};bbop.golr.response.prototype.start_document=function(){var robj=this._raw;return parseInt(robj.response.start)+1};bbop.golr.response.prototype.end_document=function(){var robj=this._raw;return this.start_document()+parseInt(robj.response.docs.length)-1};bbop.golr.response.prototype.packet=function(){var robj=this._raw;var retval=null;var pval=robj.responseHeader.params.packet;if(pval){retval=parseInt(pval)}return retval};bbop.golr.response.prototype.paging_p=function(){var robj=this._raw;var retval=false;if(this.total_documents()>this.row_step()){retval=true}return retval};bbop.golr.response.prototype.paging_previous_p=function(){var robj=this._raw;var retval=false;if(this.start_document()>1){retval=true}return retval};bbop.golr.response.prototype.paging_next_p=function(){var robj=this._raw;var retval=false;if(this.total_documents()>this.end_document()){retval=true}return retval};bbop.golr.response.prototype.documents=function(){var robj=this._raw;return robj.response.docs};bbop.golr.response.prototype.get_doc=function(doc_id){var doc=null;var robj=this._raw;var docs=robj.response.docs;if(docs&&docs[doc_id]){doc=docs[doc_id]}else{var local_anchor=this;if(!this._doc_id2index){this._doc_id2index={};this._doc_index2id={};bbop.core.each(docs,function(doc_item,doc_index){var did=doc_item.id;local_anchor._doc_id2index[did]=doc_index;local_anchor._doc_index2id[doc_index]=did})}if(this._doc_id2index&&bbop.core.is_defined(this._doc_id2index[doc_id])){var doc_i=this._doc_id2index[doc_id];doc=docs[doc_i]}}return doc};bbop.golr.response.prototype.get_doc_field=function(doc_id,field_id){var ret=null;var doc=this.get_doc(doc_id);if(doc&&bbop.core.is_defined(doc[field_id])){ret=doc[field_id]}return ret};bbop.golr.response.prototype.get_doc_label=function(doc_id,field_id,item_id){var retval=null;var anchor=this;var doc=this.get_doc(doc_id);if(doc&&bbop.core.is_defined(doc[field_id])){var ilabel=this.get_doc_field(doc_id,field_id+"_label");if(ilabel&&bbop.core.what_is(ilabel)=="string"){retval=ilabel}else{if(ilabel&&bbop.core.what_is(ilabel)=="array"){var iid=this.get_doc_field(doc_id,field_id);if(ilabel.length==1&&iid&&bbop.core.what_is(iid)=="array"&&iid.length==1){retval=ilabel[0]}else{function _map_to_try(doc_key,map_field,item_key){var retlbl=null;var map_str=anchor.get_doc_field(doc_key,map_field);if(map_str&&bbop.core.what_is(map_str)=="string"){if(!bbop.core.is_defined(anchor._doc_label_maps[doc_key])){anchor._doc_label_maps[doc_key]={}}if(!bbop.core.is_defined(anchor._doc_label_maps[doc_key][map_field])){anchor._doc_label_maps[doc_key][map_field]=bbop.json.parse(map_str)}var map=anchor._doc_label_maps[doc_key][map_field];if(map&&map[item_key]){retlbl=map[item_key]}}return retlbl}var mlabel=_map_to_try(doc_id,field_id+"_map",item_id);if(mlabel){retval=mlabel}else{var cmlabel=_map_to_try(doc_id,field_id+"_closure_map",item_id);if(cmlabel){retval=cmlabel}else{var lmlabel=_map_to_try(doc_id,field_id+"_list_map",item_id);if(lmlabel){retval=lmlabel}}}}}}}return retval};bbop.golr.response.prototype.get_doc_highlight=function(doc_id,field_id,item){var ret=null;var robj=this._raw;var hlre=this._hl_regexp;var hilite_obj=null;if(robj.highlighting&&robj.highlighting[doc_id]){hilite_obj=robj.highlighting[doc_id]}else{var iid=this._doc_index2id[doc_id];if(iid){var new_doc=this.get_doc(iid);var new_doc_id=new_doc.id;if(robj.highlighting&&robj.highlighting[new_doc_id]){hilite_obj=robj.highlighting[new_doc_id]}}}if(hilite_obj){var ans=null;if(hilite_obj[field_id+"_label_searchable"]){ans=hilite_obj[field_id+"_label_searchable"]}if(!ans){if(hilite_obj[field_id+"_label"]){ans=hilite_obj[field_id+"_label"]}}if(!ans){if(hilite_obj[field_id+"_searchable"]){ans=hilite_obj[field_id+"_searchable"]}}if(!ans){if(hilite_obj[field_id]){ans=hilite_obj[field_id]}}if(ans){var matches_p=false;bbop.core.each(ans,function(an){if(!matches_p){var stripped=an.replace(hlre,"");if(item==stripped){matches_p=true;ret=an}}})}}return ret};bbop.golr.response.prototype.facet_field_list=function(){var robj=this._raw;return bbop.core.get_keys(robj.facet_counts.facet_fields).sort()};bbop.golr.response.prototype.facet_field=function(facet_name){var robj=this._raw;return robj.facet_counts.facet_fields[facet_name]};bbop.golr.response.prototype.facet_counts=function(){var robj=this._raw;var ret_hash={};var anchor=this;var each=bbop.core.each;var facet_field_list=this.facet_field_list();each(facet_field_list,function(ffield){if(!ret_hash[ffield]){ret_hash[ffield]={}}var facet_field_items=anchor.facet_field(ffield);each(facet_field_items,function(item,index){var name=item[0];var count=item[1];ret_hash[ffield][name]=count})});return ret_hash};bbop.golr.response.prototype.query=function(){var robj=this._raw;var retval=null;if(robj.responseHeader.params&&robj.responseHeader.params.q){retval=robj.responseHeader.params.q}return retval};bbop.golr.response.prototype.query_filters=function(){var robj=this._raw;var ret_hash={};var fq_list=this.parameter("fq");if(fq_list){if(bbop.core.what_is(fq_list)=="string"){fq_list=[fq_list]}var each=bbop.core.each;each(fq_list,function(fq_item){var splits=fq_item.split(":");var field=splits.shift();var value=splits.join(":");var polarity=true;if(field.charAt(0)=="-"){polarity=false;field=field.substring(1,field.length)}else{if(field.charAt(0)=="+"){field=field.substring(1,field.length)}}if(!ret_hash[field]){ret_hash[field]={}}if(value.charAt(0)=='"'&&value.charAt(value.length-1)=='"'){value=value.substring(1,value.length-1)}ret_hash[field][value]=polarity})}return ret_hash};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.golr=="undefined"){bbop.golr={}}bbop.golr.manager=function(golr_loc,golr_conf_obj){bbop.registry.call(this,["prerun","reset","search","error","postrun"]);this._is_a="bbop.golr.manager";var anchor=this;this._logger=new bbop.logger(this._is_a);this._logger.DEBUG=false;function ll(str){anchor._logger.kvetch(str)}var alphanum=new RegExp(/^[a-zA-Z0-9 ]+$/);this.last_sent_packet=0;if(!golr_loc||!golr_conf_obj){ll("ERROR: no proper arguments")}if(typeof golr_loc!="string"){ll("ERROR: no proper golr url string argument")}if(!golr_conf_obj._is_a||!golr_conf_obj._is_a=="bbop.golr.conf"){ll("ERROR: no proper bbop.golr.conf object argument");throw new Error("boink! "+bbop.core.what_is(golr_conf_obj))}this._safety=false;this._solr_url=golr_loc;this._golr_conf=golr_conf_obj;this._batch_urls=[];this._batch_accumulator_func=function(){};this._batch_final_func=function(){};this._excursions=[];this._current_class=null;this.fundamental_query="*:*";this.default_query="*:*";this.query=this.default_query;this.default_fl="*,score";this.current_fl=this.default_fl;this.default_rows=10;this.default_start=0;this.current_rows=this.default_rows;this.current_start=this.default_start;this.default_facet_limit=25;this.current_facet_limit=25;this.current_facet_field_limits={};this.current_facet_offset=25;this.current_facet_field_offsets={};this.query_variants={defType:"edismax",qt:"standard",indent:"on",wt:"json",rows:anchor.current_rows,start:anchor.current_start,fl:anchor.default_fl,facet:"true","facet.mincount":1,"facet.sort":"count","json.nl":"arrarr","facet.limit":anchor.default_facet_limit};this.query_fields={};this.query_filters={};this.facet_fields={};this.debug=function(p){if(p==true||p==false){this._logger.DEBUG=p}return this._logger.DEBUG};this.lite=function(use_lite_p){if(use_lite_p==true||use_lite_p==false){if(use_lite_p==true){var per=anchor.get_personality();if(per){var field_collection={};var loop=bbop.core.each;var union=bbop.core.merge;var ccl=anchor._current_class;loop(["result"],function(cat){field_collection=union(field_collection,ccl.get_weights(cat))});var flist=bbop.core.get_keys(field_collection);loop(flist,function(flist_item){loop(["_label"],function(field_suffix){var new_field=flist_item+field_suffix;var nf_obj=ccl.get_field(new_field);if(nf_obj){flist.push(new_field);if(nf_obj.is_multi()){flist.push(flist_item+"_map")}}})});flist.push("score");flist.push("id");anchor.current_fl=flist.join(",");anchor.set("fl",anchor.current_fl)}}else{anchor.current_fl=anchor.default_fl;anchor.set("fl",anchor.current_fl)}}var retval=false;if(anchor.default_fl!=anchor.current_fl){retval=true}return retval};function _field_to_facet_field(field){return"f."+field+".facet.limit"}this.get_facet_limit=function(field){var retval=null;if(!field){retval=anchor.current_facet_limit}else{var f=_field_to_facet_field(field);var try_val=anchor.current_facet_field_limits[f];if(bbop.core.is_defined(try_val)){retval=try_val}}return retval};this.set_facet_limit=function(arg1,arg2){var retval=false;if(!bbop.core.is_defined(arg2)&&bbop.core.what_is(arg1)=="number"){var nlimit=arg1;anchor.current_facet_limit=nlimit;anchor.set("facet.limit",anchor.current_facet_limit);retval=true}else{if(bbop.core.is_defined(arg1)&&bbop.core.is_defined(arg2)&&bbop.core.what_is(arg1)=="string"&&bbop.core.what_is(arg2)=="number"){var field=_field_to_facet_field(arg1);var limit=arg2;anchor.current_facet_field_limits[field]=limit;retval=true}}return retval};this.set_default_facet_limit=function(lim){var retval=anchor.default_facet_limit;anchor.default_facet_limit=lim;return retval};this.reset_facet_limit=function(field){var retval=false;if(!bbop.core.is_defined(field)){anchor.current_facet_limit=anchor.default_facet_limit;anchor.set("facet.limit",anchor.current_facet_limit);anchor.current_facet_field_limits={};retval=true}else{var f=_field_to_facet_field(field);if(bbop.core.is_defined(anchor.current_facet_field_limits[f])){delete anchor.current_facet_field_limits[f];retval=true}}return retval};this.get_results_count=function(field){return anchor.get("rows")};this.set_results_count=function(count){anchor.set("rows",count);anchor.current_rows=count;return anchor.current_rows};this.reset_results_count=function(){anchor.set("rows",anchor.default_rows);anchor.current_rows=anchor.default_rows;return anchor.current_rows};this.plist_to_property_hash=function(plist){var phash={negative_p:false,sticky_p:false};if(plist){bbop.core.each(plist,function(item){if(item=="+"){phash.negative_p=false}else{if(item=="-"){phash.negative_p=true}else{if(item=="*"){phash.sticky_p=true}else{if(item=="$"){phash.sticky_p=false}}}}})}return phash};this.add_query_filter_as_string=function(filter_string,plist){var f_v=bbop.core.first_split(":",filter_string);var fname=f_v[0];var fval=f_v[1];fval=bbop.core.dequote(fval);var props=plist;var ret={};if(fname!=""&&fval!=""){var lead_char=fname.charAt(0);if(lead_char=="-"||lead_char=="+"){props.push(lead_char);fname=fname.substr(1,fname.length-1)}ret=this.add_query_filter(fname,fval,props)}return ret};this.add_query_filter=function(filter,value,plist){if(!bbop.core.is_defined(this.query_filters[filter])){this.query_filters[filter]={}}this.query_filters[filter][value]=this.plist_to_property_hash(plist);return{}};this.remove_query_filter=function(filter,value,plist){var retval=false;function _full_delete(hash,key1,key2){if(key1&&key2&&hash&&hash[key1]&&hash[key1][key2]){delete hash[key1][key2]}if(bbop.core.is_empty(hash[key1])){delete hash[key1]}}if(filter&&value&&anchor.query_filters[filter]&&anchor.query_filters[filter][value]){if(!plist||bbop.core.is_empty(plist)){_full_delete(anchor.query_filters,filter,value);retval=true}else{var filter_phash=anchor.query_filters[filter][value];var in_phash=anchor.plist_to_property_hash(plist);if(bbop.core.is_same(filter_phash,in_phash)){_full_delete(anchor.query_filters,filter,value);retval=true}}}return retval};this.reset_query_filters=function(){var loop=bbop.core.each;loop(anchor.query_filters,function(filter,values){loop(values,function(value,props){var sticky_p=props.sticky_p;if(!sticky_p){anchor.remove_query_filter(filter,value)}})});return{}};this.get_query_filter_properties=function(filter,value){var retobj=null;var aqf=anchor.query_filters;if(filter&&value&&aqf[filter]&&aqf[filter][value]){retobj={filter:filter,value:value,negative_p:aqf[filter][value]["negative_p"],sticky_p:aqf[filter][value]["sticky_p"]}}return retobj};this.get_query_filters=function(){var retlist=[];var loop=bbop.core.each;loop(anchor.query_filters,function(f,values){loop(values,function(v,props){retlist.push(anchor.get_query_filter_properties(f,v))})});return retlist};this.get_sticky_query_filters=function(){var retlist=[];var loop=bbop.core.each;loop(anchor.query_filters,function(f,values){loop(values,function(v,props){var qfp=anchor.get_query_filter_properties(f,v);if(qfp.sticky_p==true){retlist.push(qfp)}})});return retlist};this.query_extra=null;this._query_encode=function(str_to_encode){var fs1=encodeURI(str_to_encode);var fs2=fs1.replace(/\%2509/g,"%09");var final_encoding=fs2;return final_encoding};this._run_reset_callbacks=function(json_data){ll("run reset callbacks...");var response=new bbop.golr.response(json_data);anchor.apply_callbacks("reset",[response,anchor]);anchor.apply_callbacks("postrun",[response,anchor])};this._run_search_callbacks=function(json_data){ll("run search callbacks...");var response=new bbop.golr.response(json_data);anchor.apply_callbacks("search",[response,anchor]);anchor.apply_callbacks("postrun",[response,anchor])};this._run_error_callbacks=function(json_data){ll("run error callbacks...");var response=new bbop.golr.response(json_data);anchor.apply_callbacks("error",[response,anchor]);anchor.apply_callbacks("postrun",[response,anchor])};this.filter_list_to_assemble_hash=function(flist){var h={};bbop.core.each(flist,function(filter_property){var filter=filter_property.filter;var value=filter_property.value;var negative_p=filter_property.negative_p;if(negative_p){filter="-"+filter}if(!bbop.core.is_defined(h[filter])){h[filter]=[]}h[filter].push(value)});return h};this.sensible_query_p=function(qfs){var retval=false;var q=anchor.get_query();var qf=anchor.query_field_set();if(q&&q.length>=3&&qf&&!bbop.core.is_empty(qf)){retval=true}return retval};this.last_packet_sent=function(){return anchor.last_sent_packet};this.clear=function(){anchor.query=anchor.default_query;anchor.reset_query_filters()};this.reset=function(){return anchor.update("reset")};this.search=function(){return anchor.update("search")};this.page=function(rows,start){anchor.set("rows",rows);anchor.set("start",start);return anchor.update("search",rows,start)};this.page_first=anchor.search;this.page_previous=function(){var do_rows=anchor.get_page_rows();var do_offset=anchor.get_page_start()-do_rows;return anchor.page(do_rows,do_offset)};this.page_next=function(){var do_rows=anchor.get_page_rows();var do_offset=anchor.get_page_start()+do_rows;return anchor.page(do_rows,do_offset)};this.page_last=function(total_document_count){var do_rows=anchor.get_page_rows();var mod=total_document_count%do_rows;var do_offset=total_document_count-mod;var ret=null;if(mod==0){ret=anchor.page(do_rows,do_offset-do_rows)}else{ret=anchor.page(do_rows,do_offset)}return ret};this.get_page_rows=function(){return anchor.get("rows")};this.get_page_start=function(){return anchor.get("start")};this.add_query_field=function(qf,boost){var retval=false;if(!bbop.core.is_defined(boost)){boost=1}if(!bbop.core.is_defined(anchor.query_fields[qf])){retval=true}anchor.query_fields[qf]=boost;return retval};this.query_field_set=function(qfs){var loop=bbop.core.each;var cclass=anchor._current_class;if(qfs){if(cclass){var s_ext="_searchable";var searchable_qfs={};loop(qfs,function(filter,value){var cfield=cclass.get_field(filter);if(cfield&&cfield.searchable()){var new_f=filter+s_ext;searchable_qfs[new_f]=value}else{searchable_qfs[filter]=value}});qfs=searchable_qfs}anchor.query_fields=qfs}var output_format=[];loop(anchor.query_fields,function(filter,value){output_format.push(filter+"^"+value)});return output_format};this.facets=function(list_or_key){if(list_or_key){if(bbop.core.what_is(list_or_key)!="array"){list_or_key=[list_or_key]}else{anchor.facet_fields={}}bbop.core.each(list_or_key,function(item){anchor.facet_fields[item]=true})}return bbop.core.get_keys(anchor.facet_fields)};this.set_default_query=function(new_default_query){anchor.default_query=new_default_query;return anchor.default_query};this.reset_default_query=function(){anchor.default_query=anchor.fundamental_query;return anchor.default_query};this.set_query=function(new_query){anchor.query=new_query;return anchor.query};this.set_comfy_query=function(new_query){var comfy_query=new_query;if(new_query&&new_query.length&&new_query.length>0){var has_cursor_p=true;if(new_query.slice(-1)===" "){has_cursor_p=false}new_query=bbop.core.chomp(new_query);if(new_query&&new_query.length&&new_query.length>0){if(alphanum.test(new_query)&&has_cursor_p){var tokens=new_query.split(new RegExp("\\s+"));var last_token=tokens[tokens.length-1];if(tokens.length==1){if(last_token.length>=3){tokens[tokens.length-1]=last_token+"*"}}else{tokens[tokens.length-1]=last_token+"*"}comfy_query=tokens.join(" ")}}}return anchor.set_query(comfy_query)};this.set_id=function(new_id){anchor.query="id:"+bbop.core.ensure(new_id,'"');return anchor.query};function _lock_map(field,id_list){var fixed_list=[];bbop.core.each(id_list,function(item){fixed_list.push(bbop.core.ensure(item,'"'))});var base_id_list="("+fixed_list.join(" OR ")+")";var ret_query=field+":"+base_id_list;return ret_query}this.set_ids=function(id_list){anchor.query=_lock_map("id",id_list);return anchor.query};this.set_targets=function(id_list,field_list){var fixed_list=[];bbop.core.each(field_list,function(field){fixed_list.push(_lock_map(field,id_list))});var sum=fixed_list.join(" OR ");anchor.query=sum;return anchor.query};this.get_query=function(){return anchor.query};this.get_default_query=function(){return anchor.default_query};this.get_fundamental_query=function(){return anchor.fundamental_query};this.get_query=function(){return anchor.query};this.reset_query=function(){anchor.query=anchor.default_query;ll("reset query to default: "+anchor.query);return anchor.query};this.set_extra=function(new_extra){anchor.query_extra=new_extra;return anchor.query_extra};this.get_extra=anchor.set_extra;this.remove_extra=function(){anchor.query_extra="";return anchor.query_extra};this.set=function(key,new_val){anchor.query_variants[key]=new_val};this.get=function(key){return anchor.query_variants[key]};this.unset=function(key){var retval=false;if(bbop.core.is_defined(anchor.query_variants[key])){retval=true;delete anchor.query_variants[key]}return retval};this.include_highlighting=function(hilite_p,html_elt_str){var retval=false;if(bbop.core.is_defined(hilite_p)&&(hilite_p==true||hilite_p==false)){if(hilite_p==true){if(!html_elt_str){html_elt_str='<em class="hilite">'}anchor.set("hl","true");anchor.set("hl.simple.pre",html_elt_str);retval=html_elt_str}else{anchor.unset("hl");anchor.unset("hl.simple.pre")}}else{var cl_tmp=anchor.get("hl.simple.pre");if(bbop.core.is_defined(cl_tmp)){retval=cl_tmp}}return retval};this.set_personality=function(personality_id){var retval=false;var cclass=anchor._golr_conf.get_class(personality_id);if(cclass){this._current_class=cclass;anchor.facets(cclass.field_order_by_weight("filter"));anchor.query_field_set(cclass.get_weights("boost"));retval=true}return retval};this.get_personality=function(){var retval=null;if(bbop.core.is_defined(anchor._current_class)&&bbop.core.what_is(anchor._current_class)=="bbop.golr.conf_class"){retval=anchor._current_class.id()}return retval};this.get_query_url=function(){var qurl=anchor._solr_url+"select?";var assemf=anchor.get_query_filters();var fq=anchor.filter_list_to_assemble_hash(assemf);var things_to_add=[bbop.core.get_assemble(anchor.query_variants),bbop.core.get_assemble(anchor.current_facet_field_limits),bbop.core.get_assemble({fq:fq}),bbop.core.get_assemble({"facet.field":bbop.core.get_keys(anchor.facet_fields)}),bbop.core.get_assemble({q:anchor.query}),anchor.query_extra];if(anchor.query&&anchor.query.length&&anchor.query.length!=0&&anchor.query!=anchor.fundamental_query){var in_qf=bbop.core.get_assemble({qf:anchor.query_field_set()});things_to_add.push(in_qf)}var filtered_things=bbop.core.pare(things_to_add,function(item,index){var retval=true;if(item&&item!=""){retval=false}return retval});var final_qurl=qurl+filtered_things.join("&");final_qurl=anchor._query_encode(final_qurl);ll("qurl: "+final_qurl);return final_qurl};this.push_excursion=function(){var now={data_url:anchor.get_query_url(),session:{sticky_filters:anchor.get_sticky_query_filters()}};anchor._excursions.push(now);return anchor._excursions.length};this.pop_excursion=function(){var retval=false;var then=anchor._excursions.pop();if(then){retval=true;var then_data_url=then.data_url;anchor.load_url(then_data_url);var then_session_stickies=then.session["sticky_filters"];bbop.core.each(then_session_stickies,function(sticky){var flt=sticky.filter;var fvl=sticky.value;var fpl=[];if(sticky.negative_p==true){fpl.push("-")}if(sticky.sticky_p==true){fpl.push("*")}anchor.add_query_filter(flt,fvl,fpl)})}return retval};this.get_download_url=function(field_list,in_arg_hash){anchor.push_excursion();var default_hash={rows:1000,encapsulator:"",separator:"%09",header:"false",mv_separator:"|",entity_list:[]};var arg_hash=bbop.core.fold(default_hash,in_arg_hash);anchor.set("wt","csv");anchor.set("start",0);anchor.set("fl",field_list.join(","));anchor.set("rows",arg_hash.rows);anchor.set("csv.encapsulator",arg_hash.encapsulator);anchor.set("csv.separator",arg_hash.separator);anchor.set("csv.header",arg_hash.header);anchor.set("csv.mv.separator",arg_hash.mv_separator);var entity_list=arg_hash.entity_list;if(bbop.core.is_defined(entity_list)&&bbop.core.is_array(entity_list)&&entity_list.length>0){anchor.set_ids(entity_list)}var returl=anchor.get_query_url();anchor.pop_excursion();return returl};this.get_filter_query_string=function(){var q=anchor.get_query();var filters=anchor.get_query_filters();var std_filters=[];var sticky_filters=[];bbop.core.each(filters,function(filter){if(filter.sticky_p){sticky_filters.push(filter)}else{std_filters.push(filter)}});var fq=anchor.filter_list_to_assemble_hash(std_filters);var sfq=anchor.filter_list_to_assemble_hash(sticky_filters);var things_to_add=[];if(q){things_to_add.push(bbop.core.get_assemble({q:q}))}if(!bbop.core.is_empty(fq)){things_to_add.push(bbop.core.get_assemble({fq:fq}))}if(!bbop.core.is_empty(sfq)){things_to_add.push(bbop.core.get_assemble({sfq:sfq}))}var final_qstr=things_to_add.join("&");final_qstr=anchor._query_encode(final_qstr);return final_qstr};this.get_state_url=function(){anchor.push_excursion();anchor.set("personality",anchor.get_personality());var sticky_filters=anchor.get_sticky_query_filters();var sfq=anchor.filter_list_to_assemble_hash(sticky_filters);anchor.set("sfq",sfq);var returl=anchor.get_query_url();anchor.pop_excursion();return returl};this.load_url=function(url){var loop=bbop.core.each;var decoded_url=decodeURI(url);var in_params=bbop.core.url_parameters(decoded_url);var seen_params={};loop(in_params,function(ip){var key=ip[0];var val=ip[1];if(key=="personality"&&val&&val!=""){anchor.set_personality(val)}seen_params[key]=true});var sticky_cache={};loop(in_params,function(ip){var key=ip[0];var val=ip[1];if(bbop.core.is_defined(val)&&val!=""){if(key=="personality"){}else{if(key=="q"){anchor.set_query(val)}else{if(key=="fq"||key=="sfq"){var fnv=bbop.core.first_split(":",val);var fname=fnv[0];var fval=fnv[1];if(fname&&fval){var plist=[];var lead_char=fname.charAt(0);if(lead_char=="-"||lead_char=="+"){plist.push(lead_char);fname=fname.substr(1,fname.length-1)}fval=bbop.core.dequote(fval);var skey=fname+"^"+fval;if(key=="sfq"){sticky_cache[skey]=true;plist.push("*")}if(!bbop.core.is_defined(sticky_cache[skey])||key=="sfq"){anchor.add_query_filter(fname,fval,plist)}}}else{if(key=="qf"){var foo=bbop.core.first_split("^",val);anchor.add_query_field(foo[0],foo[1])}else{if(key=="facet.field"){anchor.facets(val)}else{if(key=="start"||key=="rows"){if(bbop.core.what_is(val)=="string"){val=parseFloat(val)}anchor.set(key,val)}else{anchor.set(key,val)}}}}}}}});loop(anchor.query_variants,function(key,val){if(!bbop.core.is_defined(seen_params[key])){anchor.unset(key)}});var curr_url=anchor.get_query_url();var curr_params=bbop.core.url_parameters(curr_url);var differences=0;if(in_params.length==curr_params.length){loop(in_params,function(in_p,i){var curr_p=curr_params[i];if(in_p.length==curr_p.length){if(in_p.length==1){if(in_p[0]==curr_p[0]){}else{differences++}}else{if(in_p.length==2){if(in_p[0]==curr_p[0]&&in_p[1]==curr_p[1]){}else{differences++}}}}else{differences++}})}else{differences++}var retval=false;if(differences==0){retval=true}return retval};this.add_to_batch=function(){var qurl=anchor.get_query_url();anchor._batch_urls.push(qurl);return qurl};this.batch_urls=function(){return anchor._batch_urls};this.next_batch_url=function(){return anchor._batch_urls.shift()||null};this.reset_batch=function(){var num=anchor._batch_urls.length;anchor._batch_urls=[];return num}};bbop.core.extend(bbop.golr.manager,bbop.registry);bbop.golr.manager.prototype.to_string=function(){return"<"+this._is_a+">"};bbop.golr.manager.prototype.update=function(callback_type,rows,start){if(!bbop.core.is_defined(rows)||!bbop.core.is_defined(start)){this.set("rows",this.current_rows);this.set("start",this.current_start)}this.last_sent_packet=this.last_sent_packet+1;var update_query_variants={packet:this.last_sent_packet,callback_type:callback_type};var update_qv=bbop.core.get_assemble(update_query_variants);var qurl=null;if(callback_type=="reset"){this.reset_query();this.reset_query_filters();qurl=this.get_query_url();qurl=qurl+"&"+update_qv}else{if(callback_type=="search"){qurl=this.get_query_url();qurl=qurl+"&"+update_qv}else{throw new Error("Unknown callback_type: "+callback_type)}}this.apply_callbacks("prerun",[this]);return qurl};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.golr=="undefined"){bbop.golr={}}if(typeof bbop.golr.manager=="undefined"){bbop.golr.manager={}}bbop.golr.manager.preload=function(golr_loc,golr_conf_obj){bbop.golr.manager.call(this,golr_loc,golr_conf_obj);this._is_a="bbop.golr.manager.preload";this._bgm_load=null};bbop.core.extend(bbop.golr.manager.preload,bbop.golr.manager);bbop.golr.manager.preload.prototype.load=function(thing){this._bgm_load=thing};bbop.golr.manager.preload.prototype.update=function(callback_type,rows,start){var parent_update=bbop.golr.manager.prototype.update;var qurl=parent_update.call(this,callback_type,rows,start);var logger=new bbop.logger(this._is_a);logger.DEBUG=true;function ll(str){logger.kvetch(str)}var json_data=this._bgm_load;if(bbop.core.is_defined(json_data)){var response=new bbop.golr.response(json_data);this.apply_callbacks(callback_type,[response,this])}else{this.apply_callbacks("error",["unparsable json data",this])}return qurl};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.golr=="undefined"){bbop.golr={}}if(typeof bbop.golr.manager=="undefined"){bbop.golr.manager={}}bbop.golr.manager.jquery=function(golr_loc,golr_conf_obj){bbop.golr.manager.call(this,golr_loc,golr_conf_obj);this._is_a="bbop.golr.manager.jquery";var anchor=this;function ll(str){anchor._logger.kvetch(str)}anchor.JQ=new bbop.golr.faux_ajax();try{if(typeof(jQuery)!=="undefined"){anchor.JQ=jQuery.noConflict()}}catch(x){}finally{var got=bbop.core.what_is(anchor.JQ);if(got&&got=="bbop.golr.faux_ajax"){}else{got="jQuery"}ll("Using "+got+" for Ajax calls.")}anchor.jq_vars={type:"POST",dataType:"jsonp",jsonp:"json.wrf"};this._run_error_callbacks=function(result,status,error){ll("Failed server request: "+result+", "+status+", "+error);var clean_error="unknown error";var jreq=result.responseText;var req=anchor.JQ.parseJSON(jreq);if(req&&req.errors&&req.errors.length>0){var in_error=req.errors[0];ll("ERROR:"+in_error);var reg=new RegExp("\n+","g");var clean_error_split=in_error.split(reg);clean_error=clean_error_split[0]}else{if(bbop.core.what_is(error)=="string"&&error.length>0){clean_error=error}else{if(bbop.core.what_is(status)=="string"&&status.length>0){clean_error=status}}}ll("run error callbacks...");anchor.apply_callbacks("error",[clean_error,anchor])};this._callback_type_decider=function(json_data){ll("in callback type decider...");var response=new bbop.golr.response(json_data);if(!response.success()){throw new Error("Unsuccessful response from golr server!")}else{var cb_type=response.callback_type();ll("okay response from server, will probe type...: "+cb_type);if(cb_type=="reset"){anchor._run_reset_callbacks(json_data)}else{if(cb_type=="search"){anchor._run_search_callbacks(json_data)}else{throw new Error("Unknown callback type!")}}}};this.safety=function(safety_on_p){if(bbop.core.is_defined(safety_on_p)){anchor._safety=safety_on_p}return anchor._safety}};bbop.core.extend(bbop.golr.manager.jquery,bbop.golr.manager);bbop.golr.manager.jquery.prototype.update=function(callback_type,rows,start){var parent_update=bbop.golr.manager.prototype.update;var qurl=parent_update.call(this,callback_type,rows,start);if(!this.safety()){this.jq_vars.success=this._callback_type_decider;this.jq_vars.error=this._run_error_callbacks;this.JQ.ajax(qurl,this.jq_vars)}return qurl};bbop.golr.manager.jquery.prototype.run_batch=function(accumulator_func,final_func){var anchor=this;if(accumulator_func){this._batch_accumulator_func=accumulator_func}if(final_func){this._batch_final_func=final_func}var qurl=anchor.next_batch_url();if(qurl){var next_cycle=function(json_data){var response=new bbop.golr.response(json_data);anchor._batch_accumulator_func.apply(anchor,[response,anchor]);anchor.run_batch()};anchor.jq_vars.success=next_cycle;anchor.jq_vars.error=anchor._run_error_callbacks;anchor.JQ.ajax(qurl,anchor.jq_vars)}else{anchor._batch_final_func.apply(anchor)}};bbop.golr.manager.jquery.prototype.fetch=function(run_func){var anchor=this;var qurl=anchor.get_query_url();anchor._run_func=run_func;anchor.jq_vars.success=function(json_data){var response=new bbop.golr.response(json_data);anchor._run_func(response)};anchor.jq_vars.error=anchor._run_error_callbacks;anchor.JQ.ajax(qurl,anchor.jq_vars)};bbop.golr.faux_ajax=function(){this._is_a="bbop.golr.faux_ajax";this.ajax=function(args){return null};this.parseJSON=function(args){return""}};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.golr=="undefined"){bbop.golr={}}if(typeof bbop.golr.manager=="undefined"){bbop.golr.manager={}}bbop.golr.manager.rhino=function(golr_loc,golr_conf_obj){bbop.golr.manager.call(this,golr_loc,golr_conf_obj);this._is_a="bbop.golr.manager.rhino"};bbop.core.extend(bbop.golr.manager.rhino,bbop.golr.manager);bbop.golr.manager.rhino.prototype.update=function(callback_type,rows,start){var parent_update=bbop.golr.manager.prototype.update;var qurl=parent_update.call(this,callback_type,rows,start);var logger=new bbop.logger(this._is_a);logger.DEBUG=true;function ll(str){logger.kvetch(str)}var raw=readUrl(qurl);var json_data=null;if(raw&&raw!=""){json_data=JSON.parse(raw);if(json_data){var response=new bbop.golr.response(json_data);this.apply_callbacks(callback_type,[response,this])}else{this.apply_callbacks("error",["unparsable data",this])}}else{this.apply_callbacks("error",["no data",this])}return qurl};bbop.golr.manager.rhino.prototype.fetch=function(){var qurl=this.get_query_url();var raw=readUrl(qurl);var json_data=null;var retval=null;if(raw&&raw!=""){json_data=JSON.parse(raw);if(json_data){var response=new bbop.golr.response(json_data);retval=response}}return retval};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.golr=="undefined"){bbop.golr={}}if(typeof bbop.golr.manager=="undefined"){bbop.golr.manager={}}bbop.golr.manager.ringo=function(golr_loc,golr_conf_obj){bbop.golr.manager.call(this,golr_loc,golr_conf_obj);this._is_a="bbop.golr.manager.ringo";this._http_client=require("ringo/httpclient")};bbop.core.extend(bbop.golr.manager.ringo,bbop.golr.manager);bbop.golr.manager.ringo.prototype.update=function(callback_type,rows,start){var parent_update=bbop.golr.manager.prototype.update;var qurl=parent_update.call(this,callback_type,rows,start);var anchor=this;anchor._callbacker=function(data,status,contentType,exchange){var raw_str=exchange.content;var json_data=null;if(raw_str&&raw_str!=""){json_data=JSON.parse(raw_str);if(json_data){var response=new bbop.golr.response(json_data);anchor.apply_callbacks(callback_type,[response,this])}else{this.apply_callbacks("error",["unparsable data",this])}}else{this.apply_callbacks("error",["no data",this])}};var exchange=this._http_client.get(qurl,null,anchor._callbacker);return qurl};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.golr=="undefined"){bbop.golr={}}if(typeof bbop.golr.manager=="undefined"){bbop.golr.manager={}}bbop.golr.manager.nodejs=function(golr_loc,golr_conf_obj){bbop.golr.manager.call(this,golr_loc,golr_conf_obj);this._is_a="bbop.golr.manager.nodejs"};bbop.core.extend(bbop.golr.manager.nodejs,bbop.golr.manager);bbop.golr.manager.nodejs.prototype.update=function(callback_type,rows,start){var parent_update=bbop.golr.manager.prototype.update;var qurl=parent_update.call(this,callback_type,rows,start);var logger=new bbop.logger(this._is_a);logger.DEBUG=true;function ll(str){logger.kvetch(str)}var anchor=this;this.last=null;function on_error(e){console.log("problem with request: "+e.message)}function on_connect(res){res.setEncoding("utf8");var raw_data="";res.on("data",function(chunk){raw_data=raw_data+chunk});res.on("end",function(){var json_data=JSON.parse(raw_data);anchor.last=json_data;var response=new bbop.golr.response(json_data);anchor.apply_callbacks(callback_type,[response,anchor])})}var http=require("http");var req=http.request(qurl,on_connect);req.on("error",on_error);req.end();return qurl};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}if(typeof bbop.widget.display=="undefined"){bbop.widget.display={}}bbop.widget.display.clickable_object=function(label,source,id){if(!label){label=""}if(!source){source=""}var args={};if(id){args.id=id}else{args.generate_id=true}var obj=null;if(source==""){obj=new bbop.html.span(label,args)}else{args.src=source;args.title=label;obj=new bbop.html.image(args)}return obj};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}if(typeof bbop.widget.display=="undefined"){bbop.widget.display={}}bbop.widget.display.text_button_sim=function(label,title,id,add_attrs){if(!label){label="X"}if(!title){title="X"}if(!add_attrs){add_attrs={}}var args={"class":"bbop-js-text-button-sim",title:title};if(id){args.id=id}else{args.generate_id=true}args=bbop.core.merge(args,add_attrs);var obj=new bbop.html.span(label,args);return obj};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}if(typeof bbop.widget.display=="undefined"){bbop.widget.display={}}if(typeof bbop.widget.display.button_templates=="undefined"){bbop.widget.display.button_templates={}}bbop.widget.display.button_templates.field_download=function(label,count,fields){var dl_props={entity_list:null,rows:count};var field_download_button={label:label,diabled_p:false,click_function_generator:function(manager,results_table){return function(event){var dialog_props={title:"Download",buttons:{Download:function(){dl_props.entity_list=results_table.get_selected_items();var raw_gdl=manager.get_download_url(fields,dl_props);window.open(raw_gdl,"_blank");jQuery(this).remove()},Cancel:function(){jQuery(this).remove()}}};new bbop.widget.dialog("<h4>Download (up to "+count+")</h4><p>You may download up to "+count+" lines in a new window. If your request is large or if the the server busy, this may take a while to complete--please be patient.</p>",dialog_props)}}};return field_download_button};bbop.widget.display.button_templates.restmark=function(linker){var bookmark_button={label:"Show URL/bookmark",diabled_p:false,text_p:false,icon:"ui-icon-link",click_function_generator:function(manager){return function(event){var raw_restmark=manager.get_filter_query_string();var restmark_anchor='<a href="?'+raw_restmark+'">this search</a>';new bbop.widget.dialog("<p>Bookmark for: "+restmark_anchor+".</p><p>Please be aware that <strong>this bookmark does not save properties</strong> like currently selected items.</p><p>The AmiGO 2 bookmarking method may change in the future: at this point, <strong>it is intended as a temporary method</strong> (days, not weeks or months) of allowing the reruning of searches using a link.</p>",{title:"Bookmark"})}}};return bookmark_button};bbop.widget.display.button_templates.bookmark=function(linker){var bookmark_button={label:"Show URL/bookmark",diabled_p:false,text_p:false,icon:"ui-icon-link",click_function_generator:function(manager){return function(event){var raw_bookmark=manager.get_state_url();var curr_personality=manager.get_personality();var a_args={id:encodeURIComponent(raw_bookmark),label:"this search"};new bbop.widget.dialog("<p>Bookmark for: "+linker.anchor(a_args,"search",curr_personality)+"</p><p>Please be aware that <strong>this bookmark does not save properties</strong> like currently selected items.</p><p>The AmiGO 2 bookmarking method may change in the future: at this point, <strong>it is intended as a temporary method</strong> (days, not weeks or months) of allowing the reruning of searches using a link.</p>",{title:"Bookmark"})}}};return bookmark_button};bbop.widget.display.button_templates.send_fields_to_galaxy=function(label,count,fields,galaxy){var dl_props={entity_list:null,rows:count};var galaxy_button={label:label,diabled_p:false,text_p:false,icon:"ui-icon-mail-closed",click_function_generator:function(manager){return function(event){if(!galaxy||galaxy==""){alert("Sorry: could not find a usable Galaxy.")}else{var bval="1 field";if(fields&&fields.length>1){bval=fields.length+" fields"}var input_su=new bbop.html.input({name:"submit",type:"submit",value:bval});var input_um=new bbop.html.input({name:"URL_method",type:"hidden",value:"get"});dl_props.entity_list=manager.get_selected_items();var raw_gdl=manager.get_download_url(fields,dl_props);var input_url=new bbop.html.input({name:"URL",type:"hidden",value:raw_gdl});var form=new bbop.html.tag("form",{id:"galaxyform",name:"galaxyform",method:"POST",target:"_blank",action:galaxy},[input_su,input_um,input_url]);new bbop.widget.dialog("Export to Galaxy: "+form.to_string())}}}};return galaxy_button};bbop.widget.display.button_templates.open_facet_matrix=function(gconf,instance_data){var loop=bbop.core.each;var facet_matrix_button={label:"Use a matrix to compare document counts for two facets (limit 50 on each axis).",diabled_p:false,text_p:false,icon:"ui-icon-calculator",click_function_generator:function(manager){return function(event){var pers=manager.get_personality();var class_conf=gconf.get_class(pers);if(class_conf){var filter_list=class_conf.field_order_by_weight("filter");var facet_list_1=[];loop(filter_list,function(filter_id,findex){var cf=class_conf.get_field(filter_id);var cname=cf.display_name();var cid=cf.id();var pset=[cname,cid];if(findex==0){pset.push(true)}facet_list_1.push(pset)});var facet_list_2=bbop.core.clone(facet_list_1);var lss_args={title:"Select facets to compare",blurb:"This dialog will launch you into a tool in another window where you can examine the document counts for two selected facets in a matrix (grid) view.",list_of_lists:[facet_list_1,facet_list_2],title_list:["Facet 1","Facet 2"],action:function(selected_args){var f1=selected_args[0]||"";var f2=selected_args[1]||"";var jmp_state=manager.get_state_url();var mngr=encodeURIComponent(jmp_state);var jump_url=instance_data.app_base()+"/facet_matrix?"+["facet1="+f1,"facet2="+f2,"manager="+mngr].join("&");window.open(jump_url,"_blank")}};new bbop.widget.list_select_shield(lss_args)}}}};return facet_matrix_button};bbop.widget.display.button_templates.flexible_download=function(label,count,start_fields,personality,gconf){var dl_props={entity_list:null,rows:count};var loop=bbop.core.each;var hashify=bbop.core.hashify;var flexible_download_button={label:label,diabled_p:false,text_p:false,icon:"ui-icon-circle-arrow-s",click_function_generator:function(manager){return function(event){var class_conf=gconf.get_class(personality);if(class_conf){var start_hash=hashify(start_fields);var start_list=[];loop(start_fields,function(field_id,field_index){var cf=class_conf.get_field(field_id);var cname=cf.display_name();var cid=cf.id();var pset=[cname,cid];start_list.push(pset)});var pool_list=[];var all_fields=class_conf.get_fields();loop(all_fields,function(field,field_index){var field_id=field.id();if(start_hash[field_id]){}else{var cname=field.display_name();var cid=field.id();var pset=[cname,cid];pool_list.push(pset)}});pool_list.sort(function(a,b){var av=a[0];var bv=b[0];var val=0;if(av<bv){return -1}else{if(av>bv){return 1}}return val});var dss_args={title:"Select the fields to download (up to "+count+")",blurb:"<p><strong>Drag and drop</strong> the desired fields <strong>from the left</strong> column (available pool) <strong>to the right</strong> (selected fields). You may also reorder them.</p><p>Download up to "+count+" lines in a new window by clicking <strong>Download</strong>. If your request is large or if the the server busy, this may take a while to complete--please be patient.</p>",pool_list:pool_list,selected_list:start_list,action_label:"Download",action:function(selected_items){dl_props.entity_list=manager.get_selected_items();var raw_gdl=manager.get_download_url(selected_items,dl_props);window.open(raw_gdl,"_blank")}};new bbop.widget.drop_select_shield(dss_args)}}}};return flexible_download_button};bbop.widget.display.button_templates.flexible_download_b3=function(label,count,start_fields,personality,gconf){var dl_props={entity_list:null,rows:count};var loop=bbop.core.each;var hashify=bbop.core.hashify;var flexible_download_button={label:label,diabled_p:false,click_function_generator:function(results_table,manager){return function(event){var class_conf=gconf.get_class(personality);if(class_conf){var start_hash=hashify(start_fields);var start_list=[];loop(start_fields,function(field_id,field_index){var cf=class_conf.get_field(field_id);var cname=cf.display_name();var cid=cf.id();var pset=[cname,cid];start_list.push(pset)});var pool_list=[];var all_fields=class_conf.get_fields();loop(all_fields,function(field,field_index){var field_id=field.id();if(start_hash[field_id]){}else{var cname=field.display_name();var cid=field.id();var pset=[cname,cid];pool_list.push(pset)}});pool_list.sort(function(a,b){var av=a[0];var bv=b[0];var val=0;if(av<bv){return -1}else{if(av>bv){return 1}}return val});var dss_args={title:"Select the fields to download (up to "+count+")",blurb:"<p><strong>Drag and drop</strong> the desired fields <strong>from the left</strong> column (available pool) <strong>to the right</strong> (selected fields). You may also reorder them.</p><p>Download up to "+count+" lines in a new window by clicking <strong>Download</strong>. If your request is large or if the the server busy, this may take a while to complete--please be patient.</p>",pool_list:pool_list,selected_list:start_list,action_label:"Download",action:function(selected_items){dl_props.entity_list=null;if(!bbop.core.is_empty(results_table)){dl_props.entity_list=results_table.get_selected_items()}var raw_gdl=manager.get_download_url(selected_items,dl_props);window.open(raw_gdl,"_blank")}};new bbop.widget.drop_select_shield(dss_args)}}}};return flexible_download_button};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}if(typeof bbop.widget.display=="undefined"){bbop.widget.display={}}bbop.widget.display.results_table_by_class=function(cclass,golr_resp,linker,handler,elt_id,selectable_p){var logger=new bbop.logger();logger.DEBUG=false;function ll(str){logger.kvetch("RTBCC: "+str)}var each=bbop.core.each;var is_defined=bbop.core.is_defined;var display_context="bbop.widgets.search_pane";var ea_regexp=new RegExp("</a>","i");var br_regexp=new RegExp("<br />","i");var add_selectable_p=false;var select_column_id=null;var select_item_name=null;if(is_defined(selectable_p)&&selectable_p==true){add_selectable_p=true;var local_mangle=bbop.core.uuid();select_column_id="rtbcc_select_"+local_mangle;select_item_name="rtbcc_select_name_"+local_mangle}this.item_name=function(){return select_item_name};this.toggle_id=function(){return select_column_id};var trim_hash={};var trimit=100;function _trim_and_store(in_str){var retval=in_str;if(retval.length>(trimit+50)){var list_p=br_regexp.test(retval);var anchors_p=ea_regexp.test(retval);var tease=null;if(!anchors_p&&!list_p){tease=new bbop.html.span(bbop.core.crop(retval,trimit,""),{generate_id:true})}else{if(anchors_p&&!list_p){}else{var new_str_list=retval.split(br_regexp);if(new_str_list.length<=3){}else{var new_str="";new_str=new_str+new_str_list.shift();new_str=new_str+"<br />";new_str=new_str+new_str_list.shift();tease=new bbop.html.span(new_str,{generate_id:true})}}}if(tease){var bgen=bbop.widget.display.text_button_sim;var more_b=new bgen("more...","Display the complete list");var full=new bbop.html.span(retval,{generate_id:true});var less_b=new bgen("less","Display the truncated list");var tease_id=tease.get_id();var more_b_id=more_b.get_id();var full_id=full.get_id();var less_b_id=less_b.get_id();trim_hash[tease_id]=[tease_id,more_b_id,full_id,less_b_id];retval=tease.to_string()+" "+more_b.to_string()+" "+full.to_string()+" "+less_b.to_string()}}return retval}function _create_select_box(val,id,name){if(!is_defined(name)){name=select_item_name}var input_attrs={value:val,name:name,type:"checkbox"};if(is_defined(id)){input_attrs.id=id}var input=new bbop.html.input(input_attrs);return input}var headers=[];var headers_display=[];if(add_selectable_p){headers.push(select_column_id);var hinp=_create_select_box("",select_column_id,"");headers_display.push(hinp.to_string())}var results_order=cclass.field_order_by_weight("result");each(results_order,function(fid){headers.push(fid);var field=cclass.get_field(fid);if(!field){throw new Error("conf error: not found:"+fid)}var fdname=field.display_name();var fdesc=field.description()||"???";var head_span_attrs={"class":"bbop-js-ui-hoverable",title:fdesc};var head_span=new bbop.html.span(fdname,head_span_attrs);headers_display.push(head_span.to_string())});function _process_entry(fid,iid,doc){var retval="";var did=doc.id;var ilabel=golr_resp.get_doc_label(did,fid,iid);if(!ilabel){ilabel=iid}var hl=golr_resp.get_doc_highlight(did,fid,ilabel);var ilink=linker.anchor({id:iid,label:ilabel,hilite:hl},fid);ll("processing: "+[fid,ilabel,iid].join(", "));if(ilink){retval=ilink}else{if(ilabel){retval=ilabel}else{retval=iid}}return retval}var table_buff=[];var docs=golr_resp.documents();each(docs,function(doc){var entry_buff=[];each(headers,function(fid){if(fid==select_column_id){var did=doc.id;var dinp=_create_select_box(did);entry_buff.push(dinp.to_string())}else{if(fid=="score"){var score=doc.score||0;score=bbop.core.to_string(100*score);entry_buff.push(bbop.core.crop(score,4)+"%")}else{var field=cclass.get_field(fid);var bits=[];if(doc[fid]){if(field.is_multi()){bits=doc[fid]}else{bits=[doc[fid]]}}var tmp_buff=[];each(bits,function(bit){ll("! B:"+bit+", F:"+fid+", D:"+display_context);var out=handler.dispatch(bit,fid,display_context);if(is_defined(out)&&out!=null){tmp_buff.push(out)}else{out=_process_entry(fid,bit,doc);tmp_buff.push(out)}});var joined=tmp_buff.join("<br />");entry_buff.push(_trim_and_store(joined))}}});table_buff.push(entry_buff)});var final_table=new bbop.html.table(headers_display,table_buff,{"class":"bbop-js-search-pane-results-table"});jQuery("#"+elt_id).append(bbop.core.to_string(final_table));each(trim_hash,function(key,val){var tease_id=val[0];var more_b_id=val[1];var full_id=val[2];var less_b_id=val[3];jQuery("#"+full_id).hide();jQuery("#"+less_b_id).hide();jQuery("#"+more_b_id).click(function(){jQuery("#"+tease_id).hide();jQuery("#"+more_b_id).hide();jQuery("#"+full_id).show("fast");jQuery("#"+less_b_id).show("fast")});jQuery("#"+less_b_id).click(function(){jQuery("#"+full_id).hide();jQuery("#"+less_b_id).hide();jQuery("#"+tease_id).show("fast");jQuery("#"+more_b_id).show("fast")})})};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}if(typeof bbop.widget.display=="undefined"){bbop.widget.display={}}bbop.widget.display.results_table_by_class_conf_b3=function(cclass,golr_resp,linker,handler,elt_id,selectable_p,select_toggle_id,select_item_name){var anchor=this;var logger=new bbop.logger();logger.DEBUG=false;function ll(str){logger.kvetch("RTBCCBS3: "+str)}anchor._golr_response=golr_resp;anchor._linker=linker;anchor._handler=handler;var each=bbop.core.each;var is_defined=bbop.core.is_defined;var display_context="bbop.widgets.search_pane";var ea_regexp=new RegExp("</a>","i");var br_regexp=new RegExp("<br />","i");var trim_hash={};var trimit=100;function _trim_and_store(in_str){var retval=in_str;if(retval.length>(trimit+50)){var list_p=br_regexp.test(retval);var anchors_p=ea_regexp.test(retval);var tease=null;if(!anchors_p&&!list_p){tease=new bbop.html.span(bbop.core.crop(retval,trimit,""),{generate_id:true})}else{if(anchors_p&&!list_p){}else{var new_str_list=retval.split(br_regexp);if(new_str_list.length<=3){}else{var new_str="";new_str=new_str+new_str_list.shift();new_str=new_str+"<br />";new_str=new_str+new_str_list.shift();tease=new bbop.html.span(new_str,{generate_id:true})}}}if(tease){function bgen(lbl,dsc){var b=new bbop.html.button(lbl,{generate_id:true,type:"button",title:dsc||lbl,"class":"btn btn-primary btn-xs"});return b}var more_b=new bgen("more...","Display the complete list");var full=new bbop.html.span(retval,{generate_id:true});var less_b=new bgen("less","Display the truncated list");var tease_id=tease.get_id();var more_b_id=more_b.get_id();var full_id=full.get_id();var less_b_id=less_b.get_id();trim_hash[tease_id]=[tease_id,more_b_id,full_id,less_b_id];retval=tease.to_string()+" "+more_b.to_string()+" "+full.to_string()+" "+less_b.to_string()}}return retval}function _create_select_box(val,id,name){if(!is_defined(name)){name=select_item_name}var input_attrs={value:val,name:name,type:"checkbox"};if(is_defined(id)){input_attrs.id=id}var input=new bbop.html.input(input_attrs);return input}var headers=[];var headers_display=[];if(selectable_p){headers.push(select_toggle_id);var hinp=_create_select_box("",select_toggle_id,"");headers_display.push(hinp.to_string())}var results_order=cclass.field_order_by_weight("result");each(results_order,function(fid){headers.push(fid);var field=cclass.get_field(fid);if(!field){throw new Error("conf error: not found:"+fid)}var fdname=field.display_name();var fdesc=field.description()||"???";var head_span_attrs={"class":"bbop-js-ui-hoverable",title:fdesc};var head_span=new bbop.html.span(fdname,head_span_attrs);headers_display.push(head_span.to_string())});var table_buff=[];var docs=golr_resp.documents();each(docs,function(doc){var entry_buff=[];each(headers,function(fid){if(fid==select_toggle_id){var did=doc.id;var dinp=_create_select_box(did);entry_buff.push(dinp.to_string())}else{if(fid=="score"){var score=doc.score||0;score=bbop.core.to_string(100*score);entry_buff.push(bbop.core.crop(score,4)+"%")}else{var field=cclass.get_field(fid);var bits=[];if(doc[fid]){if(field.is_multi()){bits=doc[fid]}else{bits=[doc[fid]]}}var tmp_buff=[];each(bits,function(bit){out=anchor.process_entry(bit,fid,doc,display_context);tmp_buff.push(out)});var joined=tmp_buff.join("<br />");entry_buff.push(_trim_and_store(joined))}}});table_buff.push(entry_buff)});var final_table=new bbop.html.table(headers_display,table_buff,{"class":"table table-striped table-hover table-condensed"});jQuery("#"+elt_id).append(bbop.core.to_string(final_table));each(trim_hash,function(key,val){var tease_id=val[0];var more_b_id=val[1];var full_id=val[2];var less_b_id=val[3];jQuery("#"+full_id).hide();jQuery("#"+less_b_id).hide();jQuery("#"+more_b_id).click(function(){jQuery("#"+tease_id).hide();jQuery("#"+more_b_id).hide();jQuery("#"+full_id).show("fast");jQuery("#"+less_b_id).show("fast")});jQuery("#"+less_b_id).click(function(){jQuery("#"+full_id).hide();jQuery("#"+less_b_id).hide();jQuery("#"+tease_id).show("fast");jQuery("#"+more_b_id).show("fast")})});if(select_toggle_id&&select_item_name){jQuery("#"+select_toggle_id).click(function(){var cstr="input[id="+select_toggle_id+"]";var nstr="input[name="+select_item_name+"]";if(jQuery(cstr).prop("checked")){jQuery(nstr).prop("checked",true)}else{jQuery(nstr).prop("checked",false)}})}};bbop.widget.display.results_table_by_class_conf_b3.prototype.process_entry=function(bit,field_id,document,display_context){var anchor=this;var out=anchor._handler.dispatch(bit,field_id,display_context);if(bbop.core.is_defined(out)&&out!=null){return out}var retval="";var did=document.id;var ilabel=anchor._golr_response.get_doc_label(did,field_id,bit);if(!ilabel){ilabel=bit}var hl=anchor._golr_response.get_doc_highlight(did,field_id,ilabel);var ilink=anchor._linker.anchor({id:bit,label:ilabel,hilite:hl},field_id);if(ilink){retval=ilink}else{if(ilabel){retval=ilabel}else{retval=bit}}return retval};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}if(typeof bbop.widget.display=="undefined"){bbop.widget.display={}}bbop.widget.display.two_column_layout=function(col1,col2){bbop.html.tag.call(this,"div",{"class":"twocol-wrapper"});this._two_column_stack_left=new bbop.html.tag("div",{"class":"twocol-leftcolumn",style:"margin-top: -15px;"},col1);this.add_to(this._two_column_stack_left);this._two_column_stack_right=new bbop.html.tag("div",{"class":"twocol-content"},col2);this.add_to(this._two_column_stack_right)};bbop.widget.display.two_column_layout.prototype=new bbop.html.tag;if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}if(typeof bbop.widget.display=="undefined"){bbop.widget.display={}}bbop.widget.display.filter_shield=function(spinner_img_src,wait_msg){this._is_a="bbop.widget.display.filter_shield";var anchor=this;var logger=new bbop.logger();logger.DEBUG=true;function ll(str){logger.kvetch("W (filter_shield): "+str)}if(!wait_msg){wait_msg="Waiting..."}else{}var is_open_p=false;var parea=new bbop.html.tag("div",{generate_id:true});var pmsg=new bbop.html.tag("div",{generate_id:true},wait_msg);parea.add_to(pmsg);var div=new bbop.html.tag("div",{generate_id:true},parea);var pmsg_id=pmsg.get_id();var div_id=div.get_id();var diargs={modal:true,draggable:false,width:800,height:600,close:function(){jQuery("#"+div_id).remove()}};this.start_wait=function(){is_open_p=true;jQuery("body").append(div.to_string());if(spinner_img_src&&spinner_img_src!=""){var s=new bbop.widget.spinner(parea.get_id(),spinner_img_src)}var dia=jQuery("#"+div_id).dialog(diargs)};this.draw=function(field_name,filter_list,manager){if(!is_open_p){anchor.open()}var txt="No filters...";var tbl=new bbop.html.table(null,null,{generate_id:true});var button_hash={};var each=bbop.core.each;var bgen=bbop.widget.display.text_button_sim;each(filter_list,function(field){var fname=field[0];var fcount=field[1];var b_plus=new bgen("+","Add positive filter");var b_minus=new bgen("-","Add negative filter");button_hash[b_plus.get_id()]=[field_name,fname,fcount,"+"];button_hash[b_minus.get_id()]=[field_name,fname,fcount,"-"];tbl.add_to([fname,"("+fcount+")",b_plus.to_string(),b_minus.to_string()])});txt=tbl.to_string();jQuery("#"+div_id).empty();var fdiv=new bbop.html.tag("div",{generate_id:true});jQuery("#"+div_id).append(fdiv.to_string());jQuery("#"+div_id).append(txt);var ft=null;if(spinner_img_src&&spinner_img_src!=""){ft=bbop.widget.filter_table(fdiv.get_id(),tbl.get_id(),spinner_img_src,null)}else{ft=bbop.widget.filter_table(fdiv.get_id(),tbl.get_id(),null)}function filter_select_live(button_id,create_time_button_props){var in_polarity=create_time_button_props[3];var b_ui_icon="ui-icon-plus";if(in_polarity=="-"){b_ui_icon="ui-icon-minus"}var b_ui_props={icons:{primary:b_ui_icon},text:false};jQuery("#"+button_id).click(function(){var tid=jQuery(this).attr("id");var call_time_button_props=button_hash[tid];var call_field=call_time_button_props[0];var call_filter=call_time_button_props[1];var call_polarity=call_time_button_props[3];manager.add_query_filter(call_field,call_filter,[call_polarity]);manager.search();jQuery("#"+div_id).remove()})}each(button_hash,filter_select_live)}};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}if(typeof bbop.widget.display=="undefined"){bbop.widget.display={}}bbop.widget.display.live_search=function(interface_id,conf_class){var anchor=this;var each=bbop.core.each;var logger=new bbop.logger();logger.DEBUG=false;function ll(str){logger.kvetch("UI (search): "+str)}this.interface_id=interface_id;this.class_conf=conf_class;this.linker=new bbop.linker();this.handler=new bbop.handler();this.button_definitions=[];var ui_div_id=this.interface_id;jQuery("#"+ui_div_id).empty();var mangle=ui_div_id+"_ui_element_"+bbop.core.uuid()+"_";var ui_controls_section_id=mangle+"ui-controls-wrapper";var controls_div=new bbop.html.tag("div",{id:ui_controls_section_id});var ui_results_section_id=mangle+"ui-results-wrapper";var results_div=new bbop.html.tag("div",{id:ui_results_section_id});var ui_results_selection_control_id=null;var ui_results_selection_item_name=null;var show_checkboxes_p=false;var two_col_div=new bbop.widget.display.two_column_layout(controls_div,results_div);jQuery("#"+ui_div_id).append(two_col_div.to_string());var ui_meta_div_id=mangle+"meta-id";var ui_user_button_div_id=mangle+"user-button-id";var ui_results_table_div_id=mangle+"results-table-id";var ui_count_control_div_id=mangle+"count_control-id";var ui_sticky_filters_div_id=mangle+"sticky_filters-id";var ui_current_filters_div_id=mangle+"current_filters-id";var ui_query_input_id=mangle+"query-id";var ui_clear_query_span_id=mangle+"clear-query-id";var ui_clear_user_filter_span_id=mangle+"clear-user-filter-id";var ui_spinner_search_source="";var ui_spinner_shield_source="";var ui_spinner_shield_message=null;var ui_icon_positive_label="";var ui_icon_positive_source="";var ui_icon_negative_label="";var ui_icon_negative_source="";var ui_icon_remove_label="";var ui_icon_remove_source="";var spinner=null;function _spinner_gen(elt_id){var spinner_args={timeout:10,visible_p:false};spinner=new bbop.widget.spinner(elt_id,ui_spinner_search_source,spinner_args)}function _spin_up(){if(spinner){spinner.start_wait()}}function _spin_down(){if(spinner){spinner.finish_wait()}}var accordion_div_id=mangle+"filter-accordion-id";var filter_accordion_widget=null;this.show_checkboxes_p=function(new_setting){if(bbop.core.is_defined(new_setting)){if(new_setting){show_checkboxes_p=true}else{show_checkboxes_p=false}}return show_checkboxes_p};this.set_linker=function(linker){var retval=false;if(bbop.core.is_defined(linker)){anchor.linker=linker;retval=true}return retval};this.set_handler=function(handler){var retval=false;if(bbop.core.is_defined(handler)){anchor.handler=handler;retval=true}return retval};this.selected_name=function(){return ui_results_selection_item_name};this.setup_query=function(label_str,icon_clear_label,icon_clear_source){ll("setup_query for: "+ui_query_input_id);if(!label_str){label_str=""}if(!icon_clear_label){icon_clear_label=""}if(!icon_clear_source){icon_clear_source=""}var query_label_attrs={"class":"bbop-js-search-pane-query-label"};var query_label_div=new bbop.html.tag("div",query_label_attrs,label_str);var ta_args={id:ui_query_input_id,rows:"1","class":"bbop-js-search-pane-textarea"};var query_area=new bbop.html.tag("textarea",ta_args);var clear_query_obj=bbop.widget.display.clickable_object(icon_clear_label,icon_clear_source,ui_clear_query_span_id);var clear_div_attrs={"class":"bbop-js-search-pane-clear-button",generate_id:true};var clear_div=new bbop.html.tag("div",clear_div_attrs,clear_query_obj);var gen_div_attrs={generate_id:true};var gen_div=new bbop.html.tag("div",gen_div_attrs);query_label_div.add_to(clear_div.to_string());gen_div.add_to(query_label_div.to_string());gen_div.add_to(query_area.to_string());jQuery("#"+ui_controls_section_id).append(gen_div.to_string())};this.setup_sticky_filters=function(){ll("setup_sticky_filters UI for class configuration: "+this.class_conf.id());var sticky_filters_attrs={id:ui_sticky_filters_div_id,"class":"bbop-js-search-pane-sticky-filters"};var sticky_filters_div=new bbop.html.tag("div",sticky_filters_attrs,"No applied sticky filters.");var sticky_filters_str=sticky_filters_div.to_string();jQuery("#"+ui_controls_section_id).append(sticky_filters_str)};this.setup_current_filters=function(icon_remove_label,icon_remove_source){ll("setup_current_filters UI for class configuration: "+this.class_conf.id());if(icon_remove_label){ui_icon_remove_label=icon_remove_label}if(icon_remove_source){ui_icon_remove_source=icon_remove_source}var current_filters_div=new bbop.html.tag("div",{id:ui_current_filters_div_id},"No applied user filters.");var curr_filters_str=current_filters_div.to_string();jQuery("#"+ui_controls_section_id).append(curr_filters_str)};this.setup_accordion=function(icon_positive_label,icon_positive_source,icon_negative_label,icon_negative_source,spinner_shield_source,spinner_shield_message){ll("setup_accordion UI for class configuration: "+this.class_conf.id());if(spinner_shield_source){ui_spinner_shield_source=spinner_shield_source}if(spinner_shield_message){ui_spinner_shield_message=spinner_shield_message}if(icon_positive_label){ui_icon_positive_label=icon_positive_label}if(icon_positive_source){ui_icon_positive_source=icon_positive_source}if(icon_negative_label){ui_icon_negative_label=icon_negative_label}if(icon_negative_source){ui_icon_negative_source=icon_negative_source}var filter_accordion_attrs={id:accordion_div_id};filter_accordion_widget=new bbop.html.accordion([],filter_accordion_attrs,true);var field_list=this.class_conf.field_order_by_weight("filter");each(field_list,function(in_field){ll("saw field: "+in_field);var ifield=anchor.class_conf.get_field(in_field);var in_attrs={id:in_field,label:ifield.display_name(),description:ifield.description()};filter_accordion_widget.add_to(in_attrs,"",true)});var accordion_str=filter_accordion_widget.to_string();jQuery("#"+ui_controls_section_id).append(accordion_str);var jqacc_attrs={clearStyle:true,heightStyle:"content",collapsible:true,active:false};jQuery("#"+accordion_div_id).accordion(jqacc_attrs)};this.setup_results=function(args){ll("setup_results UI for class configuration: "+this.class_conf.id());var add_meta_p=false;if(args&&args.meta&&args.meta==true){add_meta_p=true}var add_spinner_p=false;if(args&&args.spinner_source&&args.spinner_source!=""){ui_spinner_search_source=args.spinner_source;add_spinner_p=true}var block=new bbop.html.tag("div",{"class":"block"});var hargs={generate_id:true,"class":"bbop-widget-search_pane-spinner-element"};var header=new bbop.html.tag("h4",hargs,"Found entities&nbsp;");block.add_to(header);if(add_meta_p){var meta_attrs={id:ui_meta_div_id};var meta=new bbop.html.tag("div",meta_attrs);block.add_to(meta)}var results=new bbop.html.tag("div",{id:ui_results_table_div_id});block.add_to(results);jQuery("#"+ui_results_section_id).append(block.to_string());if(add_meta_p){ll("Add meta UI div");jQuery("#"+ui_meta_div_id).empty();var init_str="Performing initial search, please wait...";jQuery("#"+ui_meta_div_id).append(init_str);if(ui_spinner_search_source&&ui_spinner_search_source!=""){var init_spin_str='&nbsp;<img src="'+ui_spinner_search_source+'" alt="[waiting]" class="bbop-js-spinner"/>';jQuery("#"+ui_meta_div_id).append(init_spin_str)}}if(add_spinner_p){_spinner_gen(header.get_id())}};this.draw_user_buttons=function(manager){function _button_rollout(button_def_hash){var default_hash={label:"n/a",disabled_p:false,text_p:false,icon:"ui-icon-help",click_function_generator:function(){return function(){alert("No callback defined for this button--the generator may have been empty!")}}};var folding_hash=button_def_hash||{};var arg_hash=bbop.core.fold(default_hash,folding_hash);var label=arg_hash.label;var disabled_p=arg_hash.disabled_p;var text_p=arg_hash.text_p;var icon=arg_hash.icon;var click_function_generator=arg_hash.click_function_generator;var b=new bbop.html.button(label,{generate_id:true});jQuery("#"+ui_user_button_div_id).append(b.to_string());var b_props={icons:{primary:icon},disabled:disabled_p,text:text_p};var click_fun=click_function_generator(manager);jQuery("#"+b.get_id()).button(b_props).click(click_fun)}if(!jQuery("#"+ui_user_button_div_id)){alert("cannot refresh buttons without a place to draw them")}else{jQuery("#"+ui_user_button_div_id).empty();jQuery("#"+ui_user_button_div_id).empty();bbop.core.each(anchor.button_definitions,_button_rollout)}};this.draw_meta=function(response,manager){ll("draw_meta for: "+ui_meta_div_id);var total_c=response.total_documents();var first_d=response.start_document();var last_d=response.end_document();jQuery("#"+ui_meta_div_id).empty();if(total_c==0){jQuery("#"+ui_meta_div_id).append("No results found.")}else{var mdiv_attrs={};var mdiv=new bbop.html.tag("div",mdiv_attrs);var dmeta_attrs={"class":"bbop-js-search-pane-meta"};var dmeta=new bbop.html.tag("div",dmeta_attrs);dmeta.add_to("Total: "+total_c+"; showing "+first_d+"-"+last_d);mdiv.add_to(dmeta);var cinputs=[];each([10,25,50,100],function(num,cindex){var sel_input_attrs={generate_id:true,value:num};var sel_input=new bbop.html.tag("option",sel_input_attrs,num);var sel_input_id=sel_input.get_id();cinputs.push(sel_input)});var sel_attrs={id:ui_count_control_div_id};var sel=new bbop.html.tag("select",sel_attrs,cinputs);var sel_label_attrs={};var sel_label=new bbop.html.tag("label",sel_label_attrs,"Results count&nbsp;&nbsp;");var sel_div_attrs={generate_id:true,"class":"bbop-js-search-pane-results-count"};var sel_div=new bbop.html.tag("div",sel_div_attrs);sel_div.add_to(sel_label);sel_div.add_to(sel);mdiv.add_to(sel_div);jQuery("#"+ui_meta_div_id).append(mdiv.to_string());jQuery("#"+ui_count_control_div_id).unbind("change");var step=response.row_step();jQuery("#"+ui_count_control_div_id).val(step);jQuery("#"+ui_count_control_div_id).change(function(event,ui){var sv=jQuery("#"+ui_count_control_div_id).val();if(bbop.core.is_defined(sv)){var si=parseInt(sv);manager.set_results_count(si);manager.search();_spin_up()}});var bdiv_attrs={generate_id:true};var bdiv=new bbop.html.tag("div",bdiv_attrs);jQuery("#"+ui_meta_div_id).append(bdiv.to_string());var bdiv_id=bdiv.get_id();var b_first=new bbop.html.button("First",{generate_id:true});jQuery("#"+bdiv_id).append(b_first.to_string());var b_back=new bbop.html.button("Prev",{generate_id:true});jQuery("#"+bdiv_id).append(b_back.to_string());var b_forward=new bbop.html.button("Next",{generate_id:true});jQuery("#"+bdiv_id).append(b_forward.to_string());var b_last=new bbop.html.button("Last",{generate_id:true});jQuery("#"+bdiv_id).append(b_last.to_string());var b_first_disabled_p=false;var b_back_disabled_p=false;var b_forward_disabled_p=false;var b_last_disabled_p=false;if(!response.paging_p()){b_first_disabled_p=true;b_back_disabled_p=true;b_forward_disabled_p=true;b_last_disabled_p=true}if(!response.paging_previous_p()){b_first_disabled_p=true;b_back_disabled_p=true}if(!response.paging_next_p()){b_forward_disabled_p=true;b_last_disabled_p=true}var b_first_props={icons:{primary:"ui-icon-seek-first"},disabled:b_first_disabled_p,text:false};jQuery("#"+b_first.get_id()).button(b_first_props).click(function(){manager.page_first();_spin_up()});var b_back_props={icons:{primary:"ui-icon-seek-prev"},disabled:b_back_disabled_p,text:false};jQuery("#"+b_back.get_id()).button(b_back_props).click(function(){manager.page_previous();_spin_up()});var b_forward_props={icons:{primary:"ui-icon-seek-next"},disabled:b_forward_disabled_p,text:false};jQuery("#"+b_forward.get_id()).button(b_forward_props).click(function(){manager.page_next();_spin_up()});var b_last_props={icons:{primary:"ui-icon-seek-end"},disabled:b_last_disabled_p,text:false};jQuery("#"+b_last.get_id()).button(b_last_props).click(function(){manager.page_last(total_c);_spin_up()});jQuery("#"+bdiv_id).append("&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;");var ubuttons=new bbop.html.tag("span",{id:ui_user_button_div_id});jQuery("#"+bdiv_id).append(ubuttons.to_string());anchor.draw_user_buttons(manager)}};function _ignorable_event(event){var retval=false;if(event){var kc=event.keyCode;if(kc){if(kc==39||kc==37||kc==32||kc==20||kc==17||kc==16||kc==0){ll("ignorable key event: "+kc);retval=true}}}return retval}this.draw_query=function(response,manager){ll("draw_query for: "+ui_query_input_id);jQuery("#"+ui_query_input_id).unbind("keyup");jQuery("#"+ui_query_input_id).keyup(function(event){if(!_ignorable_event(event)){var tmp_q=manager.get_query();var input_text=jQuery(this).val();manager.set_query(input_text);if(manager.sensible_query_p()){ll("keeping set query: "+input_text);manager.set_comfy_query(input_text);manager.search();_spin_up()}else{ll("rolling back query: "+tmp_q);manager.set_query(tmp_q)}}});jQuery("#"+ui_clear_query_span_id).unbind("click");jQuery("#"+ui_clear_query_span_id).click(function(){manager.reset_query();anchor.set_query_field("");manager.search();_spin_up()})};this.reset_query=function(response,manager){ll("reset_query for: "+ui_query_input_id);manager.reset_query();anchor.draw_query(response,manager)};this.draw_sticky_filters=function(response,manager){ll("draw_sticky_filters for: "+ui_div_id);var sticky_query_filters=manager.get_sticky_query_filters();ll("sticky filters: "+bbop.core.dump(sticky_query_filters));var fq_list_tbl=new bbop.html.table(["","Your search is pinned to these filters"],[],{"class":"bbop-js-search-pane-filter-table"});each(sticky_query_filters,function(fset){var sfield=fset.filter;var sfield_val=fset.value;var polarity=fset.negative_p;var polstr="+";if(polarity){polstr="-"}var label_str=polstr+" "+sfield+":"+sfield_val;fq_list_tbl.add_to(["<b>"+polstr+"</b>",sfield+": "+sfield_val])});var sfid="#"+ui_sticky_filters_div_id;jQuery(sfid).empty();if(sticky_query_filters.length==0){jQuery(sfid).append("No sticky filters.")}else{jQuery(sfid).append(fq_list_tbl.to_string())}};this.draw_current_filters=function(response,manager){ll("draw_current_filters for: "+ui_div_id);var b_cf=new bbop.widget.display.text_button_sim("X","Clear all user filters",ui_clear_user_filter_span_id);var in_query_filters=response.query_filters();ll("filters: "+bbop.core.dump(in_query_filters));var fq_list_tbl=new bbop.html.table(["","User filters",b_cf.to_string()],[],{"class":"bbop-js-search-pane-filter-table"});var has_fq_p=false;var button_hash={};each(in_query_filters,function(field,field_vals){each(field_vals,function(field_val,polarity){var qfp=manager.get_query_filter_properties(field,field_val);if(!qfp||qfp.sticky_p==false){has_fq_p=true;var polstr="-";if(polarity){polstr="+"}var label_str=polstr+" "+field+":"+field_val;var b=bbop.widget.display.clickable_object(ui_icon_remove_label,ui_icon_remove_source,null);var bid=b.get_id();button_hash[bid]=[polstr,field,field_val];fq_list_tbl.add_to(["<b>"+polstr+"</b>",field+": "+field_val,b.to_string()])}})});var cfid="#"+ui_current_filters_div_id;jQuery(cfid).empty();if(!has_fq_p){jQuery(cfid).append("No current user filters.")}else{jQuery(cfid).append(fq_list_tbl.to_string());jQuery("#"+b_cf.get_id()).click(function(){manager.reset_query_filters();manager.search();_spin_up()});each(button_hash,function(button_id){var bid=button_id;jQuery("#"+bid).click(function(){var tid=jQuery(this).attr("id");var button_props=button_hash[tid];var polstr=button_props[0];var field=button_props[1];var value=button_props[2];manager.remove_query_filter(field,value);manager.search();_spin_up()})})}};this.draw_accordion=function(response,manager){ll("draw_accordion for: "+ui_div_id);if(typeof(filter_accordion_widget)=="undefined"){throw new Error("Need to init accordion to use it.")}var real_facet_limit=manager.get_facet_limit();var curr_facet_limit=real_facet_limit-1;var total_docs=response.total_documents();function _nothing_to_see_here(in_field){var section_id=filter_accordion_widget.get_section_id(in_field);jQuery("#"+section_id).empty();jQuery("#"+section_id).append("Nothing to filter.")}var button_hash={};var overflow_hash={};each(response.facet_field_list(),function(in_field){var facet_bd=response.facet_field(in_field);if(bbop.core.is_empty(facet_bd)){_nothing_to_see_here(in_field)}else{var tbl_id=mangle+"filter-list-"+in_field;var facet_list_tbl_attrs={id:tbl_id};var facet_list_tbl=new bbop.html.table([],[],facet_list_tbl_attrs);ll("consider:"+in_field+": "+response.facet_field(in_field).length);var redundant_count=0;var good_count=0;var overflow_p=false;each(response.facet_field(in_field),function(ff_field,ff_index){var f_name=ff_field[0];var f_count=ff_field[1];if(f_count==total_docs){redundant_count++}else{if(!f_name||f_name==""){}else{if(ff_index<real_facet_limit-1){good_count++;var b_plus=bbop.widget.display.clickable_object(ui_icon_positive_label,ui_icon_positive_source,null);var b_minus=bbop.widget.display.clickable_object(ui_icon_negative_label,ui_icon_negative_source,null);button_hash[b_plus.get_id()]=[in_field,f_name,f_count,"+"];button_hash[b_minus.get_id()]=[in_field,f_name,f_count,"-"];facet_list_tbl.add_to([f_name,"("+f_count+")",b_plus.to_string(),b_minus.to_string()])}}}if(ff_index==real_facet_limit-1){overflow_p=true;var bgn=bbop.widget.display.text_button_sim;var b_over=new bgn("more...","Display the complete list");facet_list_tbl.add_to([b_over.to_string(),"",""]);overflow_hash[b_over.get_id()]=in_field}});if(good_count==0&&!overflow_p){_nothing_to_see_here(in_field)}else{var sect_id=filter_accordion_widget.get_section_id(in_field);jQuery("#"+sect_id).empty();var warn_txt=null;if(redundant_count==1){warn_txt="field is"}else{if(redundant_count>1){warn_txt="fields are"}}if(warn_txt){jQuery("#"+sect_id).append("<small> The top ("+redundant_count+") redundant "+warn_txt+" not shown</small>")}var final_tbl_str=facet_list_tbl.to_string();jQuery("#"+sect_id).append(final_tbl_str)}}});function filter_select_live(button_id,create_time_button_props){var in_polarity=create_time_button_props[3];var b_ui_icon="ui-icon-plus";if(in_polarity=="-"){b_ui_icon="ui-icon-minus"}var b_ui_props={icons:{primary:b_ui_icon},text:false};jQuery("#"+button_id).click(function(){var tid=jQuery(this).attr("id");var call_time_button_props=button_hash[tid];var call_field=call_time_button_props[0];var call_filter=call_time_button_props[1];var call_polarity=call_time_button_props[3];manager.add_query_filter(call_field,call_filter,[call_polarity]);manager.search();_spin_up()})}each(button_hash,filter_select_live);each(overflow_hash,function(button_id,filter_name){jQuery("#"+button_id).click(function(){var tid=jQuery(this).attr("id");var call_time_field_name=overflow_hash[tid];manager.set_facet_limit(0);manager.set_facet_limit(call_time_field_name,-1);var curr_row=manager.get("rows");manager.set("rows",0);var fs=bbop.widget.display.filter_shield;var filter_shield=new fs(ui_spinner_shield_source,ui_spinner_shield_message);filter_shield.start_wait();function draw_shield(resp){var fina=call_time_field_name;var flist=resp.facet_field(call_time_field_name);filter_shield.draw(fina,flist,manager)}manager.fetch(draw_shield);manager.reset_facet_limit();manager.set("rows",curr_row)})});ll("Done current accordion for: "+ui_div_id)};this.draw_results=function(response,manager){ll("draw_results for: "+ui_results_table_div_id);var urtdi=ui_results_table_div_id;jQuery("#"+urtdi).empty();var docs=response.documents();if(!bbop.core.is_empty(docs)){var final_table=new bbop.widget.display.results_table_by_class(anchor.class_conf,response,anchor.linker,anchor.handler,urtdi,show_checkboxes_p);ui_results_selection_control_id=final_table.toggle_id();ui_results_selection_item_name=final_table.item_name();if(ui_results_selection_control_id&&ui_results_selection_item_name){jQuery("#"+ui_results_selection_control_id).click(function(){var cstr="input[id="+ui_results_selection_control_id+"]";var nstr="input[name="+ui_results_selection_item_name+"]";if(jQuery(cstr).prop("checked")){jQuery(nstr).prop("checked",true)}else{jQuery(nstr).prop("checked",false)}})}}_spin_down()};this.draw_error=function(error_message,manager){ll("draw_error: "+error_message);alert("Runtime error: "+error_message);_spin_down()};this.set_buttons=function(button_def_list){if(!button_def_list){button_def_list=[]}ll("changing buttons: to "+button_def_list.length+" from "+anchor.button_definitions.length);anchor.button_definitions=button_def_list};this.set_query_field=function(query){var retval=false;if(!query){query=""}if(jQuery("#"+ui_query_input_id)){ll("changing query search field: to "+query);jQuery("#"+ui_query_input_id).val(query);retval=true}return retval}};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}bbop.widget.spinner=function(host_elt_id,img_src,argument_hash){this._is_a="bbop.widget.spinner";var anchor=this;var logger=new bbop.logger();logger.DEBUG=false;function ll(str){logger.kvetch("W (spinner): "+str)}var default_hash={timeout:5,visible_p:true,classes:""};var folding_hash=argument_hash||{};var arg_hash=bbop.core.fold(default_hash,folding_hash);var timeout=arg_hash.timeout;var visible_p=arg_hash.visible_p;var classes=arg_hash.classes;var spinner_classes=["bbop-js-spinner"];if(!visible_p){spinner_classes.push("bbop-js-spinner-hidden")}if(classes&&classes!=""){spinner_classes.push(classes)}var spinner_elt=new bbop.html.image({generate_id:true,src:img_src,title:"Please wait...","class":spinner_classes.join(" "),alt:"(waiting...)"});var spinner_elt_id=spinner_elt.get_id();jQuery("#"+host_elt_id).append(spinner_elt.to_string());var current_waits=0;var timeout_queue=[];this.show=function(){ll("show");jQuery("#"+spinner_elt_id).removeClass("bbop-js-spinner-hidden");function _on_timeout(){anchor.finish_wait()}if(timeout>0){setTimeout(_on_timeout,(timeout*1000))}};this.hide=function(){ll("hide");jQuery("#"+spinner_elt_id).addClass("bbop-js-spinner-hidden")};this.start_wait=function(){ll("Start outstanding waits: "+current_waits);if(current_waits==0){anchor.show()}current_waits++};this.finish_wait=function(){ll("Finish outstanding waits: "+current_waits);if(current_waits>0){current_waits--}if(current_waits==0){anchor.hide()}};this.clear_waits=function(){current_waits=0;anchor.hide()}};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}bbop.widget.filter_table=function(elt_id,table_id,img_src,repaint_func,label){this._is_a="bbop.widget.filter_table";var anchor=this;var logger=new bbop.logger();logger.DEBUG=false;function ll(str){logger.kvetch(str)}ll("init filter_table in "+elt_id+" for "+table_id);anchor.img_src=null;if(img_src){anchor.img_src=img_src}anchor.repaint_func=function(tid){};if(repaint_func){anchor.repaint_func=repaint_func}anchor.label="Filter:";if(label){anchor.label=label}ll("finished args");var input_attrs={type:"text","class":"form-control bbop-js-filter-table-input",value:"",generate_id:true};var input=new bbop.html.input(input_attrs);var lbl_attrs={"for":input.get_id(),generate_id:true};var lbl=new bbop.html.tag("label",lbl_attrs,anchor.label);var clear_button_attrs={type:"button","class":"btn btn-danger",title:"Clear filter",generate_id:true};var clear_button=new bbop.html.button("&times;",clear_button_attrs);var cont_attrs={"class":"form-inline"};var cont=new bbop.html.tag("div",cont_attrs,[lbl,input,clear_button]);ll("widget gen done");jQuery("#"+elt_id).empty();jQuery("#"+elt_id).append(cont.to_string());var spinner=null;if(anchor.img_src){jQuery("#"+elt_id).append("&nbsp;&nbsp;");spinner=new bbop.widget.spinner(elt_id,anchor.img_src,{visible_p:false})}ll("widget addition done");jQuery("#"+clear_button.get_id()).click(function(){ll("click call");if(spinner){spinner.show()}jQuery("#"+input.get_id()).val("");trs.show();anchor.repaint_func(table_id);if(spinner){spinner.hide()}});var trs=jQuery("#"+table_id+" tbody > tr");var tds=trs.children();jQuery("#"+input.get_id()).keyup(function(){if(spinner){spinner.show()}var stext=jQuery(this).val();ll("keyup call: ("+stext+"), "+trs);if(!bbop.core.is_defined(stext)||stext==""){trs.show()}else{stext=stext.toLowerCase();trs.hide();function _match_filter(){var retval=false;var lc=jQuery(this).text().toLowerCase();if(lc.indexOf(stext)>=0){retval=true}return retval}tds.filter(_match_filter).parent("tr").show()}anchor.repaint_func(table_id);if(spinner){spinner.hide()}})};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}bbop.widget.browse=function(golr_loc,golr_conf_obj,interface_id,in_argument_hash){var logger=new bbop.logger();logger.DEBUG=true;function ll(str){logger.kvetch("B (widget): "+str)}bbop.golr.manager.jquery.call(this,golr_loc,golr_conf_obj);this._is_a="bbop.widget.browse";var anchor=this;var loop=bbop.core.each;var default_hash={topology_graph_field:"topology_graph_json",transitivity_graph_field:"transitivity_graph_json",info_button_callback:function(){},base_icon_url:null,image_type:"gif",current_icon:"this",info_icon:"info",info_alt:"Click for more information."};var folding_hash=in_argument_hash||{};var arg_hash=bbop.core.fold(default_hash,folding_hash);this._interface_id=interface_id;this._info_button_callback=arg_hash.info_button_callback;var topo_graph_field=arg_hash.topology_graph_field;var trans_graph_field=arg_hash.transitivity_graph_field;var base_icon_url=arg_hash.base_icon_url;var image_type=arg_hash.image_type;var current_icon=arg_hash.current_icon;var info_icon=arg_hash.info_icon;var info_alt=arg_hash.info_alt;this._current_acc=null;anchor.register("search","do",draw_rich_layout);function draw_rich_layout(resp){var doc=resp.documents()[0];var topo_graph=new bbop.model.bracket.graph();topo_graph.load_json(JSON.parse(doc[topo_graph_field]));var trans_graph=new bbop.model.graph();trans_graph.load_json(JSON.parse(doc[trans_graph_field]));var rich_layout=topo_graph.rich_bracket_layout(anchor._current_acc,trans_graph);var tl_attrs={"class":"bbop-js-ui-browse"};var top_level=new bbop.html.list([],tl_attrs);var nav_button_hash={};var info_button_hash={};var spacing="&nbsp;&nbsp;&nbsp;&nbsp;";var spaces=spacing;loop(rich_layout,function(layout_level){loop(layout_level,function(level_item){var nid=level_item[0];var lbl=level_item[1];var rel=level_item[2];var use_img_p=true;if(base_icon_url==null||base_icon_url==""){use_img_p=false}var nav_b=null;if(anchor._current_acc==nid){var inact_attrs={"class":"bbop-js-text-button-sim-inactive",title:"Current term."};nav_b=new bbop.html.span(nid,inact_attrs)}else{var tbs=bbop.widget.display.text_button_sim;var bttn_title="Reorient neighborhood onto this node ("+nid+").";nav_b=new tbs(nid,bttn_title);nav_button_hash[nav_b.get_id()]=nid}var info_b=null;if(use_img_p){var imgsrc=bbop.core.resourcify(base_icon_url,info_icon,image_type);info_b=new bbop.html.image({alt:info_alt,title:info_alt,src:imgsrc,generate_id:true})}else{info_b=new bbop.html.span("<b>[i]</b>",{generate_id:true})}info_button_hash[info_b.get_id()]=nid;var icon=null;if(use_img_p){var ialt="["+rel+"]";var isrc=null;if(anchor._current_acc==nid){isrc=bbop.core.resourcify(base_icon_url,current_icon,image_type)}else{isrc=bbop.core.resourcify(base_icon_url,rel,image_type)}icon=new bbop.html.image({alt:ialt,title:rel,src:isrc,generate_id:true})}else{if(anchor._current_acc==nid){icon="[[->]]"}else{if(rel&&rel.length&&rel.length>0){icon="["+rel+"]"}else{icon="[???]"}}}top_level.add_to(spaces,icon,nav_b.to_string(),lbl,info_b.to_string())});spaces=spaces+spacing});jQuery("#"+anchor._interface_id).empty();jQuery("#"+anchor._interface_id).append(top_level.to_string());loop(nav_button_hash,function(button_id,node_id){jQuery("#"+button_id).click(function(){var tid=jQuery(this).attr("id");var call_time_node_id=nav_button_hash[tid];anchor.draw_browser(call_time_node_id)})});loop(info_button_hash,function(button_id,node_id){jQuery("#"+button_id).click(function(){var tid=jQuery(this).attr("id");var call_time_node_id=info_button_hash[tid];var call_time_doc=resp.get_doc(call_time_node_id);anchor._info_button_callback(call_time_node_id,call_time_doc)})})}this.draw_browser=function(term_acc){anchor._current_acc=term_acc;anchor.set_id(term_acc);anchor.update("search")}};bbop.core.extend(bbop.widget.browse,bbop.golr.manager.jquery);if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}bbop.widget.search_box=function(golr_loc,golr_conf_obj,interface_id,in_argument_hash){bbop.golr.manager.jquery.call(this,golr_loc,golr_conf_obj);this._is_a="bbop.widget.search_box";var anchor=this;var loop=bbop.core.each;var logger=new bbop.logger();logger.DEBUG=true;function ll(str){logger.kvetch("W (auto): "+str)}var default_hash={fill_p:true,label_template:"{{id}}",value_template:"{{id}}",additional_results_class:"",minimum_length:3,list_select_callback:function(){}};var folding_hash=in_argument_hash||{};var arg_hash=bbop.core.fold(default_hash,folding_hash);this._interface_id=interface_id;this._fill_p=arg_hash.fill_p;this._list_select_callback=arg_hash.list_select_callback;var label_tt=new bbop.template(arg_hash.label_template);var value_tt=new bbop.template(arg_hash.value_template);var ar_class=arg_hash.additional_results_class;var minlen=arg_hash.minimum_length;var result_count=null;var return_count=null;var auto_args={minLength:minlen,source:function(request_data,response_hook){anchor.jq_vars.success=function(json_data){var retlist=[];var resp=new bbop.golr.response(json_data);result_count=null;return_count=null;if(resp.success()){result_count=resp.total_documents();return_count=resp.documents().length;loop(resp.documents(),function(doc){var lbl=label_tt.fill(doc);var val=value_tt.fill(doc);var item={label:lbl,value:val,document:doc};retlist.push(item)})}response_hook(retlist)};anchor.set_comfy_query(request_data.term);anchor.JQ.ajax(anchor.get_query_url(),anchor.jq_vars)},select:function(event,ui){if(!anchor._fill_p){event.preventDefault()}var doc_to_apply=null;if(ui.item){doc_to_apply=ui.item.document}if(doc_to_apply&&bbop.core.is_defined(anchor._list_select_callback)){anchor._list_select_callback(doc_to_apply)}},response:function(event,ui){}};var jac=jQuery("#"+anchor._interface_id).autocomplete(auto_args);jac.data("ui-autocomplete")._renderMenu=function(ul,items){var anchor=this;loop(items,function(item){anchor._renderItemData(ul,item)});if(ar_class&&ar_class!=""){jQuery(ul).removeClass(ar_class);if(result_count!=null&&return_count!=null){console.log("res_c: "+result_count);console.log("ret_c: "+return_count);if(result_count>return_count){jQuery(ul).addClass(ar_class)}}}};this.destroy=function(){jQuery("#"+anchor._interface_id).autocomplete("destroy")};this.content=function(){return jQuery("#"+anchor._interface_id).val()}};bbop.core.extend(bbop.widget.search_box,bbop.golr.manager.jquery);if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}bbop.widget.dialog=function(item,in_argument_hash){this._is_a="bbop.widget.dialog";var anchor=this;var logger=new bbop.logger();logger.DEBUG=true;function ll(str){logger.kvetch("W (dialog): "+str)}var default_hash={width:300,title:"",buttons:null,close:function(){jQuery("#"+div_id).remove()}};var folding_hash=in_argument_hash||{};var arg_hash=bbop.core.fold(default_hash,folding_hash);var title=arg_hash.title;delete arg_hash.title;var str=item||"Nothing here...";if(bbop.core.what_is(item)!="string"){str=item.to_string()}var div=new bbop.html.tag("div",{generate_id:true,title:title});var div_id=div.get_id();jQuery("body").append(div.to_string());jQuery("#"+div_id).append(str);var dia=jQuery("#"+div_id).dialog(arg_hash)};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}bbop.widget.term_shield=function(golr_loc,golr_conf_obj,in_argument_hash){bbop.golr.manager.jquery.call(this,golr_loc,golr_conf_obj);this._is_a="bbop.widget.term_shield";var anchor=this;var logger=new bbop.logger();logger.DEBUG=true;function ll(str){logger.kvetch("W (term_shield): "+str)}var default_hash={linker_function:function(){},width:700};var folding_hash=in_argument_hash||{};var arg_hash=bbop.core.fold(default_hash,folding_hash);var width=arg_hash.width;var linker=arg_hash.linker_function;function _draw_local_doc(doc){var personality=anchor.get_personality();var cclass=golr_conf_obj.get_class(personality);var txt="Nothing here...";if(doc&&cclass){var tbl=new bbop.html.table();var results_order=cclass.field_order_by_weight("result");var each=bbop.core.each;each(results_order,function(fid){var field=cclass.get_field(fid);var val=doc[fid];if(field.is_multi()){if(val){val=val.join(", ")}else{val="n/a"}}else{var link=null;if(val){link=linker.anchor({id:val},fid);if(link){val=link}}else{val="n/a"}}tbl.add_to([field.display_name(),val])});txt=tbl.to_string()}var div=new bbop.html.tag("div",{generate_id:true});var div_id=div.get_id();jQuery("body").append(div.to_string());jQuery("#"+div_id).append(txt);var diargs={modal:true,draggable:false,width:width,close:function(){jQuery("#"+div_id).remove()}};var dia=jQuery("#"+div_id).dialog(diargs)}function _draw_remote_id(id_string){function _process_resp(resp){var doc=resp.get_doc(0);_draw_local_doc(doc)}anchor.register("search","do",_process_resp);anchor.set_id(id_string);anchor.search()}this.draw=function(item){if(bbop.core.what_is(item)=="string"){_draw_remote_id(item)}else{_draw_local_doc(item)}}};bbop.core.extend(bbop.widget.term_shield,bbop.golr.manager.jquery);if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}bbop.widget.list_select_shield=function(in_argument_hash){this._is_a="bbop.widget.list_select_shield";var anchor=this;var logger=new bbop.logger();logger.DEBUG=true;function ll(str){logger.kvetch("W (list_select_shield): "+str)}var each=bbop.core.each;var uuid=bbop.core.uuid;var default_hash={title:"",blurb:"",title_list:[],list_of_lists:[],action:function(){},width:800};var folding_hash=in_argument_hash||{};var arg_hash=bbop.core.fold(default_hash,folding_hash);var title=arg_hash.title;var blurb=arg_hash.blurb;var title_list=arg_hash.title_list;var list_of_lists=arg_hash.list_of_lists;var action=arg_hash.action;var width=arg_hash.width;var group_cache=[];function _draw_radio_list(list){var list_cache=[];var rdo_grp="bbop_js_lss_"+uuid();group_cache.push(rdo_grp);each(list,function(item){var lbl=item[0];var val=item[1];var ckt=item[2]||false;var rdo_attrs={generate_id:true,name:rdo_grp,type:"radio",value:val};if(ckt){rdo_attrs.checked="checked"}var rdo=new bbop.html.input(rdo_attrs);var rdo_lbl_attrs={"for":rdo.get_id()};var rdo_lbl=new bbop.html.tag("label",rdo_lbl_attrs,"&nbsp;"+lbl);var rdo_span_attrs={};var rdo_span=new bbop.html.span("",rdo_span_attrs);rdo_span.add_to(rdo);rdo_span.add_to(rdo_lbl);list_cache.push(rdo_span)});var ul_list_attrs={generate_id:true,"class":"bbop-js-ui-list-select-shield-list"};var ul_list=new bbop.html.list(list_cache,ul_list_attrs);return ul_list}var div=new bbop.html.tag("div",{generate_id:true});var div_id=div.get_id();jQuery("body").append(div.to_string());jQuery("#"+div_id).append("<p>"+blurb+"</p>");var cont_table_attrs={"class":"bbop-js-ui-list-select-shield-table"};var tbl=new bbop.html.table(title_list,[],cont_table_attrs);var lol_cache=[];each(list_of_lists,function(sub_list){lol_cache.push(_draw_radio_list(sub_list))});tbl.add_to(lol_cache);jQuery("#"+div_id).append(tbl.to_string());var cont_div_attrs={"class":"bbop-js-ui-dialog-button-right",generate_id:true};var cont_div=new bbop.html.tag("div",cont_div_attrs);var cont_btn_attrs={};var cont_btn=new bbop.widget.display.text_button_sim("Continue","Click to continue",null,cont_btn_attrs);cont_div.add_to(cont_btn);jQuery("#"+div_id).append(cont_div.to_string());jQuery("#"+cont_btn.get_id()).click(function(){var selected=[];each(group_cache,function(gname){var find_str="input[name="+gname+"]";var val=null;jQuery(find_str).each(function(){if(this.checked){val=jQuery(this).val()}});selected.push(val)});action(selected);jQuery("#"+div_id).remove()});var diargs={title:title,modal:true,draggable:false,width:width,close:function(){jQuery("#"+div_id).remove()}};var dia=jQuery("#"+div_id).dialog(diargs)};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}bbop.widget.drop_select_shield=function(in_argument_hash){this._is_a="bbop.widget.drop_select_shield";var anchor=this;var logger=new bbop.logger();logger.DEBUG=true;function ll(str){logger.kvetch("W (drop_select_shield): "+str)}var each=bbop.core.each;var uuid=bbop.core.uuid;var default_hash={title:"",blurb:"",pool_list:[],selected_list:[],action_label:"Select",action:function(){},width:800};var folding_hash=in_argument_hash||{};var arg_hash=bbop.core.fold(default_hash,folding_hash);var title=arg_hash.title;var blurb=arg_hash.blurb;var pool_list=arg_hash.pool_list;var selected_list=arg_hash.selected_list;var action_label=arg_hash.action_label;var action=arg_hash.action;var width=arg_hash.width;var rclass="bbop-js-ui-dss-rclass-"+bbop.core.randomness(20);var li_attrs={"class":"ui-state-default bbop-js-ui-hoverable"};var ul_src_list_attrs={generate_id:true,"class":"bbop-js-ui-drop-select-shield "+rclass};var pool_ul_list=new bbop.html.list([],ul_src_list_attrs);each(pool_list,function(item){var lbl=item[0];var val=item[1];li_attrs.value=val;var cntnt='<span class="ui-icon ui-icon-arrow-4"></span> '+lbl+" ("+val+")";var li_elt=new bbop.html.tag("li",li_attrs,cntnt);pool_ul_list.add_to(li_elt)});var ul_target_list_attrs={generate_id:true,"class":"bbop-js-ui-drop-select-shield bbop-js-ui-drop-select-shield-target "+rclass};var selected_ul_list=new bbop.html.list([],ul_target_list_attrs);each(selected_list,function(item){var lbl=item[0];var val=item[1];li_attrs.value=val;var cntnt='<span class="ui-icon ui-icon-arrow-4"></span> '+lbl+" ("+val+")";var li_elt=new bbop.html.tag("li",li_attrs,cntnt);selected_ul_list.add_to(li_elt)});var div=new bbop.html.tag("div",{generate_id:true});var div_id=div.get_id();jQuery("body").append(div.to_string());jQuery("#"+div_id).append("<p>"+blurb+"</p>");var tbl=new bbop.html.table(["Available pool","Selected fields"],[[pool_ul_list,selected_ul_list]],{"class":"bbop-js-ui-drop-select-shield-frame"});jQuery("#"+div_id).append(tbl.to_string());var pul_id=pool_ul_list.get_id();var sul_id=selected_ul_list.get_id();jQuery("#"+pul_id+",#"+sul_id).sortable({connectWith:"."+rclass}).disableSelection();function _get_selected(){var ret_list=[];var selected_strings=jQuery("#"+sul_id).sortable("toArray",{attribute:"value"});each(selected_strings,function(in_thing){if(in_thing&&in_thing!=""){ret_list.push(in_thing)}});return ret_list}var mod_buttons={};mod_buttons[action_label]=function(event){var final_selected=_get_selected();action(final_selected);jQuery("#"+div_id).remove()};mod_buttons.Cancel=function(event,selected_items){jQuery("#"+div_id).remove()};var diargs={title:title,modal:true,draggable:false,width:width,buttons:mod_buttons,close:function(){jQuery(this).remove()}};var dia=jQuery("#"+div_id).dialog(diargs)};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}bbop.widget.search_pane=function(golr_loc,golr_conf_obj,interface_id,in_argument_hash){var logger=new bbop.logger();logger.DEBUG=true;function ll(str){logger.kvetch("SP (widget): "+str)}bbop.golr.manager.jquery.call(this,golr_loc,golr_conf_obj);this._is_a="bbop.widget.search_pane";var anchor=this;this.ui=null;this.user_buttons=[];this.established_p=false;this.initial_reset_p=true;this.initial_reset_callback=function(response,manager){ll("empty first run")};function _button_wrapper(str,title){var b=new bbop.widget.display.text_button_sim(str,title,"");return b.to_string()}var default_hash={linker:new bbop.linker(),handler:new bbop.handler(),show_searchbox_p:true,show_filterbox_p:true,show_pager_p:true,show_checkboxes_p:true,spinner_search_source:"",spinner_shield_source:"",spinner_shield_message:null,icon_clear_label:_button_wrapper("X","Clear text from query"),icon_clear_source:"",icon_reset_label:_button_wrapper("!","Reset user query filters"),icon_reset_source:"",icon_positive_label:_button_wrapper("+","Add positive filter"),icon_positive_source:"",icon_negative_label:_button_wrapper("-","Add negative filter"),icon_negative_source:"",icon_remove_label:_button_wrapper("X","Remove filter from query"),icon_remove_source:""};var folding_hash=in_argument_hash||{};var arg_hash=bbop.core.fold(default_hash,folding_hash);var linker=arg_hash.linker;var handler=arg_hash.handler;var show_searchbox_p=arg_hash.show_searchbox_p;var show_filterbox_p=arg_hash.show_filterbox_p;var show_pager_p=arg_hash.show_pager_p;var show_checkboxes_p=arg_hash.show_checkboxes_p;var spinner_search_source=arg_hash.spinner_search_source;var spinner_shield_source=arg_hash.spinner_shield_source;var spinner_shield_message=arg_hash.spinner_shield_message;var icon_clear_label=arg_hash.icon_clear_label;var icon_clear_source=arg_hash.icon_clear_source;var icon_reset_label=arg_hash.icon_reset_label;var icon_reset_source=arg_hash.icon_reset_source;var icon_positive_label=arg_hash.icon_positive_label;var icon_positive_source=arg_hash.icon_positive_source;var icon_negative_label=arg_hash.icon_negative_label;var icon_negative_source=arg_hash.icon_negative_source;var icon_remove_label=arg_hash.icon_remove_label;var icon_remove_source=arg_hash.icon_remove_source;this.establish_display=function(){jQuery("#"+interface_id).empty();var personality=anchor.get_personality();var cclass=golr_conf_obj.get_class(personality);if(!personality||!cclass){ll("ERROR: no usable personality set");throw new Error("ERROR: no useable personality set")}anchor.ui=new bbop.widget.display.live_search(interface_id,cclass);anchor.ui.set_linker(linker);anchor.ui.set_handler(handler);anchor.ui.set_buttons(anchor.user_buttons);if(show_checkboxes_p){anchor.ui.show_checkboxes_p(true)}if(show_searchbox_p){anchor.register("reset","reset_query",anchor.ui.reset_query,-1)}if(show_filterbox_p){anchor.register("reset","sticky_first",anchor.ui.draw_sticky_filters,-1);anchor.register("reset","curr_first",anchor.ui.draw_current_filters,-1);anchor.register("reset","accordion_first",anchor.ui.draw_accordion,-1)}anchor.register("reset","meta_first",anchor.ui.draw_meta,-1);anchor.register("reset","results_first",anchor.ui.draw_results,-1);function _initial_runner(response,manager){if(anchor.initial_reset_p){anchor.initial_reset_p=false;anchor.initial_reset_callback(response,manager)}}anchor.register("reset","initial_reset",_initial_runner,-100);if(show_searchbox_p){anchor.register("search","draw_query",anchor.ui.draw_query,-1)}if(show_filterbox_p){anchor.register("search","sticky_filters_std",anchor.ui.draw_sticky_filters);anchor.register("search","curr_filters_std",anchor.ui.draw_current_filters);anchor.register("search","accordion_std",anchor.ui.draw_accordion)}anchor.register("search","meta_usual",anchor.ui.draw_meta);anchor.register("search","results_usual",anchor.ui.draw_results);anchor.register("error","results_unusual",anchor.ui.draw_error);if(show_searchbox_p){anchor.ui.setup_query("Free-text filtering",icon_clear_label,icon_clear_source)}if(show_filterbox_p){anchor.ui.setup_sticky_filters();anchor.ui.setup_current_filters(icon_remove_label,icon_remove_source);anchor.ui.setup_accordion(icon_positive_label,icon_positive_source,icon_negative_label,icon_negative_source,spinner_shield_source,spinner_shield_message)}anchor.ui.setup_results({meta:show_pager_p,spinner_source:spinner_search_source});anchor.established_p=true};this.get_selected_items=function(){var retval=null;var gname=anchor.ui.selected_name();if(gname){retval=[];var total_count=0;var nstr="input[name="+gname+"]";jQuery(nstr).each(function(){if(this.checked){var val=jQuery(this).val();retval.push(val)}total_count++});if(total_count>0&&total_count==retval.length){alert('You can "select" all of the items on a results page by not selecting any (all being the default). This will also get your results processed faster and cause significantly less overhead on the servers.');retval=[]}}return retval};this.add_button=function(button_definition_hash){anchor.user_buttons.push(button_definition_hash);if(anchor.established_p&&anchor.ui){anchor.ui.set_buttons(anchor.user_buttons);anchor.ui.draw_user_buttons(anchor)}};this.clear_buttons=function(){anchor.user_buttons=[];if(anchor.established_p&&anchor.ui){anchor.ui.set_buttons(anchor.user_buttons);anchor.ui.draw_user_buttons(anchor)}};this.set_query_field_text=function(query){var retval=false;if(anchor.established_p&&anchor.ui){retval=anchor.ui.set_query_field(query)}return retval};this.set_initial_reset_callback=function(callback){anchor.initial_reset_callback=callback}};bbop.core.extend(bbop.widget.search_pane,bbop.golr.manager.jquery);if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}bbop.widget.live_filters=function(interface_id,manager,golr_conf_obj,in_argument_hash){this._is_a="bbop.widget.live_filters";var anchor=this;var each=bbop.core.each;var ui_icon_positive_label="&plus;";var ui_icon_positive_source=null;var ui_icon_negative_label="&minus;";var ui_icon_negative_source=null;var ui_icon_remove_label="&minus;";var ui_icon_remove_source=null;var ui_spinner_shield_source=null;var ui_spinner_shield_message="";var logger=new bbop.logger();logger.DEBUG=false;function ll(str){logger.kvetch("LF: "+str)}var default_hash={meta_label:"Documents:&nbsp;",display_meta_p:true,display_free_text_p:true,free_text_placeholder:"Free-text filter",display_accordion_p:true,minimum_free_text_length:3,on_update_callback:function(){}};var folding_hash=in_argument_hash||{};var arg_hash=bbop.core.fold(default_hash,folding_hash);this._interface_id=interface_id;this._display_meta_p=arg_hash.display_meta_p;this._meta_label=arg_hash.meta_label;this._display_free_text_p=arg_hash.display_free_text_p;this._free_text_placeholder=arg_hash.free_text_placeholder;this._display_accordion_p=arg_hash.display_accordion_p;this._minimum_free_text_length=arg_hash.minimum_free_text_length;this._on_update_callback=arg_hash.on_update_callback;anchor._established_p=false;var ui_div_id=this._interface_id;var mangle=ui_div_id+"_ui_element_"+bbop.core.uuid()+"_";var container_div_id=mangle+"container-id";var meta_div_id=mangle+"meta-id";var meta_count_id=mangle+"meta-count-id";var meta_wait_id=mangle+"meta-wait-id";var query_input_div_id=mangle+"query-id";var sticky_filters_div_id=mangle+"sticky_filters-id";var sticky_title_id=mangle+"sticky_filters-title-id";var sticky_content_id=mangle+"sticky_filters-content-id";var current_filters_div_id=mangle+"current_filters-id";var current_title_id=mangle+"current_filters-title-id";var current_content_id=mangle+"current_filters-content-id";var clear_user_filter_span_id=mangle+"clear-user-filter-id";var filters_div_id=mangle+"ui-filters-wrapper";var clear_query_span_id=mangle+"clear-query-id";var container_div=new bbop.html.tag("div",{id:container_div_id});jQuery("#"+ui_div_id).empty();jQuery("#"+ui_div_id).append(container_div.to_string());var filter_accordion_widget=null;var spinner_div=null;function _spin_up(){if(spinner_div){jQuery("#"+spinner_div.get_id()).removeClass("hidden");jQuery("#"+spinner_div.get_id()).addClass("active")}}function _spin_down(){if(spinner_div){jQuery("#"+spinner_div.get_id()).addClass("hidden");jQuery("#"+spinner_div.get_id()).removeClass("active")}}this.spin_up=function(){_spin_up()};this.spin_down=function(){_spin_down()};this.establish_display=function(){var personality=manager.get_personality();var cclass=golr_conf_obj.get_class(personality);if(!personality||!cclass){ll("ERROR: no usable personality set");throw new Error("ERROR: no useable personality set")}this.setup_meta=function(){ll("setup_meta for: "+meta_div_id);var ms_attrs={id:meta_count_id,"class":"badge"};var ms=new bbop.html.tag("span",ms_attrs,"n/a");var inspan=new bbop.html.tag("span",{"class":"sr-only"},"...");var indiv=new bbop.html.tag("div",{"class":"progress-bar",role:"progressbar","aria-valuenow":"100","aria-valuemin":"0","aria-valuemax":"100",style:"width: 100%;"},inspan);spinner_div=new bbop.html.tag("div",{generate_id:true,"class":"progress progress-striped active pull-right",style:"width: 3em;"},indiv);var mdiv_args={"class":"well well-sm",id:meta_div_id};var mdiv=new bbop.html.tag("div",mdiv_args,[this._meta_label,ms,spinner_div]);jQuery("#"+container_div.get_id()).append(mdiv.to_string())};if(this._display_meta_p){this.setup_meta()}this.setup_query=function(){ll("setup_query for: "+query_input_div_id);var query_label_attrs={};var query_label_div=new bbop.html.tag("div",query_label_attrs);var ta_args={placeholder:this._free_text_placeholder,"class":"form-control bbop-js-live-filters-textarea",rows:"1",id:query_input_div_id};var query_area=new bbop.html.tag("textarea",ta_args);var clear_query_obj=bbop.widget.display.clickable_object(null);var clear_div_attrs={generate_id:true};var clear_div=new bbop.html.tag("div",clear_div_attrs,clear_query_obj);var gen_div_attrs={"class":"panel panel-default",generate_id:true};var gen_div=new bbop.html.tag("div",gen_div_attrs);query_label_div.add_to(clear_div.to_string());gen_div.add_to(query_label_div.to_string());gen_div.add_to(query_area.to_string());jQuery("#"+container_div.get_id()).append(gen_div.to_string())};if(this._display_free_text_p){this.setup_query()}this.setup_sticky_filters=function(){ll("setup_sticky_filters UI for class configuration: "+cclass.id());var scont_attrs={"class":"panel-body",id:sticky_content_id};var scont=new bbop.html.tag("div",scont_attrs,"No applied sticky filters");var sticky_filters_attrs={"class":"panel panel-default",id:sticky_filters_div_id};var sticky_filters_div=new bbop.html.tag("div",sticky_filters_attrs,scont);var sticky_filters_str=sticky_filters_div.to_string();jQuery("#"+container_div.get_id()).append(sticky_filters_str)};this.setup_current_filters=function(){ll("setup_current_filters UI for class configuration: "+cclass.id());var ccont_attrs={"class":"panel-body",id:current_content_id};var ccont=new bbop.html.tag("div",ccont_attrs,"No applied user filters");var current_filters_attrs={"class":"panel panel-default",id:current_filters_div_id};var current_filters_div=new bbop.html.tag("div",current_filters_attrs,ccont);var current_filters_str=current_filters_div.to_string();jQuery("#"+container_div.get_id()).append(current_filters_str)};this.setup_accordion=function(){ll("setup_accordion UI for class configuration: "+cclass.id());var filter_accordion_attrs={id:filters_div_id};filter_accordion_widget=new bbop.html.collapsible([],filter_accordion_attrs);var field_list=cclass.field_order_by_weight("filter");each(field_list,function(in_field){ll("saw field: "+in_field);var ifield=cclass.get_field(in_field);var in_attrs={id:in_field,label:ifield.display_name(),description:ifield.description()};filter_accordion_widget.add_to(in_attrs,"",true)});var accordion_str=filter_accordion_widget.to_string();jQuery("#"+container_div_id).append(accordion_str)};if(this._display_accordion_p){this.setup_current_filters();this.setup_sticky_filters();this.setup_accordion()}this.draw_meta=function(response,manager){ll("draw_meta for: "+meta_div_id);var total_c=response.total_documents();jQuery("#"+meta_count_id).empty();jQuery("#"+meta_count_id).append(total_c)};if(this._display_meta_p){manager.register("search","meta_first",this.draw_meta,-1)}function _ignorable_event(event){var retval=false;if(event){var kc=event.keyCode;if(kc){if(kc==39||kc==37||kc==32||kc==20||kc==17||kc==16||kc==0){ll("ignorable key event: "+kc);retval=true}}}return retval}this.draw_query=function(response,manager){ll("draw_query for: "+query_input_div_id);jQuery("#"+query_input_div_id).unbind("keyup");jQuery("#"+query_input_div_id).keyup(function(event){if(!_ignorable_event(event)){var tmp_q=manager.get_query();var input_text=jQuery(this).val();manager.set_query(input_text);if(manager.sensible_query_p()){ll("keeping set query: "+input_text);manager.set_comfy_query(input_text);manager.search();_spin_up()}else{ll("rolling back query: "+tmp_q);manager.set_query(tmp_q)}}});jQuery("#"+clear_query_span_id).unbind("click");jQuery("#"+clear_query_span_id).click(function(){manager.reset_query();manager.set_query_field("");manager.search();_spin_up()})};if(this._display_free_text_p){manager.register("search","query_first",this.draw_query,0)}this.draw_accordion=function(response,manager){ll("draw_accordion for: "+filters_div_id);if(typeof(filter_accordion_widget)=="undefined"){throw new Error("Need to init accordion widget to use it.")}var real_facet_limit=manager.get_facet_limit();var curr_facet_limit=real_facet_limit-1;var total_docs=response.total_documents();function _nothing_to_see_here(in_field){var section_id=filter_accordion_widget.get_section_id(in_field);jQuery("#"+section_id).empty();jQuery("#"+section_id).append("Nothing to filter.")}var button_hash={};var overflow_hash={};each(response.facet_field_list(),function(in_field){var facet_bd=response.facet_field(in_field);if(bbop.core.is_empty(facet_bd)){_nothing_to_see_here(in_field)}else{var tbl_id=mangle+"filter-list-"+in_field;var facet_list_tbl_attrs={"class":"table table-hover table-striped table-condensed",id:tbl_id};var facet_list_tbl=new bbop.html.table([],[],facet_list_tbl_attrs);ll("consider:"+in_field+": "+response.facet_field(in_field).length);var redundant_count=0;var good_count=0;var overflow_p=false;each(response.facet_field(in_field),function(ff_field,ff_index){var f_name=ff_field[0];var f_count=ff_field[1];if(f_count==total_docs){redundant_count++}else{if(!f_name||f_name==""){}else{if(ff_index<real_facet_limit-1){good_count++;var b_plus=new bbop.html.button(ui_icon_positive_label,{generate_id:true,type:"button","class":"btn btn-success btn-xs"});var b_minus=new bbop.html.button(ui_icon_negative_label,{generate_id:true,type:"button","class":"btn btn-danger btn-xs"});button_hash[b_plus.get_id()]=[in_field,f_name,f_count,"+"];button_hash[b_minus.get_id()]=[in_field,f_name,f_count,"-"];facet_list_tbl.add_to([f_name,"("+f_count+")",b_plus.to_string(),b_minus.to_string()])}}}if(ff_index==real_facet_limit-1){overflow_p=true;var b_over=new bbop.html.button("more...",{generate_id:true,type:"button",title:"Display the complete list","class":"btn btn-primary btn-xs"});facet_list_tbl.add_to([b_over.to_string(),"",""]);overflow_hash[b_over.get_id()]=in_field}});if(good_count==0&&!overflow_p){_nothing_to_see_here(in_field)}else{var sect_id=filter_accordion_widget.get_section_id(in_field);jQuery("#"+sect_id).empty();var warn_txt=null;if(redundant_count==1){warn_txt="field is"}else{if(redundant_count>1){warn_txt="fields are"}}if(warn_txt){jQuery("#"+sect_id).append("<small> The top ("+redundant_count+") redundant "+warn_txt+" not shown</small>")}var final_tbl_str=facet_list_tbl.to_string();jQuery("#"+sect_id).append(final_tbl_str)}}});function filter_select_live(button_id,create_time_button_props){var in_polarity=create_time_button_props[3];var b_ui_icon="ui-icon-plus";if(in_polarity=="-"){b_ui_icon="ui-icon-minus"}var b_ui_props={icons:{primary:b_ui_icon},text:false};jQuery("#"+button_id).click(function(){var tid=jQuery(this).attr("id");var call_time_button_props=button_hash[tid];var call_field=call_time_button_props[0];var call_filter=call_time_button_props[1];var call_polarity=call_time_button_props[3];manager.add_query_filter(call_field,call_filter,[call_polarity]);manager.search();_spin_up()})}each(button_hash,filter_select_live);each(overflow_hash,function(button_id,filter_name){jQuery("#"+button_id).click(function(){var tid=jQuery(this).attr("id");var call_time_field_name=overflow_hash[tid];manager.set_facet_limit(0);manager.set_facet_limit(call_time_field_name,-1);var curr_row=manager.get("rows");manager.set("rows",0);var fs=bbop.widget.display.filter_shield;var filter_shield=new fs(ui_spinner_shield_source,ui_spinner_shield_message);filter_shield.start_wait();function draw_shield(resp){var fina=call_time_field_name;var flist=resp.facet_field(call_time_field_name);filter_shield.draw(fina,flist,manager)}manager.fetch(draw_shield);manager.reset_facet_limit();manager.set("rows",curr_row)})});ll("Done current accordion for: "+filters_div_id)};this.draw_current_filters=function(response,manager){ll("draw_current_filters for: "+current_filters_div_id);var b_cf=new bbop.html.button("&times;",{type:"button",id:clear_user_filter_span_id,"class":"btn btn-danger btn-xs",title:"Clear all user filters"});var in_query_filters=response.query_filters();ll("filters: "+bbop.core.dump(in_query_filters));var fq_list_tbl=new bbop.html.table(["","User filters",b_cf.to_string()],[],{"class":"table table-hover table-striped table-condensed"});var has_fq_p=false;var button_hash={};each(in_query_filters,function(field,field_vals){each(field_vals,function(field_val,polarity){var qfp=manager.get_query_filter_properties(field,field_val);if(!qfp||qfp.sticky_p==false){has_fq_p=true;var polstr="&minus;";if(polarity){polstr="&plus;"}var b=new bbop.html.button(ui_icon_remove_label,{generate_id:true,type:"button",title:"Remove filter","class":"btn btn-danger btn-xs"});var bid=b.get_id();button_hash[bid]=[polstr,field,field_val];fq_list_tbl.add_to(["<strong>"+polstr+"</strong>",field+": "+field_val,b.to_string()])}})});var cfid="#"+current_content_id;jQuery(cfid).empty();if(!has_fq_p){jQuery(cfid).append("No current user filters.")}else{jQuery(cfid).append(fq_list_tbl.to_string());jQuery("#"+b_cf.get_id()).click(function(){manager.reset_query_filters();manager.search();_spin_up()});each(button_hash,function(button_id){var bid=button_id;jQuery("#"+bid).click(function(){var tid=jQuery(this).attr("id");var button_props=button_hash[tid];var polstr=button_props[0];var field=button_props[1];var value=button_props[2];manager.remove_query_filter(field,value);manager.search();_spin_up()})})}};this.draw_sticky_filters=function(response,manager){ll("draw_sticky_filters for: "+sticky_filters_div_id);var sticky_query_filters=manager.get_sticky_query_filters();ll("sticky filters: "+bbop.core.dump(sticky_query_filters));var fq_list_tbl=new bbop.html.table(["","Your search is pinned to these filters"],[],{"class":"table table-hover table-striped table-condensed"});each(sticky_query_filters,function(fset){var sfield=fset.filter;var sfield_val=fset.value;var polarity=fset.negative_p;var polstr="&minus;";if(polarity){polstr="&plus;"}var label_str=polstr+" "+sfield+":"+sfield_val;fq_list_tbl.add_to(["<b>"+polstr+"</b>",sfield+": "+sfield_val])});var sfid="#"+sticky_content_id;jQuery(sfid).empty();if(sticky_query_filters.length==0){jQuery(sfid).append("No sticky filters.")}else{jQuery(sfid).append(fq_list_tbl.to_string())}};if(this._display_accordion_p){manager.register("search","accrdn_first",this.draw_accordion,1);manager.register("search","current_first",this.draw_current_filters,2);manager.register("search","sticky_first",this.draw_sticky_filters,3)}this.draw_error=function(error_message,manager){ll("draw_error: "+error_message);alert("Runtime error: "+error_message);_spin_down()};manager.register("error","error_first",this.draw_error,0);function spin_down_wait(){_spin_down()}manager.register("search","donedonedone",spin_down_wait,-100);anchor._established_p=true}};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}bbop.widget.live_pager=function(interface_id,manager,in_argument_hash){this._is_a="bbop.widget.live_pager";var anchor=this;var each=bbop.core.each;function ll(str){console.log(str)}var ui_count_control_div_id=interface_id+"_countctl_div_"+bbop.core.uuid();var external_button_location_id="pager_button_holder_"+bbop.core.uuid();var default_hash={callback_priority:0,selection_counts:[10,25,50,100]};var folding_hash=in_argument_hash||{};var arg_hash=bbop.core.fold(default_hash,folding_hash);var callback_priority=arg_hash.callback_priority;var selection_counts=arg_hash.selection_counts;var fun_id=bbop.core.uuid();manager.register("search",fun_id,_repaint_on_callback,callback_priority);function _disable_if(bttn,disbool){if(disbool){jQuery("#"+bttn.get_id()).attr("disabled","disabled")}}function _repaint_on_callback(response,manager){var total_c=response.total_documents();var first_d=response.start_document();var last_d=response.end_document();jQuery("#"+interface_id).empty();if(total_c==0){jQuery("#"+interface_id).append("No results found.")}else{var mdiv_attrs={"class":"row",generate_id:true};var mdiv=new bbop.html.tag("div",mdiv_attrs);var dmeta_attrs={generate_id:true,"class":"col-xs-6 col-sm-6 col-md-4 col-lg-4"};var dmeta=new bbop.html.tag("div",dmeta_attrs);dmeta.add_to("<div>Total: "+total_c+"; showing: "+first_d+"-"+last_d+"</div>");mdiv.add_to(dmeta);var sel_label_attrs={};var sel_label=new bbop.html.tag("span",sel_label_attrs,"Results&nbsp;count&nbsp;&nbsp;");var cinputs=[];each(selection_counts,function(num,cindex){var sel_input_attrs={generate_id:true,value:num};var sel_input=new bbop.html.tag("option",sel_input_attrs,num);var sel_input_id=sel_input.get_id();cinputs.push(sel_input)});var sel_attrs={id:ui_count_control_div_id,style:"width: 5em;"};var sel=new bbop.html.tag("select",sel_attrs,cinputs);var sel_div_attrs={generate_id:true};var sel_div=new bbop.html.tag("div",sel_div_attrs);sel_div.add_to(sel_label);sel_div.add_to(sel);dmeta.add_to(sel_div);jQuery("#"+interface_id).append(mdiv.to_string());jQuery("#"+ui_count_control_div_id).unbind("change");var step=response.row_step();jQuery("#"+ui_count_control_div_id).val(step);jQuery("#"+ui_count_control_div_id).change(function(event,ui){var sv=jQuery("#"+ui_count_control_div_id).val();if(bbop.core.is_defined(sv)){var si=parseInt(sv);manager.set_results_count(si);manager.search()}});var bdiv_attrs={"class":"col-xs-12 col-sm-12 col-md-8 col-lg-8",generate_id:true};var bdiv=new bbop.html.tag("div",bdiv_attrs);jQuery("#"+mdiv.get_id()).append(bdiv.to_string());var bdiv_id=bdiv.get_id();var bopts={generate_id:true,"class":"btn btn-primary"};var b_first=new bbop.html.button("&laquo;First",bopts);jQuery("#"+bdiv_id).append(b_first.to_string());var b_back=new bbop.html.button("&lt;Prev",bopts);jQuery("#"+bdiv_id).append(b_back.to_string());var b_forward=new bbop.html.button("Next&gt;",bopts);jQuery("#"+bdiv_id).append(b_forward.to_string());var b_last=new bbop.html.button("Last&raquo;",bopts);jQuery("#"+bdiv_id).append(b_last.to_string());var b_first_disabled_p=false;var b_back_disabled_p=false;var b_forward_disabled_p=false;var b_last_disabled_p=false;if(!response.paging_p()){b_first_disabled_p=true;b_back_disabled_p=true;b_forward_disabled_p=true;b_last_disabled_p=true}if(!response.paging_previous_p()){b_first_disabled_p=true;b_back_disabled_p=true}if(!response.paging_next_p()){b_forward_disabled_p=true;b_last_disabled_p=true}_disable_if(b_first,b_first_disabled_p);jQuery("#"+b_first.get_id()).click(function(){manager.page_first()});_disable_if(b_back,b_back_disabled_p);jQuery("#"+b_back.get_id()).click(function(){manager.page_previous()});_disable_if(b_forward,b_forward_disabled_p);jQuery("#"+b_forward.get_id()).click(function(){manager.page_next()});_disable_if(b_last,b_last_disabled_p);jQuery("#"+b_last.get_id()).click(function(){manager.page_last(total_c)});var holder_attrs={id:external_button_location_id};var holder=new bbop.html.tag("span",holder_attrs);jQuery("#"+bdiv_id).append("&nbsp;"+holder.to_string())}}anchor.button_span_id=function(){return external_button_location_id}};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}bbop.widget.live_results=function(interface_id,manager,conf_class,handler,linker,in_argument_hash){this._is_a="bbop.widget.live_results";var anchor=this;var each=bbop.core.each;var logger=new bbop.logger();logger.DEBUG=false;function ll(str){logger.kvetch("LR: "+str)}var results_table=null;var local_mangle=bbop.core.uuid();var select_column_id="rtbcc_select_"+local_mangle;var select_item_name="rtbcc_select_name_"+local_mangle;var default_hash={callback_priority:0,user_buttons:[],user_buttons_div_id:null,selectable_p:true};var folding_hash=in_argument_hash||{};var arg_hash=bbop.core.fold(default_hash,folding_hash);var callback_priority=arg_hash.callback_priority;var user_buttons=arg_hash.user_buttons;var user_buttons_div_id=arg_hash.user_buttons_div_id;var selectable_p=arg_hash.selectable_p;var fun_id=bbop.core.uuid();function _disable_if(bttn,disbool){if(disbool){jQuery("#"+bttn.get_id()).attr("disabled","disabled")}}function _draw_user_buttons(button_definitions,loc_id){function _button_rollout(button_def_hash){var default_hash={label:"?",disabled_p:false,click_function_generator:function(anchor,manager){return function(anchor,manager){alert("No callback defined for this button--the generator may have been empty!")}}};var folding_hash=button_def_hash||{};var arg_hash=bbop.core.fold(default_hash,folding_hash);var label=arg_hash.label;var disabled_p=arg_hash.disabled_p;var click_function_generator=arg_hash.click_function_generator;var b_props={generate_id:true,"class":"btn btn-primary"};var b=new bbop.html.button(label,b_props);jQuery("#"+loc_id).append(b.to_string());_disable_if(b,disabled_p);var click_fun=click_function_generator(anchor,manager);jQuery("#"+b.get_id()).click(click_fun)}if(!jQuery("#"+loc_id)){alert("cannot refresh buttons without a place to draw them")}else{jQuery("#"+loc_id).empty();bbop.core.each(button_definitions,_button_rollout)}}function _draw_table_or_something(resp,manager){jQuery("#"+interface_id).empty();if(!resp.success()||resp.total_documents()==0){jQuery("#"+interface_id).append("<em>No results given your input and search fields. Please refine and try again.</em>")}else{if(user_buttons&&user_buttons.length&&user_buttons.length>0){var insert_div_id=user_buttons_div_id;if(!user_buttons_div_id){var ubt_attrs={generate_id:true};var ubt=new bbop.html.tag("div",ubt_attrs);jQuery("#"+interface_id).append(ubt.to_string());insert_div_id=ubt.get_id()}_draw_user_buttons(user_buttons,insert_div_id)}var bwd=bbop.widget.display;results_table=new bwd.results_table_by_class_conf_b3(conf_class,resp,linker,handler,interface_id,selectable_p,select_column_id,select_item_name)}}manager.register("search",fun_id,_draw_table_or_something,callback_priority);function _draw_error(error_message,manager){ll("draw_error: "+error_message);alert("Runtime error: "+error_message)}manager.register("error",fun_id,_draw_error,callback_priority);this.item_name=function(){return select_item_name};this.toggle_id=function(){return select_column_id};this.get_selected_items=function(){var retval=null;if(selectable_p){retval=[];var total_count=0;var nstr="input[name="+select_item_name+"]";jQuery(nstr).each(function(){if(this.checked){var val=jQuery(this).val();retval.push(val)}total_count++});if(total_count>0&&total_count==retval.length){alert('You can "select" all of the items on a results page by not selecting any (all being the default). This will also get your results processed faster and cause significantly less overhead on the servers.');retval=[]}}return retval}};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}bbop.widget.repl=function(interface_id,initial_commands,in_argument_hash){this._is_a="bbop.widget.repl";var anchor=this;var loop=bbop.core.each;var default_hash={buffer_id:null,cli_id:null,display_initial_commands_p:true};var folding_hash=in_argument_hash||{};var arg_hash=bbop.core.fold(default_hash,folding_hash);var in_buffer_id=arg_hash.buffer_id;var in_cli_id=arg_hash.cli_id;var display_initial_commands_p=arg_hash.display_initial_commands_p;var init_buffer=initial_commands||[];var repl_id=interface_id;jQuery("#"+repl_id).empty();var history_pointer=0;var history_list=[""];var command_buffer_args={rows:"12",cols:"80"};if(in_buffer_id){command_buffer_args.id=in_buffer_id}else{command_buffer_args.generate_id=true}var command_buffer=new bbop.html.tag("textarea",command_buffer_args,init_buffer.join("\n"));jQuery("#"+repl_id).append(command_buffer.to_string());jQuery("#"+repl_id).append("<br />");var command_buffer_button=new bbop.html.button("Evaluate buffer",{generate_id:true});jQuery("#"+repl_id).append(command_buffer_button.to_string());var clear_buffer_button=new bbop.html.button("Clear buffer",{generate_id:true});jQuery("#"+repl_id).append(clear_buffer_button.to_string());var clear_log_button=new bbop.html.button("Clear log",{generate_id:true});jQuery("#"+repl_id).append(clear_log_button.to_string());jQuery("#"+repl_id).append("<br />");var logging_console_id="bbop-logger-console-html";var logging_console=new bbop.html.tag("div",{id:logging_console_id,"class":"nowrap",style:"height: 7em; width: 40em; border: 1px solid #888888; overflow: auto;"});jQuery("#"+repl_id).append(logging_console.to_string());var cli_msg=new bbop.html.tag("span",{},"[eval: return; ctrl+up/down: history]:");jQuery("#"+repl_id).append(cli_msg.to_string());jQuery("#"+repl_id).append("<br />");var command_line_args={rows:"1",cols:"80"};if(in_cli_id){command_line_args.id=in_cli_id}else{command_line_args.generate_id=true}var command_line=new bbop.html.tag("textarea",command_line_args);jQuery("#"+repl_id).append(command_line.to_string());var rlogger=new bbop.logger();rlogger.DEBUG=true;function log(str){rlogger.kvetch(str)}function _advance_log_to_bottom(){}function _evaluate(to_eval){var retval=null;var retval_str="";var okay_p=true;try{retval=window.eval(to_eval);if(bbop.core.is_defined(retval)){if(bbop.core.what_is(retval)=="string"){retval_str='"'+retval+'"'}else{retval_str=retval}}else{retval_str=""}}catch(x){retval=null;retval_str="[n/a]";okay_p=false}return[retval,retval_str,okay_p]}function _update_cli(){var item=history_list[history_pointer];jQuery("#"+command_line.get_id()).val(item)}function read_cli(event){var which=event.which;var ctrl_p=event.ctrlKey;if(which==13){event.preventDefault();var to_eval=jQuery("#"+command_line.get_id()).val();if(to_eval!=""){jQuery("#"+command_line.get_id()).val("");history_list.pop();history_list.push(to_eval);history_list.push("");history_pointer=history_list.length-1;to_eval=bbop.core.ensure(to_eval,";","back");log(to_eval);var evals=_evaluate(to_eval);log("// "+evals[1]);_advance_log_to_bottom();return false}}else{if(ctrl_p&&which==38){event.preventDefault();if(history_pointer==0){_update_cli()}else{if(history_pointer>0){history_pointer--;_update_cli()}}return false}else{if(ctrl_p&&which==40){event.preventDefault();if(history_pointer<history_list.length-1){history_pointer++;_update_cli()}return false}}}return true}jQuery("#"+command_line.get_id()).keydown(read_cli);function read_buffer(){var to_eval=jQuery("#"+command_buffer.get_id()).val();if(to_eval!=""){log("// Evaluating buffer...");var evals=_evaluate(to_eval);log("// "+evals[1]);_advance_log_to_bottom()}}var cbbid="#"+command_buffer_button.get_id();var command_buffer_button_props={icons:{primary:"ui-icon-play"},disabled:false,text:true};jQuery(cbbid).button(command_buffer_button_props).click(read_buffer);function clear_buffer(){jQuery("#"+command_buffer.get_id()).val("")}var cbuid="#"+clear_buffer_button.get_id();var clear_buffer_button_props={icons:{primary:"ui-icon-trash"},disabled:false,text:true};jQuery(cbuid).button(clear_buffer_button_props).click(clear_buffer);function clear_log(){jQuery("#"+logging_console_id).empty()}var clbid="#"+clear_log_button.get_id();var clear_log_button_props={icons:{primary:"ui-icon-trash"},disabled:false,text:true};jQuery(clbid).button(clear_log_button_props).click(clear_log);jQuery(cbbid).click();if(display_initial_commands_p==false){clear_buffer();clear_log()}log("// [Session start.]");this.get_id=function(str){var retval=null;if(str){if(str=="buffer"){retval=command_buffer.get_id()}}return retval};this.replace_buffer_text=function(str){clear_buffer();jQuery("#"+command_buffer.get_id()).val(str)};this.advance_log_to_bottom=function(){_advance_log_to_bottom()};this.destroy=function(){jQuery("#"+anchor._interface_id).val("")}};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}if(typeof bbop.widget.phylo_old=="undefined"){bbop.widget.phylo_old={}}bbop.widget.phylo_old.renderer=function(element_id,info_box_p){var logger=new bbop.logger();logger.DEBUG=true;function ll(str){logger.kvetch(str)}var elt_id=element_id;var renderer_context=this;this.animation_time=200;this.use_animation=false;this.box_width=60;this.box_height=30;this._render_frame_width=800;this._render_interal_width=this._render_frame_width;this._render_frame_height=600;this._render_internal_height=this._render_height;var node_cache_hash={};this._graph=new bbop.model.tree.graph();this.add_node=function(node){var nid=node.id();node_cache_hash[nid]=node;this._graph.add_node(node)};this.add_edge=function(edge){var retval=false;var n1=node_cache_hash[edge.subject_id()];var n2=node_cache_hash[edge.object_id()];if(n1&&n2){this._graph.add_edge(edge);retval=true}return retval};graph_pnode=function(context,label,px,py,internal_p){var pnode_box_width=renderer_context.box_width;var pnode_box_height=renderer_context.box_height;var text_offset_x=pnode_box_width/2;var text_offset_y=pnode_box_height/2;this.base_node_color="#00f";if(internal_p){pnode_box_width=pnode_box_width/2;pnode_box_width=2;text_offset_x=(pnode_box_width/2)}this.visible=true;this.open=true;this.shape_base_attr={fill:this.base_node_color,"fill-opacity":0.05,opacity:1,stroke:this.base_node_color,"stroke-width":2,title:"This is "+label,cursor:"move"};this.shape_highlight_attr={fill:this.base_node_color,"fill-opacity":0.5,opacity:1,stroke:this.base_node_color,"stroke-width":3};this.shape_dim_attr={fill:this.base_node_color,"fill-opacity":0,opacity:0.5,stroke:this.base_node_color,"stroke-width":1};this.shape_invisible_attr={fill:"#000","fill-opacity":0,opacity:0,stroke:"#000","stroke-width":0};this.text_base_attr={opacity:1,"font-size":10};this.text_highlight_attr={opacity:1,"font-size":10};this.text_dim_attr={opacity:0.2,"font-size":10};this.text_invisible_attr={opacity:0,"font-size":10};this._context=context;this._text=this._context.text(px+text_offset_x,py+text_offset_y,label);this._text.toBack();this._shape=this._context.rect(px,py,pnode_box_width,pnode_box_height,2);this.id=this._shape.id;this.getBBox=function(){return this._shape.getBBox.call(this._shape)};this.shape_attr=function(arg){return this._shape.attr.call(this._shape,arg)};this._start_shape_y=this._shape.attr("y");this._start_text_y=this._text.attr("y");this._shape.attr(this.shape_base_attr)};graph_pnode.prototype.update_position=function(){this._start_shape_y=this._shape.attr("y");this._start_text_y=this._text.attr("y")};graph_pnode.prototype.move_y=function(arg){var d_shape=this._start_shape_y+arg;var d_text=this._start_text_y+arg;this._shape.attr.call(this._shape,{y:d_shape});this._text.attr.call(this._text,{y:d_text})};graph_pnode.prototype.drag=function(mv_func,start_func,end_func){this._shape.drag(mv_func,start_func,end_func)};graph_pnode.prototype.dblclick=function(handler){this._shape.dblclick.call(this._shape,handler)};graph_pnode.prototype.mouseover=function(handler){this._shape.mouseover.call(this._shape,handler)};graph_pnode.prototype.mouseout=function(handler){this._shape.mouseout.call(this._shape,handler)};graph_pnode.prototype.update=function(message){var shape_attr_to_apply=this.shape_base_attr;var text_attr_to_apply=this.text_base_attr;if(this.visible==false){shape_attr_to_apply=this.shape_invisible_attr;text_attr_to_apply=this.text_invisible_attr}else{if(message=="highlight"){shape_attr_to_apply=this.shape_highlight_attr;text_attr_to_apply=this.text_highlight_attr}else{if(message=="dim"){shape_attr_to_apply=this.shape_dim_attr;text_attr_to_apply=this.text_dim_attr}}}if(this.open==false){shape_attr_to_apply.stroke="#070"}else{shape_attr_to_apply.stroke=this.base_node_color}if(renderer_context.use_animation){this._shape.animate.call(this._shape,shape_attr_to_apply,renderer_context.animation_time);this._shape.animate.call(this._text,text_attr_to_apply,renderer_context.animation_time)}else{this._shape.attr(shape_attr_to_apply);this._text.attr(text_attr_to_apply)}};graph_connection=function(context,obj1,obj2,dist_rep){this.from=obj1;this.to=obj2;this.id=this.from.id+"_id_invariant_"+this.to.id;var path_info=this.get_path_between_info();var path=path_info.path;var cp=path_info.center_point;this.visible=true;var base_edge_color="#030";var base_edge_width="3";var highlight_edge_color="#00f";var highlight_edge_width="5";var invisible_edge_color="#000";var invisible_edge_width="0";this.edge_base_attr={stroke:base_edge_color,"stroke-width":base_edge_width,fill:"none",opacity:1,"fill-opacity":0};this.edge_highlight_attr={stroke:highlight_edge_color,"stroke-width":highlight_edge_width,fill:"none",opacity:1,"fill-opacity":0};this.edge_dim_attr={stroke:base_edge_color,"stroke-width":1,fill:"none",opacity:0.5,"fill-opacity":0};this.edge_invisible_attr={stroke:invisible_edge_color,"stroke-width":invisible_edge_width,fill:"none",opacity:0,"fill-opacity":0};this.text_base_attr={opacity:0,"font-size":10};this.text_highlight_attr={opacity:1,"font-size":10};this.text_dim_attr={opacity:0,"font-size":10};this.text_invisible_attr={opacity:0,"font-size":10};this.text=null;if(dist_rep){this.text=context.text(cp[0],(cp[1]+10),dist_rep);this.text.toBack();this.text.attr(this.text_base_attr)}this.line=context.path(path);this.line.attr(this.edge_base_attr)};graph_connection.prototype.update=function(message){var path_info=this.get_path_between_info();var path=path_info.path;this.line.attr({path:path});var line_attr_to_apply=null;if(this.visible==false){line_attr_to_apply=this.edge_invisible_attr}else{if(message=="highlight"){line_attr_to_apply=this.edge_highlight_attr}else{if(message=="dim"){line_attr_to_apply=this.edge_dim_attr}else{line_attr_to_apply=this.edge_base_attr}}}if(renderer_context.use_animation){this.line.animate.call(this.line,line_attr_to_apply,renderer_context.animation_time)}else{this.line.attr(line_attr_to_apply)}var text_attr_to_apply=null;if(this.text){var cp=path_info.center_point;this.text.attr({x:cp[0],y:(cp[1]+10)});if(this.visible==false){text_attr_to_apply=this.text_invisible_attr}else{if(message=="highlight"){text_attr_to_apply=this.text_highlight_attr}else{if(message=="dim"){text_attr_to_apply=this.text_dim_attr}else{text_attr_to_apply=this.text_base_attr}}}if(renderer_context.use_animation){this.text.animate.call(this.text,text_attr_to_apply,renderer_context.animation_time)}else{this.text.attr(text_attr_to_apply)}}};graph_connection.prototype.get_path_between_info=function(){var bb1=this.from.getBBox();var bb2=this.to.getBBox();var p=[{x:bb1.x+bb1.width/2,y:bb1.y-1},{x:bb1.x+bb1.width/2,y:bb1.y+bb1.height+1},{x:bb1.x-1,y:bb1.y+bb1.height/2},{x:bb1.x+bb1.width+1,y:bb1.y+bb1.height/2},{x:bb2.x-1,y:bb2.y+bb2.height/2},{x:bb2.x-1,y:bb2.y+bb2.height/2},{x:bb2.x-1,y:bb2.y+bb2.height/2},{x:bb2.x-1,y:bb2.y+bb2.height/2}];var d={};var dis=[];for(var i=0;i<4;i++){for(var j=4;j<8;j++){var dx=Math.abs(p[i].x-p[j].x);var dy=Math.abs(p[i].y-p[j].y);if((i==j-4)||(((i!=3&&j!=6)||p[i].x<p[j].x)&&((i!=2&&j!=7)||p[i].x>p[j].x)&&((i!=0&&j!=5)||p[i].y>p[j].y)&&((i!=1&&j!=4)||p[i].y<p[j].y))){dis.push(dx+dy);d[dis[dis.length-1]]=[i,j]}}}var res=null;if(dis.length==0){res=[0,4]}else{res=d[Math.min.apply(Math,dis)]}var x1=p[res[0]].x;var y1=p[res[0]].y;var x2=p[res[1]].x;var y2=p[res[1]].y;return{path:["M",x1.toFixed(3),y1.toFixed(3),"L",x1.toFixed(3),y2.toFixed(3),"L",x2.toFixed(3),y2.toFixed(3)].join(","),center_point:[(x1+x2)/2,(y2)]}};this.display=function(){var layout=this._graph.layout();var elt=document.getElementById(elt_id);var edge_shift=1;var absolute_pull=15;var y_scale=renderer_context.box_height*2;this._render_frame_height=(layout.max_width*y_scale);this._render_internal_height=this._render_frame_height-edge_shift;var x_scale=1;if(elt.clientWidth){this._render_frame_width=elt.clientWidth}else{ll("UFP: Unidentified Failing Platform.")}this._render_internal_width=this._render_frame_width-(1*renderer_context.box_width)-absolute_pull;if(info_box_p){this._render_internal_width=this._render_internal_width*0.8}x_scale=this._render_internal_width/layout.max_distance;ll("internal width: "+this._render_internal_width);ll("frame width: "+this._render_frame_width);var paper=Raphael(elt_id,this._render_frame_width,this._render_frame_height);ll("display: made paper");function get_pnode_from_phynode_id(phynode_id){var ret=null;if(phynode_id_to_index[phynode_id]){ret=phynodes[phynode_id_to_index[phynode_id]]}return ret}function gather_list_from_hash(nid,hash){var retlist=new Array();retlist.push(nid);for(vt in hash[nid]){retlist.push(vt)}return retlist}function get_descendant_node_list(nid){return gather_list_from_hash(nid,layout.parent_distances)}function get_ancestor_node_list(nid){return gather_list_from_hash(nid,layout.child_distances)}function get_associated(phynode_id,index_kept,getter){var retlist=new Array();var node_id=phynode_id_to_node_id[phynode_id];var subtree_node_list=getter(node_id);for(var si=0;si<subtree_node_list.length;si++){var subnode_id=subtree_node_list[si];var sindex=node_id_to_index[subnode_id];var thing=index_kept[sindex];retlist.push(thing)}return retlist}function get_descendant_phynodes(phynode_id){return get_associated(phynode_id,phynodes,get_descendant_node_list)}function get_descendant_texts(phynode_id){return get_associated(phynode_id,texts,get_descendant_node_list)}function get_ancestor_phynodes(phynode_id){return get_associated(phynode_id,phynodes,get_ancestor_node_list)}function get_connections(phynode_id,phynode_getter,conn_hash){var retlist=new Array();var tmp_phynodes=phynode_getter(phynode_id);for(var si=0;si<tmp_phynodes.length;si++){var tshp=tmp_phynodes[si];var tnid=phynode_id_to_node_id[tshp.id];if(tnid&&conn_hash[tnid]){for(var anid in conn_hash[tnid]){var conn_index=conn_hash[tnid][anid];var conn=connections[conn_index];ll("get_conn: found: ["+conn_index+"] "+anid+" <=> "+tnid+" ... "+conn);retlist.push(conn)}}}return retlist}function get_ancestor_connections(phynode_id){return get_connections(phynode_id,get_ancestor_phynodes,conn_hash_ancestor)}function get_descendant_connections(phynode_id){return get_connections(phynode_id,get_descendant_phynodes,conn_hash_descendant)}var start=function(){var phynode_id=this.id;var assoc_phynodes=get_descendant_phynodes(phynode_id);for(var si=0;si<assoc_phynodes.length;si++){var phynode=assoc_phynodes[si];phynode.update_position();phynode.update("dim")}var subtree_edges=get_descendant_connections(phynode_id);for(var se=0;se<subtree_edges.length;se++){var ste=subtree_edges[se];ste.update("dim")}};var move=function(dx,dy){var phynode_id=this.id;var assoc_phynodes=get_descendant_phynodes(phynode_id);for(var si=0;si<assoc_phynodes.length;si++){var mshp=assoc_phynodes[si];mshp.move_y(dy)}var dimmable_subtree={};var subtree_edges=get_descendant_connections(phynode_id);for(var se=0;se<subtree_edges.length;se++){var ste=subtree_edges[se];dimmable_subtree[ste.id]=true}for(var i=connections.length;i--;){var conn=connections[i];if(dimmable_subtree[conn.id]){conn.update("dim")}else{conn.update()}}paper.safari()};var stop=function(){var phynode_id=this.id;var assoc_phynodes=get_descendant_phynodes(phynode_id);for(var si=0;si<assoc_phynodes.length;si++){var mshp=assoc_phynodes[si];mshp.update()}for(var i=connections.length;i--;){connections[i].update()}paper.safari()};function dblclick_event_handler(event){var phynode_id=this.id;var pn=get_pnode_from_phynode_id(phynode_id);if(pn.open==true){var subtree_edges=get_descendant_connections(phynode_id);for(var se=0;se<subtree_edges.length;se++){var ste=subtree_edges[se];ste.visible=false;ste.update()}var subtree_nodes=get_descendant_phynodes(phynode_id);for(var sn=0;sn<subtree_nodes.length;sn++){var stn=subtree_nodes[sn];if(stn.id!=phynode_id){stn.visible=false}else{stn.open=false}stn.update()}}else{var subtree_edges=get_descendant_connections(phynode_id);for(var se=0;se<subtree_edges.length;se++){var ste=subtree_edges[se];ste.visible=true;ste.update()}var subtree_nodes=get_descendant_phynodes(phynode_id);for(var sn=0;sn<subtree_nodes.length;sn++){var stn=subtree_nodes[sn];stn.open=true;stn.visible=true;stn.update()}}}function mouseover_event_handler(event){var phynode_id=this.id;var anc_phynodes=get_ancestor_phynodes(phynode_id);for(var ai=0;ai<anc_phynodes.length;ai++){var ashp=anc_phynodes[ai];ashp.update("highlight")}var desc_phynodes=get_descendant_phynodes(phynode_id);for(var di=0;di<desc_phynodes.length;di++){var dshp=desc_phynodes[di];dshp.update("highlight")}var anc_edges=get_ancestor_connections(phynode_id);for(var ac=0;ac<anc_edges.length;ac++){var aconn=anc_edges[ac];aconn.update("highlight")}var desc_edges=get_descendant_connections(phynode_id);for(var dc=0;dc<desc_edges.length;dc++){var dconn=desc_edges[dc];dconn.update("highlight")}paper.safari()}function mouseout_event_handler(event){var phynode_id=this.id;var anc_phynodes=get_ancestor_phynodes(phynode_id);for(var ai=0;ai<anc_phynodes.length;ai++){var ashp=anc_phynodes[ai];ashp.update()}var desc_phynodes=get_descendant_phynodes(phynode_id);for(var di=0;di<desc_phynodes.length;di++){var dshp=desc_phynodes[di];dshp.update()}var anc_edges=get_ancestor_connections(phynode_id);for(var ac=0;ac<anc_edges.length;ac++){var aconn=anc_edges[ac];aconn.update()}var desc_edges=get_descendant_connections(phynode_id);for(var dc=0;dc<desc_edges.length;dc++){var dconn=desc_edges[dc];dconn.update()}paper.safari()}if(info_box_p){var lnodes=layout.cohorts[layout.cohorts.length-1];for(var ln=0;ln<lnodes.length;ln++){var lnode=lnodes[ln];var pr_xa=paper.width-(paper.width*0.2)+20;var pr_ya=1+(y_scale*ln);var bw=(paper.width*0.2)-30;var bh=y_scale-1;var pr=paper.rect(pr_xa,pr_ya,bw,bh,1);pr.attr({fill:"#eeee99","fill-opacity":0.5,opacity:1,stroke:"#333388","stroke-width":1,title:"This is "+lnode.id});var pt=paper.text(pr_xa+(bw/2),pr_ya+(bh/2),"Data for "+lnode.id)}}var phynodes=new Array();var phynode_hash={};var texts=new Array();var phynode_id_to_index={};var phynode_id_to_node_id={};var node_id_to_index={};for(var nidi=0;nidi<layout.node_list.length;nidi++){var node_id=layout.node_list[nidi];var lpx=(layout.position_x[node_id]*x_scale)+edge_shift;var lpy=(layout.position_y[node_id]*y_scale)+edge_shift;var phynode=null;if(!this._graph.is_leaf_node(node_id)&&info_box_p){ll("display: internal node: "+node_id);phynode=new graph_pnode(paper,node_id,lpx,lpy,true)}else{phynode=new graph_pnode(paper,node_id,lpx,lpy)}phynodes.push(phynode);phynode_hash[node_id]=nidi;var ref_index=phynodes.length-1;var phynode_id=phynode.id;phynode_id_to_index[phynode_id]=ref_index;phynode_id_to_node_id[phynode_id]=node_id;node_id_to_index[node_id]=ref_index;ll("display: indexed (node): node_id: "+node_id+", phynode_id: "+phynode_id+", ref_index: "+ref_index)}for(var i=0,ii=phynodes.length;i<ii;i++){phynodes[i].dblclick(dblclick_event_handler);phynodes[i].drag(move,start,stop);phynodes[i].mouseover(mouseover_event_handler);phynodes[i].mouseout(mouseout_event_handler)}var connections=new Array();var conn_hash_ancestor={};var conn_hash_descendant={};for(var ei=0;ei<layout.edge_list.length;ei++){var edge=layout.edge_list[ei];var e0=edge[0];var e1=edge[1];var n0_pnode=phynodes[phynode_hash[e0]];var n1_pnode=phynodes[phynode_hash[e1]];var d_label=layout.parent_distances[e0][e1]+"";var nconn=new graph_connection(paper,n0_pnode,n1_pnode,d_label);connections.push(nconn);if(!conn_hash_descendant[e0]){conn_hash_descendant[e0]={}}conn_hash_descendant[e0][e1]=ei;if(!conn_hash_ancestor[e1]){conn_hash_ancestor[e1]={}}conn_hash_ancestor[e1][e0]=ei;ll("display: indexed (edge): e0: "+e0+", e1: "+e1+", ei: "+ei)}}};if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}if(typeof bbop.widget.phylo_tree=="undefined"){bbop.widget.phylo_tree={}}(function(){bbop.widget.phylo_tree.renderer=renderer;var id_counter=0;function renderer(parent,config){this.parent=(("string"==typeof parent)?document.getElementById(parent):parent);if(this.parent===undefined){throw"can't find parent element "+parent}this.tree=new tree();this.node_hidden={};this.children_hidden={};this._sort="ladderize_up";this._layout_dirty=true;this._css_prefix="phylo_tree_"+(id_counter++)+"_";var self=this;this.node_elem_click_handler=function(event){var node_elem=(event.currentTarget)?event.currentTarget:event.srcElement;var node=self.tree.nodes[node_elem.node_id];if(node){return self.node_clicked(node,node_elem,event)}};var default_config={box_height:24,box_spacing:10,leaf_padding:4,leaf_border:2,leaf_margin:1,node_size:8,leaf_border_color:"blue",leaf_font:"Helvetica, Arial, sans-serif",transition_time:"0.8s"};this.config=("object"==typeof config?bbop.core.merge(default_config,config):default_config);this.config.parent_padding=((this.config.parent_padding===undefined)?((this.config.box_spacing/2)|0):this.config.parent_padding);this.node_style={position:"absolute",background:"white","z-index":2,width:this.config.node_size+"px",height:this.config.node_size+"px","margin-top":(-this.config.node_size/2)+"px","margin-left":(-this.config.node_size/2)+"px",border:"1px solid black","transition-property":"top, left","transition-duration":this.config.transition_time,"transition-timing-function":"ease-in-out, ease-in-out","box-sizing":"content-box","-moz-box-sizing":"content-box"};this.leaf_style={position:"absolute",background:"#f1f1ff","z-index":1,padding:this.config.leaf_padding+"px","padding-left":Math.max(this.config.leaf_padding,3)+"px","margin-left":this.config.leaf_margin+"px","margin-top":(-this.config.box_height/2)+"px",font:((this.config.box_height-(this.config.leaf_padding*2)-(this.config.leaf_border*2))/0.7)+"px "+this.config.leaf_font,height:(this.config.box_height-(this.config.leaf_padding*2)-(this.config.leaf_border*2))+"px","line-height":"0.7em","border-radius":(this.config.leaf_padding+1)+"px","white-space":"nowrap","transition-property":"top, left","transition-duration":this.config.transition_time,"transition-timing-function":"ease-in-out, ease-in-out","box-sizing":"content-box","-moz-box-sizing":"content-box"};if(this.config.leaf_border>0){this.leaf_style.border=this.config.leaf_border+"px solid "+this.config.leaf_border_color}this.connection_style={position:"absolute","border-left":"2px solid black","border-top":"2px solid black","border-bottom":"2px solid black","border-right":"none","transition-property":"top, height, left, width, border","transition-duration":this.config.transition_time,"transition-timing-function":"ease-in-out, ease-in-out, ease-in-out, ease-in-out, step-start"}}renderer.prototype.subtree_hidden=function(node_id){return this.children_hidden[node_id]};renderer.prototype.set_styles=function(css_string){if(!this._style_node){head=document.getElementsByTagName("head")[0],this._style_node=document.createElement("style");this._style_node.type="text/css";head.appendChild(this._style_node)}if(this._style_node.styleSheet){this._style_node.styleSheet.cssText=css_string}else{while(this._style_node.firstChild){this._style_node.removeChild(this._style_node.firstChild)}this._style_node.appendChild(document.createTextNode(css_string))}};renderer.prototype.add_node=function(unique_id,label,meta){this.tree.add_node(unique_id,label,meta);this._layout_dirty=true};renderer.prototype.add_edge=function(nid1,nid2,dist){this.tree.add_edge(nid1,nid2,dist);this._layout_dirty=true};renderer.prototype.display=function(){if(this.container){this.parent.removeChild(this.container)}this.container=document.createElement("div");this.container.style.cssText=["position: absolute","top: 0px","left: "+((this.config.node_size/2)+this.config.parent_padding)+"px","margin: 0px","padding: 0px","transition-property: width, height","transition-duration: "+this.config.transition_time,"transition-timing-function: ease-in-out"].join(";")+";";var node_class=this._css_prefix+"node";var leaf_class=this._css_prefix+"leaf";var conn_class=this._css_prefix+"conn";this.set_styles(["div."+node_class+" {"+css_string(this.node_style)+"}","div."+leaf_class+" {"+css_string(this.leaf_style)+"}","div."+conn_class+" {"+css_string(this.connection_style)+"}"].join("\n"));var phynodes={};for(var node_id in this.tree.nodes){var node=this.tree.nodes[node_id];var phynode=new graph_pnode(node,node_class,leaf_class,this.config.box_height);this.container.appendChild(phynode.node_elem);phynode.node_elem.onclick=this.node_elem_click_handler;phynodes[node.id]=phynode}this._phynodes=phynodes;var container=this.container;var self=this;this.tree.iterate_edges(function(parent,child){if(self.node_hidden[child.id]){return}var child_phynode=phynodes[child.id];child_phynode.set_parent(phynodes[parent.id],conn_class);container.appendChild(child_phynode.conn_elem)});this.position_nodes();this.parent.appendChild(this.container);this.width_changed(this.parent.clientWidth)};renderer.prototype.position_nodes=function(){var x_scale=100/this.max_distance();var row_height=this.config.box_height+this.config.box_spacing;var top_margin=((this.config.box_height/2)+this.config.parent_padding);var layout=this.layout();var self=this;this.tree.iterate_preorder(function(node){var node_pos=layout[node.id];var x=(node_pos.x*x_scale);var y=(node_pos.y*row_height)+top_margin;self._phynodes[node_pos.id].set_position(x,y);if(self.subtree_hidden(node.id)){return true}});this.tree_height=((this.leaves().length*row_height)-this.config.box_spacing+(this.config.parent_padding*2));this.parent.style.transition="height "+this.config.transition_time+" ease-in-out";this.parent.style.height=this.tree_height+"px";this.container.style.height=this.tree_height+"px"};renderer.prototype.max_distance=function(){if(this._layout_dirty){this._update_layout()}return this._max_distance};renderer.prototype.leaves=function(){if(this._layout_dirty){this._update_layout()}return this._leaves};renderer.prototype.layout=function(){if(this._layout_dirty){this._update_layout()}return this._layout};renderer.prototype._update_layout=function(){this._do_sort(this._sort);var self=this;var visible_leaves=[];this.tree.iterate_preorder(function(node){if(self.node_hidden[node.id]){return}if(node.is_leaf()||self.children_hidden[node.id]){visible_leaves.push(node)}});this._leaves=visible_leaves;var roots=this.tree.roots();var root_distances=[];for(var i=0;i<roots.length;i++){root_distances.push(roots[i].parent_distance)}this.x_offset=-min(root_distances);this._max_distance=max(this.tree.traverse(function(node,down_data){return down_data+node.parent_distance},this.x_offset,function(node,child_results,down_data){if(self.node_hidden[node.id]){return 0}return Math.max(down_data,max(child_results))}));this._layout=this._do_layout();this._layout_dirty=false};renderer.prototype._do_layout=function(){var leaf_counter=0;var self=this;var layout_list=Array.prototype.concat.apply([],this.tree.traverse(function(node,down_data){return down_data+node.parent_distance},this.x_offset,function(node,child_results,down_data){if(self.node_hidden[node.id]){return[]}if(!(node.id in self.children_hidden)){var immediate_child_y_sum=0;for(var i=0;i<child_results.length;i++){immediate_child_y_sum+=child_results[i][0].y}}var my_pos=[{id:node.id,x:down_data,y:((node.is_leaf()||self.children_hidden[node.id])?leaf_counter++:(immediate_child_y_sum/child_results.length))}];return Array.prototype.concat.apply(my_pos,child_results)}));var layout_hash={};for(var i=0;i<layout_list.length;i++){layout_hash[layout_list[i].id]=layout_list[i]}return layout_hash};renderer.prototype.width_changed=function(parent_width){var leaves=this.leaves();var avail_width=(parent_width-(this.config.node_size/2)-(this.config.parent_padding*2)-this.config.leaf_margin);var min_width=Number.MAX_VALUE;for(var li=0;li<leaves.length;li++){var leaf_id=leaves[li].id;var phynode=this._phynodes[leaf_id];var potential_width=(avail_width-phynode.width())/(phynode.px/100);min_width=Math.min(min_width,potential_width)}this.container.style.width=Math.max(0,min_width|0)+"px"};renderer.prototype.hide_subtree=function(node_id){var to_hide_under=this.tree.nodes[node_id];if(to_hide_under===undefined){throw"asked to hide non-existent node "+node_id}if(to_hide_under.is_leaf()){return}var self=this;to_hide_under.iterate_preorder(function(node){if(node===to_hide_under){return}self.node_hidden[node.id]=true;self._phynodes[node.id].hide()});self.children_hidden[to_hide_under.id]=true;self._phynodes[to_hide_under.id].set_children_hidden();this._layout_dirty=true;this.position_nodes();this.width_changed(this.parent.clientWidth)};renderer.prototype.show_subtree=function(node_id){var to_show_under=this.tree.nodes[node_id];if(to_show_under===undefined){throw"asked to show non-existent node "+node_id}var self=this;delete self.children_hidden[to_show_under.id];to_show_under.iterate_preorder(function(node){if(node===to_show_under){return}delete self.node_hidden[node.id];self._phynodes[node.id].show();if(self.children_hidden[node.id]){return true}});self._phynodes[to_show_under.id].set_children_visible();this._layout_dirty=true;this.position_nodes();this.width_changed(this.parent.clientWidth)};renderer.prototype.show_only_subtree=function(node_id){var to_show=this.tree.nodes[node_id];if(to_show===undefined){throw"asked to show non-existent node "+node_id}var self=this;this.tree.iterate_preorder(function(node){if(node===to_show){return true}self.node_hidden[node.id]=true;self._phynodes[node.id].hide()});this.tree.set_roots([to_show.id]);this._phynodes[node_id].hide_connector();this._layout_dirty=true;this.position_nodes();this.width_changed(this.parent.clientWidth)};renderer.prototype.only_subtree_shown=function(node_id){var node=this.tree.nodes[node_id];return contains(this.tree.roots(),node)&&node.has_parent()};renderer.prototype.show_global_root=function(){this.tree.clear_roots();var self=this;this.tree.iterate_preorder(function(node){delete self.node_hidden[node.id];var phynode=self._phynodes[node.id];phynode.show();if(!phynode.connector_shown){phynode.show_connector()}if(self.children_hidden[node.id]){return true}});this._layout_dirty=true;this.position_nodes();this.width_changed(this.parent.clientWidth)};renderer.prototype.node_clicked=function(){};renderer.prototype.set_sort=function(sort){if(sort==this._sort){return}this._sort=sort;this._layout_dirty=true};renderer.prototype._do_sort=function(sort){var leaf_counts={};this.tree.traverse(function(){},null,function(node,child_results,down_data){var leaf_count=node.is_leaf()?1:sum(child_results);leaf_counts[node.id]=leaf_count;return leaf_count});var available_sorts={ladderize_up:function(a,b){return leaf_counts[b.id]-leaf_counts[a.id]},ladderize_down:function(a,b){return leaf_counts[a.id]-leaf_counts[b.id]},alphabetical:function(a,b){if(a.id==b.id){return 0}return(a.id<b.id)?-1:1}};if("string"==typeof sort){if(!sort in available_sorts){throw"unknown sort "+sort}this.tree.sort_children(available_sorts[sort])}else{if("function"==typeof sort){this.tree.sort_children(sort)}}};renderer.prototype.iterate_preorder=function(callback){var self=this;this.tree.iterate_preorder(function(node){if(self.node_hidden[node.id]){return}return callback(node.id,node.label,node.meta,self._phynodes[node.id].node_elem,node.children)})};renderer.prototype.traverse=function(down_fun,down_data,up_aggregator){var self=this;return this.tree.traverse(down_fun,down_data,up_aggregator)};function graph_pnode(node,node_class,leaf_class,height){this.node=node;this.height=height;this.leaf_class=leaf_class;this.connector_shown=false;var node_elem=document.createElement("div");if(node.is_leaf()){node_elem.appendChild(document.createTextNode(node.label));node_elem.className=leaf_class}else{node_elem.title=node.label;node_elem.className=node_class}node_elem.node_id=node.id;this.node_elem=node_elem}graph_pnode.prototype.set_children_hidden=function(){var left_offset=10;this.subtree_box=document.createElement("div");this.subtree_box.className=this.leaf_class;this.subtree_box.style.backgroundColor="#eee";this.subtree_box.style.left=left_offset+"px";this.subtree_box.style.top=((this.height/2)-(this.node_elem.offsetHeight/2))+"px";this.subtree_box.appendChild(document.createTextNode(this.node.label+" ..."));this.subtree_box.node_id=this.node.id;this.node_elem.appendChild(this.subtree_box);this._width=left_offset+this.subtree_box.offsetWidth};graph_pnode.prototype.set_children_visible=function(){this._width=this.node_elem.offsetWidth;this.node_elem.removeChild(this.subtree_box)};graph_pnode.prototype.hide=function(){this.node_elem.style.display="none";if(this.parent){this.conn_elem.style.display="none"}};graph_pnode.prototype.hide_connector=function(){if(this.parent){this.conn_elem.style.display="none"}this.connector_shown=false};graph_pnode.prototype.show=function(){this.node_elem.style.display="";if(this.parent){this.conn_elem.style.display=""}};graph_pnode.prototype.show_connector=function(){if(this.parent){this.conn_elem.style.display=""}this.connector_shown=true};graph_pnode.prototype.set_position=function(x,y){this.px=x;this.py=y;this.node_elem.style.left=x+"%";this.node_elem.style.top=y+"px";if(this.parent&&this.connector_shown){var conn_style="top: "+Math.min(this.parent.py,this.py)+"px;left: "+this.parent.px+"%;width: "+(this.px-this.parent.px)+"%;height: "+Math.abs(this.parent.py-this.py)+"px;";if(this.py<this.parent.py){conn_style+="border-bottom: none;"}else{conn_style+="border-top: none;"}this.conn_elem.style.cssText=conn_style}};graph_pnode.prototype.set_parent=function(parent,conn_class){this.parent=parent;this.conn_elem=document.createElement("div");this.conn_elem.className=conn_class;this.conn_elem.id=parent.node.id+"-"+this.node.id;this.connector_shown=true};graph_pnode.prototype.width=function(){if(!("_width" in this)){this._width=this.node_elem.offsetWidth}return this._width};function tree(){this.nodes={};this._dirty=true}tree.prototype.add_node=function(id,label,meta){this.nodes[id]=new node(id,label,meta);this._dirty=true};tree.prototype.add_edge=function(parent_id,child_id,distance){var parent=this.nodes[parent_id];var child=this.nodes[child_id];if("undefined"==typeof parent){throw"parent node "+parent_id+" not found"}if("undefined"==typeof child){throw"child node "+child_id+" not found"}parent.add_child(child,distance);this._dirty=true};tree.prototype.sort_children=function(compare_fun){var roots=this.roots();roots.sort(compare_fun);for(var i=0;i<roots.length;i++){roots[i].sort_children(compare_fun)}};tree.prototype.iterate_preorder=function(fun){var roots=this.roots();for(var i=0;i<roots.length;i++){roots[i].iterate_preorder(fun)}};tree.prototype.iterate_edges=function(fun){for(var id in this.nodes){var parent=this.nodes[id];for(var i=0;i<parent.children.length;i++){fun(parent,parent.children[i])}}};tree.prototype._summarize=function(){if(this._dirty){this.clear_roots()}this._dirty=false};tree.prototype.roots=function(){if(this._dirty){this._summarize()}return this._roots};tree.prototype.set_roots=function(root_ids){var roots=[];for(var i=0;i<root_ids.length;i++){roots.push(this.nodes[root_ids[i]])}this._roots=roots};tree.prototype.clear_roots=function(){var roots=[];for(var id in this.nodes){var node=this.nodes[id];if(!node.has_parent()){roots.push(node)}}this._roots=roots};tree.prototype.traverse=function(down_fun,down_data,up_aggregator){var roots=this.roots();var results=[];for(var i=0;i<roots.length;i++){results.push(roots[i].traverse(down_fun,down_data,up_aggregator))}return results};function node(id,label,meta){this.id=id;this.label=label;this.meta=meta;this.parent=null;this.parent_distance=0;this.children=[]}node.prototype.add_child=function(child_node,distance){child_node.parent_distance=distance;child_node.parent=this;this.children.push(child_node)};node.prototype.is_leaf=function(){return 0==this.children.length};node.prototype.has_parent=function(){return null!=this.parent};node.prototype.sort_children=function(compare_fun){for(var i=0;i<this.children.length;i++){this.children[i].sort_children(compare_fun)}this.children.sort(compare_fun)};node.prototype.iterate_preorder=function(fun){if(!(true==fun(this))){for(var i=0;i<this.children.length;i++){this.children[i].iterate_preorder(fun)}}};node.prototype.traverse=function(down_fun,down_data,up_aggregator){down_data=down_fun(this,down_data);var child_results=new Array(this.children.length);for(var i=0;i<this.children.length;i++){child_results[i]=this.children[i].traverse(down_fun,down_data,up_aggregator)}return up_aggregator(this,child_results,down_data)};function css_string(css_object){var result="";if("object"==typeof css_object){for(var key in css_object){result+=key+":"+css_object[key]+";"}}return result}function contains(arr,elem){for(var i=0;i<arr.length;i++){if(elem==arr[i]){return true}}return false}function max(list){if(0==list.length){return null}var result=list[0];for(var i=1;i<list.length;i++){if(list[i]>result){result=list[i]}}return result}function min(list){if(0==list.length){return null}var result=list[0];for(var i=1;i<list.length;i++){if(list[i]<result){result=list[i]}}return result}function sum(list){var result=0;for(var i=0;i<list.length;i++){result+=list[i]}return result}})();if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}if(typeof bbop.widget.phylo=="undefined"){bbop.widget.phylo={}}(function(){bbop.widget.phylo.renderer=renderer;function renderer(parent,golr_loc,golr_conf,config){this.parent=parent;var default_config={row_height:18,row_spacing:2,font:"Helvetica, Arial, sans-serif",mat_cell_width:20,mat_cell_border:1,transition_time:"0.8s",header_height:100};this.config=("object"==typeof config?bbop.core.merge(default_config,config):default_config);this.phylo_facet_list=["panther_family_label","phylo_graph_json","score"].join(",");this.ann_facet_list=["id","bioentity","bioentity_label","taxon_label","bioentity_name","annotation_class_list_map","score"].join(",");var golr=new bbop.golr.manager.jquery(golr_loc,golr_conf);golr.set_personality("bbop_bio");golr.add_query_filter("document_category","bioentity",["*"]);this.golr=golr}renderer.prototype.show_family=function(family_id){var self=this;var pgraph;function phyloCallback(response){jQuery(document).ready(function(){if(response.documents().length>0){var pgraph_json=response.documents()[0].phylo_graph_json;pgraph=(JSON.parse(pgraph_json));self.golr.register("search","s",annCallback);self.golr.set_query("panther_family:"+family_id);self.golr.current_fl=self.ann_facet_list;self.golr.set("fl",self.ann_facet_list);self.golr.page(response.total_documents(),0)}else{console.log("no documents received")}})}function annCallback(response){if(response.documents().length>0){self.bioentity_map=self.match_pnodes(pgraph.nodes,response.documents());self.show_pgraph(pgraph)}else{console.log("no documents received")}}this.golr.register("search","s",phyloCallback);this.golr.set_query("panther_family:"+family_id);this.golr.current_fl=this.phylo_facet_list;this.golr.set("fl",this.phylo_facet_list);this.golr.page(1,0)};renderer.prototype.match_pnodes=function(pnodes,bioentities){var bioent_id_map={};var bioents_by_pthr_id={};var bioents_matched=0;for(var b=0;b<bioentities.length;b++){bioent_id_map[bioentities[b].id]=bioentities[b]}for(var n=0;n<pnodes.length;n++){if("annotations" in pnodes[n].meta){var pgraph_bioent_ids=pnodes[n].meta.annotations.split("|");for(var pbi=0;pbi<pgraph_bioent_ids.length;pbi++){if(pgraph_bioent_ids[pbi] in bioent_id_map){bioents_by_pthr_id[pnodes[n].id]=bioent_id_map[pgraph_bioent_ids[pbi]];bioents_matched++}}if(!(pnodes[n].id in bioents_by_pthr_id)){}}else{}}return bioents_by_pthr_id};renderer.prototype.show_pgraph=function(pgraph){var self=this;this.parent=(("string"==typeof this.parent)?document.getElementById(this.parent):this.parent);jQuery(this.parent).empty();var parentPos=getStyle(this.parent,"position");if(!(("absolute"==parentPos)||("relative"==parentPos))){this.parent.style.position="relative"}this.parent_top_border=parseInt(getStyle(this.parent,"border-top-width"));this.parent_bot_border=parseInt(getStyle(this.parent,"border-bottom-width"));this.tree_container=document.createElement("div");this.tree_container.style.position="absolute";this.tree_container.style.top=(this.config.header_height+this.config.mat_cell_border)+"px";this.tree_container.style.left="0px";this.mat_container=document.createElement("div");this.mat_container.style.cssText="position: absolute; top: 0px; bottom: 100%;";var all_go_terms={};var go_term_list=[];var node_go_annots={};for(var nid in this.bioentity_map){var bioent=this.bioentity_map[nid];var annots=JSON.parse(bioent.annotation_class_list_map);node_go_annots[nid]=annots;for(var goterm in annots){var term_desc=all_go_terms[goterm];if(term_desc===undefined){term_desc={count:0,id:goterm,name:annots[goterm]};all_go_terms[goterm]=term_desc;go_term_list.push(term_desc)}term_desc.count+=1}}go_term_list.sort(function(a,b){return b.count-a.count});var mat_width=go_term_list.length*this.config.mat_cell_width;var tree_width=500;this.tree_container.style.width=tree_width+"px";this.mat_container.style.width=mat_width+"px";this.mat_container.style.left=tree_width+"px";this.parent.appendChild(this.tree_container);this.parent.appendChild(this.mat_container);var tree_renderer=new bbop.widget.phylo_tree.renderer(this.tree_container,{box_height:this.config.row_height,box_spacing:this.config.row_spacing,leaf_font:this.config.font,leaf_border:0,leaf_padding:3,node_size:8,transition_time:this.config.transition_time});tree_renderer.leaf_style.background="none";tree_renderer.leaf_style.cursor="pointer";tree_renderer.node_style.cursor="pointer";var nodes=pgraph.nodes;var edges=pgraph.edges;function node_label(node){var bioe=node.id in self.bioentity_map?self.bioentity_map[node.id]:null;var label=node.lbl;if(bioe){var taxon_words=[];if(bioe.taxon_label){taxon_words=bioe.taxon_label.split(/\s+/)}if(taxon_words.length>=2){taxon_words[0]=taxon_words[0].substr(0,1)+"."}label=taxon_words.join(" ")+":"+bioe.bioentity_label}return label}for(var i=0;i<nodes.length;i++){tree_renderer.add_node(nodes[i].id,node_label(nodes[i]),nodes[i].meta)}for(var i=0;i<edges.length;i++){tree_renderer.add_edge(edges[i].sub,edges[i].obj,parseFloat(edges[i].meta.distance))}tree_renderer.set_sort(function(a,b){return parseInt(a.meta.layout_index)-parseInt(b.meta.layout_index)});tree_renderer.node_clicked=function(node,node_elem,event){return self.node_clicked(node,node_elem,event)};var node_colors={};var cur_color=1;tree_renderer.traverse(function(node,down_data){if(node.id in node_colors){down_data=node_colors[node.id]}if("true"==node.meta.duplication_p){var have_grandchildren=false;var nearest_child_dist=Infinity;var nearest_child;for(var i=0;i<node.children.length;i++){if(node.children[i].parent_distance<nearest_child_dist){nearest_child=node.children[i];nearest_child_dist=nearest_child.parent_distance}have_grandchildren=have_grandchildren||(!node.children[i].is_leaf())}if(have_grandchildren){for(var i=0;i<node.children.length;i++){if(node.children[i]===nearest_child){node_colors[node.children[i].id]=down_data}else{node_colors[node.children[i].id]=cur_color++}}}}if(!(node.id in node_colors)){node_colors[node.id]=down_data}return node_colors[node.id]},0,function(){});this.node_colors=node_colors;this.tree_renderer=tree_renderer;this.render_tree();jQuery(this.tree_container).on("click",function(e){if(self.popover_elem===undefined){return}self.popover_elem.popover("destroy");self.popover_elem=undefined});var node_id_list=tree_renderer.leaves().map(function(x){return x.id});var node_id_map={};for(var i=0;i<nodes.length;i++){node_id_map[nodes[i].id]=nodes[i]}function cell_renderer(cell,row,col){var node_go=node_go_annots[row];if((node_go!==undefined)&&(col in node_go)){var cell=document.createElement("div");cell.style.backgroundColor="#555";cell.title=node_label(node_id_map[row])+" - "+all_go_terms[col].name;return cell}return null}var mat_config={cell_width:this.config.mat_cell_width,cell_border:this.config.mat_cell_border,cell_height:this.config.row_height+2,header_height:this.config.header_height,show_headers:true,transition_time:this.config.transition_time};this.mat_renderer=new bbop.widget.matrix.renderer(this.mat_container,node_id_list,go_term_list,cell_renderer,mat_config);var leaf_id_list=tree_renderer.leaves().map(function(x){return x.id});this.mat_renderer.show_rows(leaf_id_list);this.parent.style.transition="height "+this.config.transition_time+" ease-in-out";this.update_heights()};renderer.prototype.toggle_subtree_shown=function(node_id){if(this.tree_renderer.subtree_hidden(node_id)){this.tree_renderer.show_subtree(node_id)}else{this.tree_renderer.hide_subtree(node_id)}this.show_mat_rows_for_tree_leaves()};renderer.prototype.show_global_root=function(node_id){this.tree_renderer.show_global_root();this.show_mat_rows_for_tree_leaves()};renderer.prototype.show_only_subtree=function(node_id){this.tree_renderer.show_only_subtree(node_id);this.show_mat_rows_for_tree_leaves()};renderer.prototype.show_mat_rows_for_tree_leaves=function(){var leaf_id_list=jQuery.map(this.tree_renderer.leaves(),function(x){return x.id});this.mat_renderer.show_rows(leaf_id_list);this.update_heights()};renderer.prototype.update_heights=function(){this.parent.style.height=(this.tree_renderer.tree_height+this.config.header_height+this.config.mat_cell_border+this.parent_top_border+this.parent_bot_border)+"px"};renderer.prototype.node_clicked=function(node,node_elem,event){var buttons=[];var jqElem=jQuery(node_elem);var self=this;if(this.popover_elem!==undefined){this.popover_elem.popover("destroy");if(this.popover_elem[0]===jqElem[0]){this.popover_elem=undefined;return}}this.popover_elem=jqElem;jQuery.Event(event).stopPropagation();var podata=jqElem.data("bs.popover");jqElem.popover({html:true,placement:"auto top",container:"body",title:node.label});var podata=jqElem.data("bs.popover");if(!node.is_leaf()){podata.tip().append("&nbsp;");var hideButton=jQuery("<button type='button' class='btn btn-primary btn-xs'></button>");hideButton.click(function(){jqElem.popover("destroy");self.popover_elem=undefined;self.toggle_subtree_shown(node.id)});hideButton.text(self.tree_renderer.subtree_hidden(node.id)?"Show subtree":"Hide subtree");podata.tip().append(hideButton)}podata.tip().append("&nbsp;");var rootButton=jQuery("<button type='button' class='btn btn-primary btn-xs'></button>");rootButton.click(function(){jqElem.popover("destroy");self.popover_elem=undefined;if(self.tree_renderer.only_subtree_shown(node.id)){self.show_global_root()}else{self.show_only_subtree(node.id)}});rootButton.text(self.tree_renderer.only_subtree_shown(node.id)?"Show global root":"Show only subtree");podata.tip().append(rootButton);podata.tip().append("&nbsp;");jqElem.popover("show")};renderer.prototype.render_tree=function(){this.tree_renderer.display();this.tree_renderer.iterate_preorder(function(id,label,meta,dom_elem,children){if("true"==meta.speciation_p){dom_elem.style.borderRadius="6px"}else{if("true"==meta.duplication_p){var has_children=children.length>0;if(has_children){dom_elem.style.backgroundColor="black"}}}});var color_list=["white","rgb(238, 232, 170)","rgb(255, 182, 193)","rgb(135, 206, 250)","rgb(240, 128, 128)","rgb(152, 251, 152)","rgb(216, 191, 216)","rgb(240, 230, 140)","rgb(224, 255, 255)","rgb(255, 218, 185)","rgb(211, 211, 211)","rgb(255, 250, 205)","rgb(176, 196, 222)","rgb(255, 228, 173)","rgb(175, 238, 238)","rgb(244, 164, 96)","rgb(127, 255, 212)","rgb(245, 222, 179)","rgb(255, 160, 122)","rgb(221, 160, 221)"];var self=this;this.tree_renderer.iterate_preorder(function(id,label,meta,dom_elem,children){var is_leaf=0==children.length;if(is_leaf){dom_elem.style.backgroundColor=color_list[self.node_colors[id]%color_list.length];if(id in self.bioentity_map){dom_elem.style.color="black"}else{dom_elem.style.color="#aaa"}}})};function getStyle(el,styleProp){if(el.currentStyle){var y=el.currentStyle[styleProp]}else{if(window.getComputedStyle){var y=window.getComputedStyle(el,null).getPropertyValue(styleProp)}}return y}})();if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}if(typeof bbop.widget.matrix=="undefined"){bbop.widget.matrix={}}(function(){bbop.widget.matrix.renderer=renderer;var this_id=0;function renderer(parent,row_descriptors,col_descriptors,cell_renderer,config){var default_config={cell_width:null,cell_height:24,cell_border:1,cell_padding:4,cell_font:"Helvetica, Arial, sans-serif",header_height:30,header_font:"Helvetica, Arial, sans-serif",show_headers:true,transition_time:"0.8s"};if("object"==typeof config){this.config=bbop.core.merge(default_config,config)}else{this.config=default_config}this.parent=(("string"==typeof parent)?document.getElementById(parent):parent);if(this.parent===undefined){throw"can't find parent element "+parent}this.offset_size_delta=((this.config.cell_padding*2)+(this.config.cell_border));var cell_font_size=((this.config.cell_height-this.offset_size_delta)/0.7);var header_font_size;if(null==this.config.cell_width){header_font_size=((this.config.header_height-this.offset_size_delta)/0.7)}else{header_font_size=((this.config.cell_width-this.offset_size_delta)/0.7)}var css_prefix="matrix_"+this_id++;var header_class=css_prefix+"_header";var inner_header_class=css_prefix+"_inner";var cell_class=css_prefix+"_cell";this.fixed_width=(null!=this.config.cell_width);this.row_descriptors=row_descriptors;this.col_descriptors=col_descriptors;this.headers=[];this.matrix=[];this.num_cols=col_descriptors.length;this.num_rows=row_descriptors.length;this.rowdesc_map={};this.coldesc_map={};this.rowindex_map=Array(row_descriptors.length);this.colindex_map=Array(col_descriptors.length);this.grid_vert=[];this.grid_horiz=[];var vert_class=css_prefix+"_vert";for(var i=0;i<col_descriptors.length;i++){var gridline=document.createElement("div");gridline.className=vert_class;gridline.style.top="0px";this.parent.appendChild(gridline);this.grid_vert.push(gridline)}this.first_vert_gridline=document.createElement("div");this.first_vert_gridline.className=vert_class;this.first_vert_gridline.style.cssText=["top: 0px;","width: 0px;","left: 0px;","margin-left: 0px;","margin-right: 0px;","padding-left: 0px;","padding-right: 0px;"].join("\n");this.parent.appendChild(this.first_vert_gridline);var horiz_class=css_prefix+"_horiz";for(var i=0;i<row_descriptors.length;i++){var gridline=document.createElement("div");gridline.className=horiz_class;gridline.style.left="0px";gridline.style.top=((this.config.show_headers?this.config.header_height:0)+(i*this.config.cell_height))+"px";this.parent.appendChild(gridline);this.grid_horiz.push(gridline)}this.first_horiz_gridline=document.createElement("div");this.first_horiz_gridline.className=horiz_class;this.first_horiz_gridline.style.cssText=["top: 0px;","height: 0px;","left: 0px;","margin-top: 0px;","margin-bottom: 0px;","padding-top: 0px;","padding-bottom: 0px;"].join("\n");this.parent.appendChild(this.first_horiz_gridline);if(this.config.show_headers){this.header_gridline=document.createElement("div");this.header_gridline.className=horiz_class;this.header_gridline.style.cssText=["top: "+(this.config.header_height-this.config.cell_border)+"px;","height: 0px;","left: 0px;","padding-top: 0px;","padding-bottom: 0px;"].join("\n");this.parent.appendChild(this.header_gridline)}for(var i=0;i<col_descriptors.length;i++){if(this.config.show_headers){var cell=document.createElement("div");cell.className=header_class;cell.style.top="0px";if(null==this.config.cell_width){cell.title=col_descriptors[i].name;cell.appendChild(document.createTextNode(col_descriptors[i].name))}else{var inner=document.createElement("div");inner.className=inner_header_class;inner.title=col_descriptors[i].name;inner.appendChild(document.createTextNode(col_descriptors[i].name));cell.appendChild(inner)}this.parent.appendChild(cell);this.headers.push(cell)}this.colindex_map[i]=i;this.coldesc_map[col_descriptors[i].id]=i}for(var ri=0;ri<row_descriptors.length;ri++){var row=[];for(var ci=0;ci<col_descriptors.length;ci++){var cell=cell_renderer(cell,row_descriptors[ri],col_descriptors[ci].id);if(null!=cell){cell.className+=" "+cell_class;cell.style.top=((this.config.show_headers?this.config.header_height:0)+(ri*this.config.cell_height))+"px";this.parent.appendChild(cell)}row.push(cell)}this.matrix.push(row);this.rowindex_map[ri]=ri;this.rowdesc_map[row_descriptors[ri]]=ri}this.vert_style=["  position: absolute;","  border-right: "+this.config.cell_border+"px solid black;","  padding: "+this.config.cell_padding+"px;","  margin-left: "+this.config.cell_border+"px;","  overflow: hidden;","  z-index: 0;","  box-sizing: content-box;","  -moz-box-sizing: content-box;"].join("\n");this.horiz_style=["  position: absolute;","  border-bottom: "+this.config.cell_border+"px solid black;","  padding: "+this.config.cell_padding+"px;","  height: "+(this.config.cell_height-this.offset_size_delta)+"px;","  margin: 0px;","  margin-top: "+this.config.cell_border+"px;","  z-index: 1;","  overflow: hidden;","  box-sizing: content-box;","  -moz-box-sizing: content-box;"].join("\n");this.cell_style=["  position: absolute;","  white-space: nowrap;","  height: "+(this.config.cell_height-this.offset_size_delta)+"px;","  margin: "+this.config.cell_border+"px;","  padding: "+this.config.cell_padding+"px;","  z-index: 10;","  font: "+cell_font_size+"px "+this.config.cell_font+";","  line-height: 0.7em;","  overflow: hidden;","  box-sizing: content-box;","  -moz-box-sizing: content-box;"].join("\n");this.header_style=["  position: absolute;","  white-space: nowrap;","  height: "+(this.config.header_height-this.offset_size_delta)+"px;","  margin: "+this.config.cell_border+"px;","  padding: "+this.config.cell_padding+"px;","  font: "+header_font_size+"px "+this.config.header_font+";","  line-height: 0.7em;","  overflow: hidden;","  box-sizing: content-box;","  -moz-box-sizing: content-box;"].join("\n");var inner_offset=-(this.config.header_height-header_font_size-this.config.cell_padding);this.inner_header_style=["-webkit-transform: rotate(-90deg) translate("+inner_offset+"px);","transform: rotate(-90deg) translate("+inner_offset+"px);","-ms-transform: rotate(-90deg) translate("+inner_offset+"px);","-o-transform: rotate(-90deg) translate("+inner_offset+"px);","filter: progid:DXImageTransform.Microsoft.BasicImage(rotation=3);"].join("\n");this.transition_style=["  transition-property: top, left;","  transition-duration:"+this.config.transition_time+";","  transition-timing-function: ease-in-out, ease-in-out;"].join("\n");this.set_styles(["div."+header_class+" { ",this.header_style,"}","div."+inner_header_class+" { ",this.inner_header_style,"}","div."+cell_class+" { ",this.cell_style,"}","div."+vert_class+" { ",this.vert_style,"}","div."+horiz_class+" { ",this.horiz_style,"}"].join("\n"));this.update_height();this.width=this.update_widths();this.parent.style.width=this.width+this.config.cell_border+"px";this.set_styles(["div."+header_class+" { ",this.header_style,this.transition_style,"}","div."+inner_header_class+" { ",this.inner_header_style,this.transition_style,"}","div."+cell_class+" { ",this.cell_style,this.transition_style,"}","div."+vert_class+" { ",this.vert_style,this.transition_style,"}","div."+horiz_class+" { ",this.horiz_style,this.transition_style,"}"].join("\n"))}renderer.prototype.update_height=function(){this.height=((this.config.show_headers?this.config.header_height:0)+(this.config.cell_height*this.rowindex_map.length));var grid_height=(this.height-this.offset_size_delta+(2*this.config.cell_border))+"px";for(var ci=0;ci<this.colindex_map.length;ci++){this.grid_vert[this.colindex_map[ci]].style.height=grid_height}this.first_vert_gridline.style.height=grid_height;this.parent.style.height=(this.height+this.config.cell_border)+"px"};renderer.prototype.set_styles=function(css_string){if(!this._style_node){head=document.getElementsByTagName("head")[0],this._style_node=document.createElement("style");this._style_node.type="text/css";head.appendChild(this._style_node)}if(this._style_node.styleSheet){this._style_node.styleSheet.cssText=css_string}else{while(this._style_node.firstChild){this._style_node.removeChild(this._style_node.firstChild)}this._style_node.appendChild(document.createTextNode(css_string))}};renderer.prototype.update_widths=function(){function max_widths(matrix){var widths=[];for(var row=0;row<matrix.length;row++){for(var col=0;col<matrix[row].length;col++){var cell=matrix[row][col];if(cell){cell.style.width="";if(!(col in widths)){widths[col]=0}widths[col]=Math.max(widths[col],cell.offsetWidth)}}}return widths}function set_widths(row,colindex_map,widths,offset_delta){var left=0;for(var col=0;col<colindex_map.length;col++){var cell=row[colindex_map[col]];if(cell){cell.style.width=(widths[colindex_map[col]]-offset_delta)+"px";cell.style.left=left+"px"}left+=widths[col]}}var widths=Array(this.num_cols);var totalWidth=0;if(this.fixed_width){for(var col=0;col<this.num_cols;col++){widths[col]=this.config.cell_width;totalWidth+=widths[col]}}else{var header_widths=max_widths([this.headers]);var matrix_widths=max_widths(this.matrix);for(var col=0;col<this.num_cols;col++){widths[col]=Math.max(header_widths[col]||0,matrix_widths[col]||0);totalWidth+=widths[col]}}if(this.config.show_headers){set_widths(this.headers,this.colindex_map,widths,this.offset_size_delta)}for(var ri=0;ri<this.matrix.length;ri++){set_widths(this.matrix[ri],this.colindex_map,widths,this.offset_size_delta)}set_widths(this.grid_vert,this.colindex_map,widths,this.offset_size_delta);var grid_width=(totalWidth-this.offset_size_delta+(2*this.config.cell_border))+"px";for(var ri=0;ri<this.grid_horiz.length;ri++){this.grid_horiz[ri].style.width=grid_width}this.first_horiz_gridline.style.width=grid_width;if(this.config.show_headers){this.header_gridline.style.width=grid_width}this.widths=widths;return totalWidth};renderer.prototype.show_rows=function(row_list){var new_rowindex_map=Array(row_list.length);var new_row_map={};var displayed_colindices=Array(this.num_cols);for(var dci=0;dci<this.colindex_map.length;dci++){displayed_colindices[this.colindex_map[dci]]=dci}for(var ri=0;ri<row_list.length;ri++){if(row_list[ri] in this.rowdesc_map){var matrix_row_index=this.rowdesc_map[row_list[ri]];var row=this.matrix[matrix_row_index];var row_top=((this.config.show_headers?this.config.header_height:0)+(ri*this.config.cell_height))+"px";var horiz_gridline=this.grid_horiz[matrix_row_index];horiz_gridline.style.top=row_top;horiz_gridline.style.display="";for(var ci=0;ci<this.num_cols;ci++){var cell=row[ci];if(cell){cell.style.top=row_top;var displayed_colindex=displayed_colindices[ci];if(displayed_colindex==undefined){cell.style.display="none"}else{cell.style.display=""}}}new_rowindex_map[ri]=matrix_row_index;new_row_map[row_list[ri]]=1}}this.rowindex_map=new_rowindex_map;for(var i=0;i<this.row_descriptors.length;i++){var rowdesc=this.row_descriptors[i];if(!(rowdesc in new_row_map)){var row_index=this.rowdesc_map[rowdesc];this.grid_horiz[row_index].style.display="none";var row=this.matrix[row_index];for(var j=0;j<row.length;j++){var cell=row[j];if(cell){cell.style.display="none"}}}}this.update_height()};renderer.prototype.show_cols=function(col_list){var new_colindex_map=Array(col_list.length);var new_col_map={};var displayed_rowindices=Array(this.num_rows);for(var dri=0;dri<this.rowindex_map.length;dri++){displayed_rowindices[this.rowindex_map[dri]]=dri}var left=0;for(var ci=0;ci<col_list.length;ci++){matrix_col_index=this.coldesc_map[col_list[ci]];var vert_gridline=this.grid_vert[matrix_col_index];vert_gridline.style.left=left+"px";vert_gridline.style.display="";for(var ri=0;ri<this.num_rows;ri++){var row=this.matrix[ri];var cell=row[matrix_col_index];if(cell){cell.style.left=left+"px";var displayed_rowindex=displayed_rowindices[ri];if(displayed_rowindex==undefined){cell.style.display="none"}else{cell.style.display=""}}}if(this.config.show_headers){this.headers[matrix_col_index].style.left=left+"px";this.headers[matrix_col_index].style.display=""}new_colindex_map[ci]=matrix_col_index;new_col_map[col_list[ci]]=1;left+=this.widths[matrix_col_index]}this.colindex_map=new_colindex_map;for(var i=0;i<this.col_descriptors.length;i++){var coldesc=this.col_descriptors[i];if(!(coldesc.id in new_col_map)){matrix_col_index=this.coldesc_map[coldesc.id];for(var j=0;j<this.matrix.length;j++){var cell=this.matrix[j][matrix_col_index];if(cell){cell.style.display="none"}}this.grid_vert[matrix_col_index].style.display="none";if(this.config.show_headers){this.headers[matrix_col_index].style.display="none"}}}this.width=left;var grid_width=(left-this.offset_size_delta+(2*this.config.cell_border))+"px";for(var ri=0;ri<this.rowindex_map.length;ri++){this.grid_horiz[this.rowindex_map[ri]].style.width=grid_width}this.first_horiz_gridline.style.width=grid_width;if(this.config.show_headers){this.header_gridline.style.width=grid_width}this.parent.style.width=this.width+this.config.cell_border+"px"}})();if(typeof bbop=="undefined"){var bbop={}}if(typeof bbop.widget=="undefined"){bbop.widget={}}bbop.widget.message=function(){this._is_a="bbop.widget.message";var anchor=this;var logger=new bbop.logger();logger.DEBUG=true;function ll(str){logger.kvetch("W (message): "+str)}function _generate_element(ctype,str){var message_classes=["bbop-js-message","bbop-js-message-"+ctype];var message_elt=new bbop.html.tag("div",{generate_id:true,"class":message_classes.join(" ")},"<h2>"+str+"</h2>");jQuery("body").append(jQuery(message_elt.to_string()).hide());var elt=jQuery("#"+message_elt.get_id());return elt}function _destroy_element(){jQuery(this).remove()}this.notice=function(msg){var elt=_generate_element("notice",msg);elt.show().slideDown("slow").slideUp("slow",_destroy_element)};this.warning=function(msg){var elt=_generate_element("warning",msg);elt.show().slideDown("slow").slideUp("slow",_destroy_element)};this.error=function(msg){var elt=_generate_element("error",msg);elt.show().fadeTo(2500,0.9).fadeOut(1000,_destroy_element)}};if(typeof(exports)!="undefined"){exports.bbop=bbop;bbop.core.each(bbop,function(k,v){exports[k]=v})};